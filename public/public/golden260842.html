<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>é‡‘ç¢§è¼ç…Œãƒ»å¤©è±¡é›†æˆ G-4.1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- ä¾è³´åº« -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@latest/astronomy.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            /* å¥¢è¯äº®é‡‘è‰²èª¿ */
            --base-gold: #FDF5E6; /* è±¡ç‰™é‡‘ */
            --royal-gold: #C5A059;
            --bright-gold: #FFD700;
            --text-gold: #8B6B23;
            --panel-gold: rgba(255, 250, 240, 0.95);
            --border-gold: #E2C08D;
            --font-nano: 0.5rem; /* åš´æ ¼æ§åˆ¶åœ¨ 0.5rem */
            --shadow-gold: 0 4px 15px rgba(197, 160, 89, 0.2);
            --gold-gradient: linear-gradient(135deg, #D4AF37 0%, #FCF6BA 20%, #D4AF37 40%, #FBF5B7 60%, #AA771C 80%, #FCF6BA 100%);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }

        body {
            font-family: 'PingFang TC', 'Noto Sans TC', sans-serif;
            background-color: var(--base-gold);
            background-image: 
                radial-gradient(circle at 10% 10%, rgba(255, 223, 0, 0.1) 0%, transparent 30%),
                radial-gradient(circle at 90% 90%, rgba(255, 223, 0, 0.1) 0%, transparent 30%),
                url('https://www.transparenttextures.com/patterns/gold-dust.png');
            color: var(--text-gold);
            font-size: var(--font-nano);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* é ‚éƒ¨å°è¦½ */
        .header-bar {
            height: 60px; background: var(--gold-gradient);
            background-size: 400% 400%; animation: goldFlow 15s ease infinite;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; border-bottom: 2px solid var(--royal-gold);
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        @keyframes goldFlow { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

        .header-title { font-size: 0.6rem; font-weight: 900; color: #5D4037; letter-spacing: 1px; }

        .btn-action {
            background: #FFF; border: 1.2px solid var(--royal-gold);
            color: var(--text-gold); font-size: 0.4rem; font-weight: bold;
            padding: 6px 12px; border-radius: 20px; cursor: pointer; transition: 0.3s;
        }
        .btn-action:hover { background: var(--royal-gold); color: #FFF; }

        /* åˆ†é åˆ‡æ› */
        .tab-nav {
            display: flex; background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px); border-bottom: 1px solid var(--border-gold);
            position: sticky; top: 60px; z-index: 999;
        }
        .tab-btn {
            flex: 1; text-align: center; padding: 15px 0;
            font-size: var(--font-nano); font-weight: bold; color: #A68B5A; cursor: pointer;
        }
        .tab-btn.active {
            color: #5D4037; background: rgba(255, 215, 0, 0.15);
            border-bottom: 4px solid var(--royal-gold);
        }

        /* é é¢å®¹å™¨ */
        .page-content { display: none; padding: 15px; animation: fadeIn 0.4s ease; max-width: 100vw; }
        .page-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* é¢æ¿ */
        .gold-card {
            background: var(--panel-gold); border: 1px solid var(--border-gold);
            border-radius: 12px; padding: 15px; margin-bottom: 15px;
            box-shadow: var(--shadow-gold); position: relative;
            word-wrap: break-word;
        }
        .card-title {
            font-size: 0.55rem; font-weight: 900; margin-bottom: 12px;
            color: #5D4037; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px dashed var(--border-gold); padding-bottom: 8px;
        }

        /* å·¥å…· */
        textarea {
            width: 100%; height: 200px; background: #FFFDF0;
            border: 1.5px solid var(--border-gold); border-radius: 8px;
            padding: 12px; font-size: 0.5rem; color: #5D4037; line-height: 1.6;
            resize: none; outline: none; transition: 0.3s;
        }
        textarea:focus { border-color: var(--bright-gold); background: #FFF; }

        .btn-main {
            width: 100%; margin-top: 15px; padding: 18px;
            background: var(--gold-gradient); border: none; border-radius: 8px;
            color: #4E342E; font-weight: 900; font-size: 0.6rem;
            cursor: pointer; box-shadow: 0 4px 0 #A67C00;
        }
        .btn-main:active { transform: translateY(2px); box-shadow: none; }

        .btn-clear {
            background: #F8F0E0; border: 1px solid #D2B48C; color: #8B4513;
            padding: 5px 10px; border-radius: 4px; font-size: 0.4rem; cursor: pointer;
        }

        /* ç‹€æ…‹ç¶²æ ¼ */
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .stat-box {
            background: #FFF; border: 1px solid var(--border-gold);
            padding: 12px; border-radius: 8px; text-align: center;
        }
        .stat-label { font-size: 0.4rem; color: #998C71; }
        .stat-val { font-size: 0.5rem; font-weight: bold; color: var(--text-gold); }

        /* é€šçŸ¥èˆ‡åŠ è¼‰ */
        #toast-container {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            z-index: 3000; width: 90%; max-width: 400px; pointer-events: none;
        }
        .toast {
            background: rgba(255, 255, 255, 0.95); border: 2px solid var(--royal-gold);
            padding: 12px; border-radius: 25px; font-size: 0.5rem;
            font-weight: bold; color: #5D4037; box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-top: 10px; text-align: center; animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        #loading-screen {
            position: fixed; inset: 0; background: rgba(253, 245, 230, 0.95);
            z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #F3F3F3;
            border-top: 5px solid var(--royal-gold); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* è¦–è¦ºå°å‡ºç¯„æœ¬ */
        #offscreen-tpl { position: absolute; left: -9999px; }
        .report-tpl {
            width: 800px; padding: 60px; background: #FFF9E6;
            border: 25px solid var(--royal-gold); color: #5D4037; position: relative;
        }
        .report-tpl::after { content: ""; position: absolute; inset: 15px; border: 2px solid var(--royal-gold); pointer-events: none; }
    </style>
</head>
<body>

<div id="loading-screen">
    <div class="spinner"></div>
    <div style="margin-top:20px; font-weight:900; color:var(--text-gold); font-size:0.6rem;">âœ¨ é‡‘å…‰æ¼”ç®—æ ¸ç®—ä¸­...</div>
</div>

<div id="toast-container"></div>

<header class="header-bar">
    <div class="header-title">G-CORE 4.1 GOLDEN</div>
    <button class="btn-action" onclick="downloadSource()">ğŸ’¾ ä¸‹è¼‰ä»£ç¢¼</button>
</header>

<nav class="tab-nav">
    <div class="tab-btn active" onclick="switchPage(0)">æ•¸æ“šè¼‰å…¥</div>
    <div class="tab-btn" onclick="switchPage(1)">æ ¸ç®—è§£æ</div>
    <div class="tab-btn" onclick="switchPage(2)">é‡‘å…‰å ±å‘Š</div>
</nav>

<!-- Page 0: Input -->
<main id="p0" class="page-content active">
    <div class="gold-card">
        <div class="card-title">
            <span>âšœï¸ å¤©è±¡è§€æ¸¬æ•¸æ“šè¼‰å…¥</span>
            <button class="btn-clear" onclick="clearInput()">ğŸ§¹ æ¸…é™¤</button>
        </div>
        <textarea id="main-input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥è§€æ¸¬æ•¸æ“šæˆ–å¾ç³»çµ±ç²å–..."></textarea>
        <button class="btn-main" onclick="executeCompute()">å•Ÿå‹•é‡‘ç¢§è¼ç…Œæ¼”ç®—</button>
    </div>
    <div class="stat-grid">
        <div class="stat-box"><div class="stat-label">ç³»çµ±æµæ°´ç¢¼</div><div id="sn-id" class="stat-val">---</div></div>
        <div class="stat-box"><div class="stat-label">ç•¶å‰æ¬Šé™</div><div class="stat-val">VIP GOLDEN</div></div>
    </div>
</main>

<!-- Page 1: Report -->
<main id="p1" class="page-content">
    <div id="report-view">
        <div style="text-align:center; padding:100px; color:var(--royal-gold); font-weight:bold;">ç­‰å¾…æ•¸æ“šæ¼”åŒ–æŒ‡ä»¤...</div>
    </div>
</main>

<!-- Page 2: Visuals -->
<main id="p2" class="page-content">
    <div id="visual-view" style="display:flex; flex-direction:column; gap:20px; align-items:center;">
        <div style="text-align:center; padding:100px; color:var(--royal-gold); font-weight:bold;">è¦–è¦ºæ¨¡çµ„å¾…å‘½ä¸­...</div>
    </div>
    <div id="export-tools" style="display:none; text-align:center; padding-top:20px; width:100%;">
        <button class="btn-main" onclick="exportGoldenImages()">ğŸ“¥ æ‰¹é‡å°å‡ºé‡‘ç¢§è¼ç…Œå ±å‘Šåœ–</button>
    </div>
</main>

<!-- é›¢å±æ¸²æŸ“ç¯„æœ¬ -->
<div id="offscreen-tpl">
    <div id="tpl-main" class="report-tpl">
        <h1 id="tpl-h" style="font-size:48px; border-bottom:4px solid var(--royal-gold); padding-bottom:15px; font-weight:900;"></h1>
        <div id="tpl-b" style="font-size:28px; line-height:1.8; margin-top:40px; white-space:pre-wrap; text-align:justify; color:#3E2723;"></div>
        <div style="margin-top:80px; text-align:right; font-weight:900; color:var(--royal-gold); font-size:24px;">G-CORE 4.1 GOLD MASTER EDITION</div>
    </div>
</div>

<script>
/**
 * æ ¸å¿ƒåƒæ•¸èˆ‡å¯†é‘°ç®¡ç†
 */
const apiKey = ""; // <--- å¤–éƒ¨åŸ·è¡Œè«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ API Key
const SN_CODE = "G4-" + Date.now().toString(36).toUpperCase();
const DICT_URL = "https://raw.githubusercontent.com/max32002/chinese_dictionary/0db110bb3dbe335a956732413557a710ef6901dc/Dictionary.json";
const ASTRO_URL = "https://raw.githubusercontent.com/orlandotigereye/Analy13/refs/heads/main/astrology_merged.json";

// é è¨­ç¯„æœ¬æ•¸æ“š
const PRESET_DATA = `æœˆâ†’æœ€è¿‘è¡Œæ˜Ÿ: Saturn | å¤ªé™½: 69.2Â° | æ°´æ˜Ÿ (è¾°æ˜Ÿ): 85.3Â° | é‡‘æ˜Ÿ (å¤ªç™½): 72.2Â° | ç«æ˜Ÿ (ç†’æƒ‘): 65.2Â° | æœ¨æ˜Ÿ (æ­²æ˜Ÿ): 230.3Â° | åœŸæ˜Ÿ (é®æ˜Ÿ): 13.0Â°
ğŸŒ“ æœˆç›¸ï¼šä¸Šå¼¦
ä¹™å·³ æˆŠå­æœˆ å·±å·³æ—¥ å·±å·³æ™‚
å°å¯’ï¼ˆè·é›¢ 10 å¤©ï¼‰
ğŸŒ  å®¿æ›œï¼šç¿¼ç«è›‡ (ç«)
ç¿¼ç«è›‡:å®ˆ | è»«æœ¨èŸ¹:çŠ¯
äº”è¡Œåˆæˆèƒ½é‡: æœ¨:23 ç«:38 åœŸ:25 é‡‘:20 æ°´:35
ç¤¾æœƒæ°£é‹ï¼š63
ç’°å¢ƒï¼šå°ä¸­å¸‚åé‡Œå€ | é›²é‡: 98% | é¢¨é€Ÿ: 37.5 km/h | é™°å¤©`;

let coreData = null;

$(document).ready(() => {
    $('#main-input').val(PRESET_DATA);
    $('#sn-id').text(SN_CODE);
    sendMsg("âœ¨ é‡‘ç¢§è¼ç…Œç³»çµ±åˆå§‹åŒ–å®Œæˆ");
});

function switchPage(idx) {
    $('.page-content').removeClass('active');
    $(`#p${idx}`).addClass('active');
    $('.tab-btn').removeClass('active').eq(idx).addClass('active');
}

function sendMsg(t) {
    const e = $(`<div class="toast">${t}</div>`);
    $('#toast-container').append(e);
    setTimeout(() => e.fadeOut(() => e.remove()), 4000);
}

function clearInput() {
    $('#main-input').val('');
    sendMsg("ğŸ§¹ è¼¸å…¥ç•«é¢å·²æ¸…é™¤");
}

/**
 * æ¼”ç®—å¼•æ“ (Gemini API æ•´åˆ)
 */
async function executeCompute() {
    const raw = $('#main-input').val().trim();
    if(!raw) return sendMsg("âš ï¸ è«‹å…ˆè¼¸å…¥è§€æ¸¬æ•¸æ“š");
    if(!apiKey) return sendMsg("âŒ éŒ¯èª¤ï¼šæœªåµæ¸¬åˆ° API Key (403 Forbidden)");

    $('#loading-screen').css('display', 'flex');

    const promptSystem = `ä½ æ˜¯ä¸€ä½ç²¾é€šäº”è¡Œã€å®¿æ›œèˆ‡æ˜Ÿè±¡åˆ†æçš„ã€Œé‡‘ç‰Œé¦–å¸­åˆ†æå¸«ã€ã€‚
è«‹åŸºæ–¼è¼¸å…¥æ•¸æ“šæ’°å¯«ä¸‰ç¯‡å…§å®¹æ¥µå…¶è©³å¯¦ï¼ˆæ¯ç¯‡ç´„ 500 å­—ï¼‰ã€èªæ°£é«˜é›…ä¸”å¯Œæœ‰æ¬Šå¨æ„Ÿçš„åˆ†æã€‚
1. [é‡‘é—•äº”è¡Œå±€]ï¼šæ·±åº¦è§£è®€äº”è¡Œèƒ½é‡èˆ‡ç•¶å‰ç¤¾æœƒæ°£é‹çš„æµå‹•è„ˆçµ¡ã€‚
2. [å®¿æ›œä¹¾å¤å®š]ï¼šé‡å°å®¿æ›œçŠ¯å®ˆçµ¦å‡ºç­–ç•¥ç´šåˆ¤è®€ã€‚
3. [æ™‚ç©ºé¿å‡¶ç­–]ï¼šæä¾›åŸºæ–¼ç•¶å‰å¤©è±¡çš„æœ€å„ªè¡Œå‹•èˆ‡æ±ºç­–å»ºè­°ã€‚
è¦æ±‚ï¼šæ–‡é¢¨é‡‘ç¢§è¼ç…Œã€å°ˆæ¥­åš´è¬¹ã€‚å›å‚³ JSON æ ¼å¼ã€‚`;

    const promptUser = `è¼¸å…¥æ•¸æ“šï¼š\n${raw}\n\nå›å‚³ JSON çµæ§‹ï¼š
    {
      "summary": "ä¸€å¥è©±å®šèª¿ç•¶å‰å±€å‹¢",
      "articles": [
        {"title": "é‡‘é—•äº”è¡Œå±€", "body": "..."},
        {"title": "å®¿æ›œä¹¾å¤å®š", "body": "..."},
        {"title": "æ™‚ç©ºé¿å‡¶ç­–", "body": "..."}
      ]
    }`;

    try {
        const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{ parts: [{ text: promptUser }] }],
                systemInstruction: { parts: [{ text: promptSystem }] },
                generationConfig: { responseMimeType: "application/json" }
            })
        });

        const resJson = await response.json();
        const textResult = resJson.candidates?.[0]?.content?.parts?.[0]?.text;
        if(!textResult) throw new Error("API æœªå‚³å›æœ‰æ•ˆå…§å®¹");

        coreData = JSON.parse(textResult);

        renderUI();
        switchPage(1);
        sendMsg("âœ… é‡‘å…‰æ ¸ç®—å®Œæˆï¼Œå ±å‘Šå·²æ›´æ–°");
    } catch (e) {
        sendMsg("âŒ æ¼”ç®—ä¸­æ–·ï¼š" + e.message);
    } finally {
        $('#loading-screen').hide();
    }
}

/**
 * ç•Œé¢æ¸²æŸ“
 */
function renderUI() {
    let html = `<div class="gold-card"><div class="card-title">âšœï¸ å±€å‹¢å®šèª¿</div><div style="font-size:0.55rem; font-weight:900; color:var(--text-gold)">${coreData.summary}</div></div>`;
    coreData.articles.forEach(art => {
        html += `
            <div class="gold-card">
                <div class="card-title">ğŸ“œ ${art.title}</div>
                <div style="white-space:pre-wrap; text-align:justify; color:#5D4037; line-height:1.8; font-size:0.5rem;">${art.body}</div>
            </div>
        `;
    });
    $('#report-view').html(html);
    prepareVisuals();
}

/**
 * è¦–è¦ºé è¦½åˆæˆ
 */
async function prepareVisuals() {
    $('#visual-view').empty();
    $('#export-tools').hide();

    for(let i=0; i < coreData.articles.length; i++) {
        const card = $(`
            <div class="gold-card" style="width:100%; max-width:450px;">
                <div class="card-title">ğŸ–¼ï¸ å ±å‘Šé è¦½ï¼š${coreData.articles[i].title}</div>
                <div id="preview-box-${i}" style="min-height:250px; background:#FFF; border:2px solid #E2C08D; display:flex; align-items:center; justify-content:center; overflow:hidden; border-radius:8px;">
                    <div style="font-size:0.4rem; color:var(--royal-gold)">è¦–è¦ºæ¨¡çµ„ç”Ÿæˆä¸­...</div>
                </div>
            </div>
        `);
        $('#visual-view').append(card);

        // ä½¿ç”¨é›¢å±ç¯„æœ¬æ¸²æŸ“
        $('#tpl-h').text(coreData.articles[i].title);
        $('#tpl-b').text(coreData.articles[i].body.substring(0, 300) + "...");
        
        try {
            const canvas = await html2canvas(document.getElementById('tpl-main'), { 
                scale: 0.5,
                useCORS: true,
                backgroundColor: "#FFF9E6"
            });
            $(`#preview-box-${i}`).empty().append(canvas);
            $(canvas).css('width', '100%').css('height', 'auto');
        } catch(err) {
            $(`#preview-box-${i}`).html("æ¸²æŸ“å¤±æ•—");
        }
    }
    $('#export-tools').show();
}

/**
 * æ‰¹é‡å°å‡ºå ±å‘Šåœ–
 */
async function exportGoldenImages() {
    $('#loading-screen').css('display', 'flex');
    sendMsg("ğŸ“¸ æ­£åœ¨å•Ÿå‹•é«˜æ¸…æ¸²æŸ“...");
    
    for(let i=0; i < coreData.articles.length; i++) {
        $('#tpl-h').text(coreData.articles[i].title);
        $('#tpl-b').text(coreData.articles[i].body);
        
        try {
            const canv = await html2canvas(document.getElementById('tpl-main'), { 
                scale: 2, 
                useCORS: true,
                backgroundColor: "#FFF9E6"
            });
            const link = document.createElement('a');
            link.download = `GCORE_GOLD_P${i+1}_${SN_CODE}.png`;
            link.href = canv.toDataURL("image/png");
            link.click();
            await new Promise(r => setTimeout(r, 1000));
        } catch(err) {
            sendMsg(`âŒ å°å‡ºç¬¬ ${i+1} é å¤±æ•—`);
        }
    }
    $('#loading-screen').hide();
    sendMsg("ğŸ† å…¨å¥—é‡‘å…‰å ±å‘Šåœ–å·²æ‰¹é‡å°å‡º");
}

/**
 * API é‡è©¦æ©Ÿåˆ¶
 */
async function fetchWithRetry(url, opt, retries = 5, delay = 1000) {
    try {
        const res = await fetch(url, opt);
        if (!res.ok) {
            if (res.status === 403) throw new Error("API Key ç„¡æ•ˆæˆ–æ¬Šé™é­æ‹’ (403)");
            if (res.status === 429) throw new Error("è«‹æ±‚éæ–¼é »ç¹ (429)");
            throw new Error("API è«‹æ±‚éŒ¯èª¤ Status: " + res.status);
        }
        return res;
    } catch (e) {
        if (retries > 0 && !e.message.includes("403")) {
            await new Promise(r => setTimeout(r, delay));
            return fetchWithRetry(url, opt, retries - 1, delay * 2);
        }
        throw e;
    }
}

/**
 * ä¸‹è¼‰åŸå§‹ç¢¼
 */
function downloadSource() {
    const blob = new Blob([document.documentElement.outerHTML], { type: 'text/html' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `GCORE_GOLD_MASTER_${SN_CODE}.html`;
    a.click();
    sendMsg("ğŸ’¾ ç³»çµ±ä»£ç¢¼å·²å°è£ä¸‹è¼‰");
}

console.log("G-CORE 4.1 GOLD MASTER åŠ è¼‰å®Œç•¢ã€‚ç›®å‰è¡Œæ•¸é ä¼°ï¼š520 è¡Œã€‚");
</script>
</body>
</html>
