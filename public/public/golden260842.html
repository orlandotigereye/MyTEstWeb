<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>é‡‘ç¢§åå…¨å…¨ç®—è¡“æ¼”ç®— G-4.5</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">

<!-- å®˜æ–¹æ¨™æº–åº« -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/astronomy-engine@latest/astronomy.browser.min.js"></script>

<style>
/* ==========================================================================
   é‡‘ç¢§è¼ç…Œå…¨å±€æ¨£å¼ç³»çµ± (G-4.5 MATH VERSION)
   ========================================================================== */
:root {
    --bg-gold: #FFFDE7;
    --coin-gold: #FFD700;
    --main-gold: #D4AF37;
    --deep-gold: #B8860B;
    --text-brown: #3E2723;
    --gold-grad: linear-gradient(135deg, #FFD700 0%, #FFF176 50%, #DAA520 100%);
    --font-size: 0.5rem; /* åš´æ ¼é–å®š 0.5rem */
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }

body {
    font-family: 'PingFang TC', 'Noto Sans TC', sans-serif;
    background: var(--bg-gold) url('https://www.transparenttextures.com/patterns/gold-dust.png');
    color: var(--text-brown);
    font-size: var(--font-size);
}

header {
    height: 75px; background: var(--gold-grad);
    display: flex; justify-content: space-between; align-items: center;
    padding: 0 15px; border-bottom: 4px solid var(--deep-gold);
    position: sticky; top: 0; z-index: 1000;
}

.header-title { font-weight: 900; font-size: 0.55rem; }

.nav-tabs {
    display: flex; background: #FFF; border-bottom: 2px solid var(--main-gold);
    position: sticky; top: 75px; z-index: 999;
}

.tab {
    flex: 1; text-align: center; padding: 15px 0; font-weight: 900;
    color: #A68B5A; cursor: pointer; font-size: var(--font-size);
}

.tab.active {
    background: rgba(255, 215, 0, 0.2);
    border-bottom: 4px solid var(--deep-gold);
    color: var(--text-brown);
}

.content-area { padding: 12px; padding-bottom: 80px; }
.page { display: none; }
.page.active { display: block; }

.card {
    background: rgba(255, 255, 255, 0.95);
    border: 2px solid var(--coin-gold);
    border-radius: 12px; padding: 15px; margin-bottom: 15px;
    box-shadow: 0 4px 10px rgba(184, 134, 11, 0.1);
}

.card-title {
    font-size: var(--font-size); font-weight: 900;
    margin-bottom: 10px; color: #5D4037;
    border-left: 5px solid var(--deep-gold); padding-left: 8px;
}

textarea {
    width: 100%; height: 240px; border: 2px solid var(--main-gold);
    border-radius: 8px; padding: 12px; font-size: var(--font-size);
    background: #FFFEF2; resize: none; line-height: 1.5; outline: none;
}

.btn {
    width: 100%; padding: 15px; border: none; border-radius: 10px;
    font-weight: 900; font-size: var(--font-size); cursor: pointer;
    margin-top: 10px; transition: all 0.2s;
}
.btn-primary { background: var(--gold-grad); color: var(--text-brown); border: 1px solid var(--deep-gold); }
.btn-secondary { background: #FFF; border: 1px solid var(--main-gold); width: auto; font-size: 0.5rem; padding: 5px 10px; }

/* ç®—è¡“çµæœæ¨£å¼ */
.math-block { background: #F7F1E3; padding: 10px; border-radius: 6px; margin: 8px 0; border-left: 3px solid var(--main-gold); }
.formula { font-family: monospace; color: #8B4513; font-weight: bold; }
.result-val { color: #D32F2F; font-weight: 900; }

/* åŠ è¼‰é®ç½© */
#analysis-overlay {
    position: fixed; inset: 0; background: rgba(255, 253, 231, 0.98);
    z-index: 10000; display: none; flex-direction: column;
    align-items: center; justify-content: center; text-align: center;
}
.progress-container {
    width: 80%; height: 12px; background: #EEE; border-radius: 6px;
    border: 2px solid var(--main-gold); overflow: hidden; margin: 20px 0;
}
.progress-bar { width: 0%; height: 100%; background: var(--gold-grad); transition: width 0.2s; }

/* è¨Šæ¯ç³»çµ± */
#msg-box { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 11000; width: 90%; pointer-events: none; }
.msg-item { background: rgba(62, 39, 35, 0.9); color: var(--coin-gold); padding: 12px; border-radius: 8px; font-size: 0.5rem; text-align: center; margin-top: 5px; border: 1px solid var(--coin-gold); }

#init-overlay { position: fixed; inset: 0; background: var(--bg-gold); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }

@keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="init-overlay">
    <div style="width: 40px; height: 40px; border: 4px solid #F3F3F3; border-top: 4px solid var(--coin-gold); border-radius: 50%; animation: spin 1s linear infinite;"></div>
    <div style="margin-top:15px; font-weight:900; color:var(--deep-gold); font-size:0.5rem">ç®—è¡“å¼•æ“åˆå§‹åŒ–ä¸­...</div>
</div>

<div id="analysis-overlay">
    <div style="font-size: 0.6rem; font-weight: 900;">âš¡ åå…¨ç®—è¡“ç¥ç¶“å…ƒåŒæ­¥ä¸­ âš¡</div>
    <div class="progress-container"><div class="progress-bar" id="p-bar"></div></div>
    <div id="p-text" style="font-size:0.5rem; font-weight:900; color:var(--deep-gold);">è¼‰å…¥å…¬å¼é›†...</div>
</div>

<div id="msg-box"></div>

<header>
    <div class="header-title">ğŸ›ï¸ é‡‘ç¢§åå…¨ G-4.5 (å…¨ç®—è¡“æ¨ç®—ç‰ˆ)</div>
    <button class="btn-secondary" onclick="exportFullCode()">ğŸ’¾ ä¸‹è¼‰ç¨‹å¼</button>
</header>

<nav class="nav-tabs">
    <div class="tab active" data-p="0">æ•¸æ“šè¼¸å…¥</div>
    <div class="tab" data-p="1">ç®—è¡“åˆ†æå ±å‘Š</div>
    <div class="tab" data-p="2">AI æ„è±¡æ¼”ç®—</div>
</nav>

<div class="content-area">
    <section id="pg-0" class="page active">
        <div class="card">
            <div class="card-title">ğŸ”® é è¨­ç¯„æœ¬è¼‰å…¥ (å›ºå®šå…§å®¹)</div>
            <textarea id="main-input"></textarea>
            <button id="btn-run" class="btn btn-primary" disabled>å¼•æ“å°±ç·’ä¸­...</button>
        </div>
        <div class="card">
            <div style="font-weight:900">ç³»çµ±æµæ°´: <span id="sn-display" style="color:var(--deep-gold)">---</span></div>
        </div>
    </section>

    <section id="pg-1" class="page">
        <div id="math-report-container">
            <!-- ç®—è¡“çµæœå‹•æ…‹æ³¨å…¥ -->
            <div style="text-align:center; padding:50px; color:var(--main-gold)">å°šæœªå•Ÿå‹•ç®—è¡“æ¨æ¼”</div>
        </div>
    </section>

    <section id="pg-2" class="page">
        <div class="card">
            <div class="card-title">ğŸ–¼ï¸ é‡‘é—• AI åˆæˆæ„è±¡åœ–</div>
            <div id="ai-vision-container" style="width:100%; aspect-ratio:1/1; background:#000; border-radius:12px; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                <div id="ai-vision-status" style="color:var(--coin-gold); text-align:center;">â³ ç­‰å¾…ç®—è¡“çµæœåŒ¯å…¥...</div>
                <img id="ai-vision-img" style="width:100%; height:100%; object-fit:cover; display:none;">
            </div>
            <div id="vision-desc" style="padding:10px; font-weight:900; text-align:center;"></div>
        </div>
    </section>
</div>

<script>
const apiKey = "";
const SN_CODE = "G45-MATH-" + Math.random().toString(36).substr(2, 9).toUpperCase();

// å›ºå®šç¯„æœ¬æ•¸æ“š
const TEMPLATE_RAW = `æœˆâ†’æœ€è¿‘è¡Œæ˜Ÿ: Saturn | å¤ªé™½: 78.5Â° | æ°´æ˜Ÿ (è¾°æ˜Ÿ): 94.1Â° | é‡‘æ˜Ÿ (å¤ªç™½): 81.3Â° | ç«æ˜Ÿ (ç†’æƒ‘): 74.7Â° | æœ¨æ˜Ÿ (æ­²æ˜Ÿ): 240.6Â° | åœŸæ˜Ÿ (é®æ˜Ÿ): 2.8Â°
æœˆç›¸ï¼šğŸŒ“ ä¸Šå¼¦
å¹²æ”¯ï¼šä¹™å·³ æˆŠå­æœˆ åºšåˆæ—¥ åºšè¾°æ™‚
ç¯€æ°£ï¼šå°å¯’ï¼ˆè·é›¢ 9 å¤©ï¼‰
å®¿æ›œï¼šğŸŒ  è»«æœ¨èŸ¹ (æœ¨)
çŠ¯ / å®ˆ / åˆï¼šè»«æœ¨èŸ¹:å®ˆ
äº”è¡Œåˆæˆèƒ½é‡ï¼šæœ¨:28 ç«:35 åœŸ:25 é‡‘:20 æ°´:35
ç¤¾æœƒæ°£é‹ï¼š64
å€åŸŸç’°å¢ƒï¼šå°ä¸­å¤§é‡Œ | é›²å±¤: 100% | é¢¨é€Ÿ: 3.4 km/h | å¤©æ°£: é›¨(è¼•åº¦)`;

let MATH_RESULTS = {};

function showMsg(t) {
    const el = $(`<div class="msg-item">${t}</div>`);
    $('#msg-box').append(el);
    setTimeout(()=>el.fadeOut(500, ()=>el.remove()), 3000);
}

// ç®—è¡“å¼•æ“æ ¸å¿ƒ
const MathEngine = {
    // 1. äº”è¡Œåˆæˆå¹³è¡¡åº¦ç®—è¡“
    calcElements(data) {
        const total = data.wood + data.fire + data.earth + data.metal + data.water;
        const avg = total / 5;
        const variance = (Math.pow(data.wood-avg,2)+Math.pow(data.fire-avg,2)+Math.pow(data.earth-avg,2)+Math.pow(data.metal-avg,2)+Math.pow(data.water-avg,2))/5;
        const stability = Math.max(0, 100 - Math.sqrt(variance)).toFixed(2);
        return { total, avg, stability, formula: `Stability = 100 - sqrt( Î£(x-Î¼)Â² / 5 )` };
    },
    // 2. ç¤¾æœƒæ°£é‹å‹•æ…‹åŠ æ¬Šç®—è¡“
    calcFortune(base, cloud, wind, rain) {
        // å‡è¨­é›¨æ°´å°æ°£é‹æœ‰ -5% å½±éŸ¿ï¼Œé›²å±¤ 100% å°é™°æ€§èƒ½é‡æœ‰åŠ ä¹˜
        const rainImpact = rain ? -5 : 0;
        const cloudFactor = (cloud / 100) * 2; 
        const result = (base + rainImpact + cloudFactor).toFixed(2);
        return { result, formula: `Final = Base(${base}) + RainImpact(${rainImpact}) + CloudFactor(${cloudFactor})` };
    },
    // 3. æ˜Ÿé«”ç›¸ä½åè§’ç®—è¡“
    calcPhases(saturnDeg) {
        // åœŸæ˜Ÿ 2.8Â° ä»£è¡¨æ¥µåº¦æ¥è¿‘åˆç›¸
        const proximity = (1 - (saturnDeg / 360)) * 100;
        const gravEffect = (proximity * 0.75).toFixed(2);
        return { proximity: proximity.toFixed(2), gravEffect, formula: `GravEffect = (1 - Deg/360) * 100 * 0.75` };
    }
};

async function init() {
    $('#sn-display').text(SN_CODE);
    $('#main-input').val(TEMPLATE_RAW);
    setTimeout(() => {
        $('#btn-run').prop('disabled', false).text('ğŸš€ åŸ·è¡Œå…¨ç®—è¡“æ¨æ¼”');
        $('#init-overlay').fadeOut();
    }, 1000);
}

async function runInference() {
    $('#analysis-overlay').css('display', 'flex');
    const steps = ["æ•¸æ“šæ¨™é‡åŒ–...", "åŸ·è¡Œäº”è¡Œæ–¹å·®æ¼”ç®—...", "æ¨å°æ°£é‹åå€¼...", "è§£æåœŸæ˜Ÿé‡åŠ›çŸ©...", "åˆæˆå®¿æ›œé€±æœŸåœ–è­œ..."];
    
    for(let i=0; i<steps.length; i++) {
        $('#p-bar').css('width', `${(i+1)*20}%`);
        $('#p-text').text(steps[i]);
        await new Promise(r=>setTimeout(r, 400));
    }

    // åŸ·è¡Œç®—è¡“
    const eCalc = MathEngine.calcElements({wood:28, fire:35, earth:25, metal:20, water:35});
    const fCalc = MathEngine.calcFortune(64, 100, 3.4, true);
    const pCalc = MathEngine.calcPhases(2.8);

    MATH_RESULTS = { eCalc, fCalc, pCalc };

    // å‘¼å« Gemini é€²è¡Œç¸½çµèˆ‡æ„è±¡æç¤ºè© (ä¿æŒ AI éˆé­‚)
    try {
        const aiRes = await callGeminiSummary();
        renderReport(aiRes);
        const img = await generateAIImage(aiRes.image_prompt);
        $('#ai-vision-img').attr('src', img).show();
        $('#ai-vision-status').hide();
        $('#vision-desc').text(aiRes.summary);
        
        switchPage(1);
        showMsg("âœ… åå…¨ç®—è¡“å ±å‘Šå·²ç”¢å‡º");
    } catch(e) {
        showMsg("âš ï¸ AI ç¸½çµæ¨¡çµ„é€£ç·šç•°å¸¸ï¼Œåƒ…é¡¯ç¤ºç´”ç®—è¡“çµæœ");
        renderReport(null);
        switchPage(1);
    } finally {
        $('#analysis-overlay').fadeOut();
    }
}

async function callGeminiSummary() {
    const prompt = `é‡å°ä»¥ä¸‹ç®—è¡“çµæœï¼š
    1. äº”è¡Œç©©å®šåº¦ï¼š${MATH_RESULTS.eCalc.stability}% (å…¬å¼ï¼š${MATH_RESULTS.eCalc.formula})
    2. ä¿®æ­£æ°£é‹ï¼š${MATH_RESULTS. fCalc.result} (è€ƒæ…®é›¨æ°´èˆ‡é›²å±¤)
    3. åœŸæ˜Ÿç›¸ä½å½±éŸ¿åŠ›ï¼š${MATH_RESULTS.pCalc.gravEffect}
    èƒŒæ™¯ï¼šè»«æœ¨èŸ¹å®ˆã€ä¹™å·³å¹´ã€ä¸Šå¼¦æœˆã€‚
    è«‹çµ¦å‡ºä¸€æ®µ 100 å­—å…§çš„å°ˆæ¥­å‘½ç†ç¸½çµï¼Œä¸¦æä¾›ä¸€å€‹ç¹ªåœ– Promptã€‚è¼¸å‡º JSON: {"summary":"...", "image_prompt":"..."}`;

    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
    });
    const data = await res.json();
    return JSON.parse(data.candidates[0].content.parts[0].text);
}

async function generateAIImage(prompt) {
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ instances: { prompt: `Celestial balance, golden astrology chart, ${prompt}, cinematic lighting, 8k` }, parameters: { sampleCount: 1 } })
    });
    const data = await res.json();
    return `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
}

function renderReport(ai) {
    let h = `<div class="card" style="background:var(--gold-grad);">
                <div class="card-title">ğŸ”± é‡‘é—•ç®—è¡“ç¸½è©•</div>
                <div style="font-weight:900;">${ai ? ai.summary : 'ç®—è¡“æ¨æ¼”å®Œæˆï¼ŒAI ç¸½çµè¼‰å…¥ä¸­...'}</div>
             </div>`;

    // ç®—è¡“é … 1
    h += `<div class="card">
            <div class="card-title">ğŸ“Š äº”è¡Œåˆæˆå¹³è¡¡æ¼”ç®—</div>
            <div class="math-block">
                <div>æ¨å°å…¬å¼ï¼š<span class="formula">${MATH_RESULTS.eCalc.formula}</span></div>
                <div>ç©©å®šä¿‚æ•¸ï¼š<span class="result-val">${MATH_RESULTS.eCalc.stability}%</span></div>
                <div style="margin-top:5px;">[æ¼”ç®—ç´°ç¯€]ï¼šäº”è¡Œç¸½èƒ½ ${MATH_RESULTS.eCalc.total}ï¼Œå‡å€¼ ${MATH_RESULTS.eCalc.avg}ã€‚æ–¹å·®é¡¯ç¤ºç•¶å‰èƒ½é‡åˆ†ä½ˆè¼ƒç‚ºé›†ä¸­ã€‚</div>
            </div>
          </div>`;

    // ç®—è¡“é … 2
    h += `<div class="card">
            <div class="card-title">ğŸ“ˆ ç¤¾æœƒæ°£é‹å‹•æ…‹ä¿®æ­£</div>
            <div class="math-block">
                <div>æ¨å°å…¬å¼ï¼š<span class="formula">${MATH_RESULTS.fCalc.formula}</span></div>
                <div>æœ€çµ‚æŒ‡æ•¸ï¼š<span class="result-val">${MATH_RESULTS.fCalc.result}</span></div>
                <div style="margin-top:5px;">[ç’°å¢ƒåŠ æ¬Š]ï¼šå°ä¸­å¤§é‡Œ 100% é›²å±¤è¦†è“‹ç”¢ç”Ÿçš„é™°æ€§æ“¾å‹•å·²è¨ˆå…¥ã€‚</div>
            </div>
          </div>`;

    // ç®—è¡“é … 3
    h += `<div class="card">
            <div class="card-title">ğŸª åœŸæ˜Ÿç›¸ä½å¼•åŠ›çŸ©</div>
            <div class="math-block">
                <div>æ¨å°å…¬å¼ï¼š<span class="formula">${MATH_RESULTS.pCalc.formula}</span></div>
                <div>å½±éŸ¿å¼·åº¦ï¼š<span class="result-val">${MATH_RESULTS.pCalc.gravEffect} unit</span></div>
                <div style="margin-top:5px;">[ç›¸ä½åˆ¤å®š]ï¼šåœŸæ˜Ÿè·æœˆ 2.8Â° è™•æ–¼ã€Œå®ˆã€ä½ä¹‹å·”ï¼Œé‡åŠ›çŸ©æ•ˆæ‡‰æ¥µå¼·ã€‚</div>
            </div>
          </div>`;

    $('#math-report-container').html(h);
}

function switchPage(i) {
    $('.tab').removeClass('active'); $(`.tab[data-p=${i}]`).addClass('active');
    $('.page').removeClass('active'); $(`#pg-${i}`).addClass('active');
}

function exportFullCode() {
    const b = new Blob([document.documentElement.outerHTML], {type:'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(b); a.download = `G45_MATH_REPORT.html`; a.click();
}

$(document).ready(init);
$('.tab').click(function(){ switchPage($(this).data('p')); });
$('#btn-run').click(runInference);

</script>
</body>
</html>
