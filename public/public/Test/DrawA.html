<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Universal Skeleton → Skin → Comic Line System</title>
<style>
/* =========================
   GLOBAL UI / RESET
========================= */
*{box-sizing:border-box}
html,body{
  margin:0;padding:0;
  width:100%;height:100%;
  background:#111;
  color:#eee;
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
  overflow:hidden;
}
button,input,select{
  background:#222;color:#eee;
  border:1px solid #444;
  border-radius:6px;
  padding:6px 10px;
}
button:hover{background:#333}
.panel{
  background:#1a1a1a;
  border:1px solid #333;
  border-radius:8px;
  padding:8px;
}
h3{margin:6px 0;font-size:14px;color:#ffd700}

/* =========================
   LAYOUT
========================= */
#app{
  display:grid;
  grid-template-columns:280px 1fr 260px;
  grid-template-rows:1fr;
  height:100%;
}
#left,#right{
  overflow:auto;
}
#center{
  position:relative;
  background:#000;
}
#toolbar{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
#canvasWrap{
  position:absolute;
  inset:0;
}
svg{
  width:100%;
  height:100%;
  touch-action:none;
}

/* =========================
   VISUAL LAYERS
========================= */
.bone{stroke:#00eaff;stroke-width:3;fill:none}
.joint{fill:#ff5;stroke:#000;stroke-width:1}
.skin{stroke:#fff;stroke-width:2;fill:none}
.comic{stroke:#fff;stroke-width:3;fill:none;stroke-linecap:round;stroke-linejoin:round}

/* =========================
   LISTS
========================= */
.list{display:flex;flex-direction:column;gap:4px}
.item{
  padding:4px 6px;
  background:#222;
  border:1px solid #333;
  border-radius:4px;
  font-size:12px;
}
.item.active{background:#444}
</style>
</head>
<body>
<div id="app">

<!-- LEFT PANEL -->
<div id="left" class="panel">
<h3>骨架系統</h3>
<div id="toolbar">
<button id="addJoint">＋ 關節</button>
<button id="addBone">＋ 骨</button>
<button id="delSel">刪除</button>
<button id="clearAll">清空</button>
</div>

<h3>模式</h3>
<div id="toolbar">
<button data-mode="select">選取</button>
<button data-mode="joint">關節</button>
<button data-mode="bone">骨</button>
<button data-mode="move">移動</button>
</div>

<h3>姿勢庫</h3>
<div id="toolbar">
<button id="savePose">存姿勢</button>
<button id="loadPose">載入</button>
</div>
<div id="poseList" class="list"></div>
</div>

<!-- CENTER -->
<div id="center">
<div id="canvasWrap">
<svg id="svg" viewBox="0 0 1000 1000">
<g id="bonesLayer"></g>
<g id="jointsLayer"></g>
<g id="skinLayer"></g>
<g id="comicLayer"></g>
</svg>
</div>
</div>

<!-- RIGHT PANEL -->
<div id="right" class="panel">
<h3>包皮 / 線條</h3>
<div id="toolbar">
<button id="genSkin">骨架 → 包皮</button>
<button id="genComic">包皮 → 漫畫線</button>
<button id="exportSVG">匯出 SVG</button>
</div>

<h3>參數</h3>
<label>包皮寬度
<input id="skinWidth" type="range" min="10" max="80" value="30">
</label>
<label>漫畫抖動
<input id="jitter" type="range" min="0" max="10" value="3">
</label>

<h3>資料</h3>
<div id="toolbar">
<button id="saveLocal">存本機</button>
<button id="loadLocal">載入</button>
</div>
</div>

</div>

<script>
/* =========================================================
   CORE DATA
========================================================= */
const svg = document.getElementById('svg')
const bonesLayer = document.getElementById('bonesLayer')
const jointsLayer = document.getElementById('jointsLayer')
const skinLayer = document.getElementById('skinLayer')
const comicLayer = document.getElementById('comicLayer')

let mode='select'
let joints=[]
let bones=[]
let skins=[]
let poses=[]
let selected=null
let tempBone=null

const uid=()=>Math.random().toString(36).slice(2)

/* =========================================================
   UTILS
========================================================= */
function pt(evt){
  const r=svg.getBoundingClientRect()
  return {
    x:(evt.clientX-r.left)/r.width*1000,
    y:(evt.clientY-r.top)/r.height*1000
  }
}
function dist(a,b){
  return Math.hypot(a.x-b.x,a.y-b.y)
}

/* =========================================================
   RENDER
========================================================= */
function render(){
  bonesLayer.innerHTML=''
  jointsLayer.innerHTML=''
  skinLayer.innerHTML=''
  comicLayer.innerHTML=''

  bones.forEach(b=>{
    const j1=joints.find(j=>j.id===b.a)
    const j2=joints.find(j=>j.id===b.b)
    if(!j1||!j2)return
    const l=document.createElementNS('http://www.w3.org/2000/svg','line')
    l.setAttribute('x1',j1.x)
    l.setAttribute('y1',j1.y)
    l.setAttribute('x2',j2.x)
    l.setAttribute('y2',j2.y)
    l.classList.add('bone')
    bonesLayer.appendChild(l)
  })

  joints.forEach(j=>{
    const c=document.createElementNS('http://www.w3.org/2000/svg','circle')
    c.setAttribute('cx',j.x)
    c.setAttribute('cy',j.y)
    c.setAttribute('r',6)
    c.classList.add('joint')
    jointsLayer.appendChild(c)
  })

  skins.forEach(p=>{
    const path=document.createElementNS('http://www.w3.org/2000/svg','path')
    path.setAttribute('d',p)
    path.classList.add('skin')
    skinLayer.appendChild(path)
  })

  skins.forEach(p=>{
    const jitter=parseInt(document.getElementById('jitter').value)
    const d=p.replace(/([0-9\.]+)/g,(m)=>{
      return (parseFloat(m)+(Math.random()-0.5)*jitter).toFixed(2)
    })
    const path=document.createElementNS('http://www.w3.org/2000/svg','path')
    path.setAttribute('d',d)
    path.classList.add('comic')
    comicLayer.appendChild(path)
  })
}

/* =========================================================
   INTERACTION
========================================================= */
svg.addEventListener('pointerdown',e=>{
  const p=pt(e)
  if(mode==='joint'){
    joints.push({id:uid(),x:p.x,y:p.y})
    render()
  }
  if(mode==='bone'){
    const j=joints.find(j=>dist(j,p)<10)
    if(j){
      if(!tempBone)tempBone=j
      else{
        bones.push({id:uid(),a:tempBone.id,b:j.id})
        tempBone=null
        render()
      }
    }
  }
  if(mode==='move'){
    selected=joints.find(j=>dist(j,p)<10)
  }
})
svg.addEventListener('pointermove',e=>{
  if(selected&&mode==='move'){
    const p=pt(e)
    selected.x=p.x
    selected.y=p.y
    render()
  }
})
svg.addEventListener('pointerup',()=>selected=null)

/* =========================================================
   SKIN GENERATION
========================================================= */
function genSkin(){
  skins=[]
  const w=parseInt(document.getElementById('skinWidth').value)
  bones.forEach(b=>{
    const j1=joints.find(j=>j.id===b.a)
    const j2=joints.find(j=>j.id===b.b)
    if(!j1||!j2)return
    const dx=j2.x-j1.x
    const dy=j2.y-j1.y
    const len=Math.hypot(dx,dy)||1
    const nx=-dy/len*w
    const ny=dx/len*w
    const d=`
      M ${j1.x+nx} ${j1.y+ny}
      L ${j2.x+nx} ${j2.y+ny}
      L ${j2.x-nx} ${j2.y-ny}
      L ${j1.x-nx} ${j1.y-ny}
      Z`
    skins.push(d)
  })
  render()
}

/* =========================================================
   POSE LIBRARY
========================================================= */
function savePose(){
  poses.push(JSON.parse(JSON.stringify(joints)))
  updatePoseList()
}
function loadPose(i){
  joints=JSON.parse(JSON.stringify(poses[i]))
  render()
}
function updatePoseList(){
  const list=document.getElementById('poseList')
  list.innerHTML=''
  poses.forEach((p,i)=>{
    const d=document.createElement('div')
    d.className='item'
    d.textContent='Pose '+(i+1)
    d.onclick=()=>loadPose(i)
    list.appendChild(d)
  })
}

/* =========================================================
   EXPORT / STORAGE
========================================================= */
function exportSVG(){
  const clone=svg.cloneNode(true)
  const blob=new Blob([clone.outerHTML],{type:'image/svg+xml'})
  const a=document.createElement('a')
  a.href=URL.createObjectURL(blob)
  a.download='skeleton_skin_comic.svg'
  a.click()
}
function saveLocal(){
  localStorage.setItem('skeletonData',JSON.stringify({joints,bones,poses}))
}
function loadLocal(){
  const d=JSON.parse(localStorage.getItem('skeletonData')||'{}')
  joints=d.joints||[]
  bones=d.bones||[]
  poses=d.poses||[]
  updatePoseList()
  render()
}

/* =========================================================
   UI BINDINGS
========================================================= */
document.querySelectorAll('[data-mode]').forEach(b=>{
  b.onclick=()=>mode=b.dataset.mode
})
document.getElementById('genSkin').onclick=genSkin
document.getElementById('genComic').onclick=render
document.getElementById('exportSVG').onclick=exportSVG
document.getElementById('savePose').onclick=savePose
document.getElementById('saveLocal').onclick=saveLocal
document.getElementById('loadLocal').onclick=loadLocal
document.getElementById('clearAll').onclick=()=>{
  joints=[];bones=[];skins=[];poses=[]
  updatePoseList();render()
}

/* =========================================================
   INIT
========================================================= */
render()
</script>
</body>
</html>
