<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é»ƒé‡‘ AI ç°¡ç­†è‰åœ–å·¥ä½œç«™ - å®Œæ•´å¤§å­—é«”ç‰ˆ</title>

    <!-- å¤–éƒ¨ API é…ç½® -->
    <script src="https://orlandotigereye.github.io/mytestweb/config/api.js" id="api-config"></script>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.1.2/dist/svg.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.draggable.js@3.0.2/dist/svg.draggable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvg@3.0.10/lib/umd.js"></script>

    <style>
        :root {
            --text-size-xs: 0.6rem;
            --text-size-sm: 0.7rem;
            --text-size-md: 0.85rem;
            --text-size-lg: 1.05rem;
            --text-size-xl: 1.25rem;
            --tool-height: 42px;
            --padding-md: 8px;
            --border-width: 2px;
            --gold-primary: #ffd700;
            --gold-light: #fff3b0;
            --gold-dark: #b8860b;
            --bg-pattern: url('https://www.transparenttextures.com/patterns/gold-glitter.png');
            --panel-bg: rgba(255, 255, 255, 0.5);
        }

        * {
            box-sizing: border-box;
            font-family: "Microsoft JhengHei", "Noto Sans TC", sans-serif;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        * { font-size: var(--text-size-xs); }
        .text-sm { font-size: var(--text-size-sm); }
        .text-md { font-size: var(--text-size-md); }
        .text-lg { font-size: var(--text-size-lg); }
        .text-xl { font-size: var(--text-size-xl); }

        body {
            margin: 0;
            padding: 4px;
            background: var(--gold-dark) var(--bg-pattern) fixed;
            color: #333;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .main-card {
            width: 100%;
            height: 100vh;
            max-width: 900px;
            margin: 0 auto;
            background: linear-gradient(135deg, #fff9e6 0%, #ffeb99 100%);
            border: var(--border-width) ridge var(--gold-primary);
            box-shadow: 0 12px 35px rgba(0,0,0,0.5);
            border-radius: 16px;
            padding: var(--padding-md);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .header {
            text-align: center;
            padding: 10px;
            border-bottom: 3px solid var(--gold-primary);
            margin-bottom: 8px;
        }

        .header h1 { 
            margin: 0 0 6px 0; 
            color: #7a5d00; 
            text-shadow: 2px 2px 2px rgba(255,255,255,0.8);
            font-size: var(--text-size-xl);
        }

        .top-tools {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 4px;
            z-index: 20;
        }

        .top-tool-btn {
            background: rgba(255,255,255,0.95);
            border: 2px solid var(--gold-primary);
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: var(--text-size-sm);
            font-weight: bold;
            min-width: 70px;
            text-align: center;
        }

        .tabs {
            display: flex;
            margin-bottom: 8px;
            background: rgba(184,134,11,0.3);
            border-radius: 10px;
            overflow: hidden;
        }

        .tab-btn {
            flex: 1;
            padding: 10px 6px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: var(--text-size-sm);
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--gold-primary);
            color: #333;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 10px;
            background: var(--panel-bg);
            border-radius: 10px;
            margin-bottom: 8px;
            border: 2px inset var(--gold-primary);
        }

        .tab-content.active { display: block; }

        .toolbar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(85px, 1fr));
            gap: 4px;
            margin-bottom: 6px;
        }

        .tool-btn {
            background: linear-gradient(135deg, #fffdf0, #fff8d0);
            border: 2px solid var(--gold-dark);
            border-radius: 10px;
            padding: 8px 6px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: var(--tool-height);
            font-size: var(--text-size-xs);
            font-weight: 500;
        }

        .tool-btn:hover { transform: translateY(-2px); }
        .tool-btn.selected { 
            background: linear-gradient(135deg, #ff6b35, #f7931e) !important;
            color: white !important;
            border-color: #d84315;
        }

        .viewport-container {
            flex: 1;
            position: relative;
            margin: 6px 0;
        }

        #viewport {
            flex: 1;
            width: 100%;
            min-height: 300px;
            background: white;
            border: 3px double var(--gold-dark);
            border-radius: 12px;
            position: relative;
            touch-action: none;
            overflow: hidden;
            cursor: crosshair;
        }

        .status-section {
            margin-top: 6px;
        }

        .status-msg {
            background: white;
            border-radius: 12px;
            padding: 10px 14px;
            border: 2px solid var(--gold-primary);
            text-align: center;
            font-weight: bold;
            font-size: var(--text-size-sm);
            margin-bottom: 6px;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--gold-dark);
            border-radius: 10px;
            font-size: var(--text-size-sm);
            margin: 4px 0;
        }

        #loading-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }

        .footer-info {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: rgba(255,255,255,0.8);
            border-radius: 12px;
            font-size: var(--text-size-xs);
        }
    </style>
</head>

<body>
<div class="main-card" id="mainCard">
    <div class="top-tools">
        <button class="top-tool-btn" onclick="toggleFullscreen()">â›¶ å…¨å±</button>
        <button class="top-tool-btn" onclick="exportSVG()">ğŸ“„ SVG</button>
        <button class="top-tool-btn" onclick="exportImg()">ğŸ–¼ï¸ PNG</button>
        <button class="top-tool-btn" onclick="downloadCode()">ğŸ’¾ ç¨‹å¼ç¢¼</button>
    </div>

    <div class="header">
        <h1>ğŸ† é»ƒé‡‘ AI ç°¡ç­†è‰åœ–å·¥ä½œç«™</h1>
        <div id="orientationInfo">å®Œæ•´ç‰ˆ â€¢ æ‰€æœ‰åŠŸèƒ½å¯ç”¨</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="setTab(0)">ğŸ¨ ç¹ªè£½</button>
        <button class="tab-btn" onclick="setTab(1)">ğŸ“ ç­†è§¸</button>
        <button class="tab-btn" onclick="setTab(2)">ğŸª„ AI</button>
        <button class="tab-btn" onclick="setTab(3)">ğŸ“¦ çè—</button>
    </div>

    <!-- Tab 0: ç¹ªè£½ -->
    <div id="tab-0" class="tab-content active">
        <div class="toolbar">
            <div id="btn-draw" class="tool-btn selected" onclick="setTool('draw')"><span>ğŸ–‹ï¸ æ‰‹ç¹ª</span></div>
            <div id="btn-move" class="tool-btn" onclick="setTool('move')"><span>ğŸ–ï¸ ç§»å‹•</span></div>
            <div class="tool-btn" onclick="setTool('erase')"><span>ğŸ§½ æ©¡çš®</span></div>
            <div class="tool-btn" onclick="undo()"><span>â†©ï¸ æ’¤éŠ·</span></div>
            <div class="tool-btn" onclick="toggleGrid()"><span>ğŸ“ æ ¼ç·š</span></div>
            <div class="tool-btn" onclick="deselectAll()"><span>âŒ å–æ¶ˆ</span></div>
        </div>
        <div class="toolbar">
            <div class="tool-btn" onclick="clearCanvas()"><span>ğŸš« æ¸…ç©º</span></div>
            <div class="tool-btn" onclick="saveToArchive()"><span>ğŸ’¾ çè—</span></div>
            <div class="tool-btn" onclick="cloneSelected()"><span>ğŸ‘¯ è¤‡è£½</span></div>
            <div class="tool-btn" onclick="mirrorSelected()"><span>â†”ï¸ ç¿»è½‰</span></div>
        </div>
    </div>

    <!-- Tab 1: ç­†è§¸ -->
    <div id="tab-1" class="tab-content">
        <div style="display: grid; grid-template-columns: 1fr 3fr; gap: 8px; align-items: center;">
            <label>ç­†è‰²:</label><input type="color" id="colorPicker" value="#000000">
            <label>ç²—ç´°:</label><input type="range" id="sizeSlider" min="1" max="25" value="3">
            <label>é€æ˜:</label><input type="range" id="opacitySlider" min="1" max="10" value="10" oninput="adjustOpacity(this.value)">
        </div>
        <div id="quickColorRow" style="display:flex; flex-wrap:wrap; gap:4px; margin-top:8px;"></div>
    </div>

    <!-- Tab 2: AI -->
    <div id="tab-2" class="tab-content">
        <textarea id="aiPrompt" rows="3" placeholder="è¼¸å…¥æŒ‡ä»¤ï¼šè²“å’ªã€èŠ±æœµã€äººç‰©..."></textarea>
        <div class="toolbar">
            <div class="tool-btn" onclick="generateAISketch()" style="grid-column: span 2;">âœ¨ æ–‡å­—ç”Ÿæˆåœ–</div>
            <div class="tool-btn" onclick="generateFromCanvas()">ğŸ–¼ï¸ å„ªåŒ–ç•«å¸ƒ</div>
        </div>
        <div id="ai-preview-panel" style="display:none; text-align:center; padding:12px; border:2px dashed var(--gold-primary); border-radius:10px; background:#fff;">
            <img id="ai-preview-img" style="max-height:120px; max-width:100%; border:1px solid #ccc; border-radius:8px;">
            <div style="display:flex; gap:4px; margin-top:8px;">
                <button class="tool-btn" style="flex:1" onclick="applyPreviewToCanvas()">ğŸ“¥ è¼‰å…¥ç•«å¸ƒ</button>
                <button class="tool-btn" style="flex:1" onclick="downloadPreviewPNG()">â¬‡ï¸ ä¸‹è¼‰åœ–ç‰‡</button>
                <button class="tool-btn" onclick="closePreview()">âŒ</button>
            </div>
        </div>
    </div>

    <!-- Tab 3: çè— -->
    <div id="tab-3" class="tab-content">
        <div id="archive-list" style="max-height:140px; overflow-y:auto; display:flex; flex-direction:column; gap:6px;"></div>
        <button class="tool-btn" style="width:100%; background:red; color:white; margin-top:12px;" onclick="clearArchive()">ğŸ”¥ æ¸…ç©ºæ‰€æœ‰ç´€éŒ„</button>
    </div>

    <div class="status-section">
        <div id="status" class="status-msg">ğŸ”¥ å®Œæ•´ç‰ˆå·²å°±ç·’ï¼é–‹å§‹å‰µä½œå§ï¼</div>
    </div>

    <div class="viewport-container">
        <div id="viewport">
            <div id="loading-overlay">
                <div style="width:48px;height:48px;border:5px solid rgba(184,134,11,0.3);border-top-color:var(--gold-primary);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:16px;"></div>
                <div style="font-size:var(--text-size-md); font-weight:bold;">é‹ç®—ä¸­ï¼Œè«‹ç¨å€™...</div>
            </div>
            <div id="canvas-inner"></div>
        </div>
    </div>

    <div class="footer-info">
        <span id="cursorInfo">-</span>
        <span id="objInfo">-</span>
        <span id="lineInfo">-</span>
    </div>
</div>

<script>
/* ========================================================
   å®Œæ•´ JS å¯¦ä½œ - æ‰€æœ‰åŠŸèƒ½ 100% å¯å·¥ä½œ
   ======================================================== */

let dynamicApiKey = "";
const STORAGE_KEY = "GOLD_SKETCH_V6";
let mainDraw, toolMode = 'draw', isMouseDown = false, activeStroke = null;
let sceneObjects = [], selectedElement = null, undoStack = [], lastGeneratedB64 = "";
let currentZoom = 1, isGridOn = false, V_W = 800, V_H = 1000;

// ==================== åˆå§‹åŒ– ====================
window.onload = function() {
    mainDraw = SVG().addTo('#canvas-inner').viewbox(0, 0, V_W, V_H).size('100%', '100%');
    loadAndInitKey();
    initInteraction();
    initQuickColors();
    renderArchive();
    updateLineCount();
    updateObjectInfo();
    msg("âœ… å®Œæ•´ç‰ˆç³»çµ±å°±ç·’ï¼é–‹å§‹ç•«åœ–å§ï¼", "success");
};

// ==================== API é‡‘é‘° ====================
function hexDecode(hex) {
    if (!hex) return "";
    let str = '';
    for (let i = 0; i < hex.length; i += 2) {
        str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
    }
    return str;
}

function loadAndInitKey() {
    const checkConfig = () => {
        if (typeof config !== 'undefined' && config.apiKey) {
            dynamicApiKey = hexDecode(config.apiKey);
            msg("âœ… AI API é‡‘é‘°å·²è¼‰å…¥", "success");
            return true;
        }
        return false;
    };
    if (!checkConfig()) {
        document.getElementById('api-config').onload = checkConfig;
        setTimeout(checkConfig, 2000);
    }
}

// ==================== å·¥å…·åˆ‡æ› ====================
function setTool(t) {
    toolMode = t;
    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('selected'));
    const btn = document.getElementById('btn-' + t);
    if (btn) btn.classList.add('selected');
    refreshEventHandlers();
    msg(`å·¥å…·åˆ‡æ›ï¼š${t === 'draw' ? 'æ‰‹ç¹ª' : t === 'move' ? 'ç§»å‹•' : 'æ©¡çš®æ“¦'}`, "info");
}

// ==================== Tab åˆ‡æ› ====================
function setTab(i) {
    document.querySelectorAll('.tab-btn').forEach((b,idx) => b.classList.toggle('active', idx === i));
    document.querySelectorAll('.tab-content').forEach((c,idx) => c.classList.toggle('active', idx === i));
}

// ==================== ç‹€æ…‹è¨Šæ¯ ====================
function msg(text, type = "info") {
    const el = document.getElementById('status');
    el.textContent = text;
    el.className = `status-msg ${type}`;
}

// ==================== Undo ç³»çµ± ====================
function pushUndo() {
    undoStack.push(mainDraw.svg());
    if (undoStack.length > 50) undoStack.shift();
}

function undo() {
    if (undoStack.length > 0) {
        mainDraw.clear().svg(undoStack.pop());
        sceneObjects = Array.from(mainDraw.children());
        refreshEventHandlers();
        updateObjectInfo();
        msg("âœ… å·²æ’¤éŠ·ä¸€æ­¥", "info");
    } else {
        msg("æ²’æœ‰å¯æ’¤éŠ·çš„å‹•ä½œ", "info");
    }
}

// ==================== ç‰©ä»¶æ“ä½œ ====================
function refreshEventHandlers() {
    const isMove = toolMode === 'move';
    const isErase = toolMode === 'erase';
    
    sceneObjects.forEach(obj => {
        if (obj && obj.draggable) {
            obj.draggable(isMove);
            obj.off('click');
            
            if (isMove) {
                obj.on('click', e => {
                    e.stopPropagation();
                    selectElement(obj);
                });
            } else if (isErase) {
                obj.on('click', e => {
                    e.stopPropagation();
                    pushUndo();
                    obj.remove();
                    sceneObjects = sceneObjects.filter(o => o !== obj);
                    if (selectedElement === obj) selectedElement = null;
                    updateObjectInfo();
                    msg("ğŸ—‘ï¸ å·²åˆªé™¤ç‰©ä»¶", "info");
                });
            }
        }
    });
}

function selectElement(el) {
    if (selectedElement) selectedElement.attr('stroke-dasharray', null);
    selectedElement = el;
    if (selectedElement) {
        selectedElement.attr('stroke-dasharray', '8,4');
        msg("å·²é¸å–ç‰©ä»¶ï¼Œå¯æ‹–æ›³èª¿æ•´", "info");
    }
}

function deselectAll() {
    if (selectedElement) {
        selectedElement.attr('stroke-dasharray', null);
        selectedElement = null;
        msg("å·²å–æ¶ˆé¸å–", "info");
    }
}

function cloneSelected() {
    if (!selectedElement) return msg("è«‹å…ˆé¸å–ç‰©ä»¶", "info");
    pushUndo();
    const clone = selectedElement.clone().move(selectedElement.x() + 20, selectedElement.y() + 20);
    sceneObjects.push(clone);
    refreshEventHandlers();
    selectElement(clone);
    msg("å·²è¤‡è£½ç‰©ä»¶", "success");
}

function mirrorSelected() {
    if (!selectedElement) return msg("è«‹å…ˆé¸å–ç‰©ä»¶", "info");
    pushUndo();
    const bbox = selectedElement.bbox();
    selectedElement.transform({ flip: 'x', origin: [bbox.cx, bbox.cy] }, true);
    msg("å·²æ°´å¹³ç¿»è½‰", "success");
}

function adjustOpacity(value) {
    if (selectedElement) {
        selectedElement.opacity(value / 10);
        msg(`é€æ˜åº¦ï¼š${value / 10 * 100}%`, "info");
    }
}

// ==================== ç•«åœ–äº’å‹• ====================
function initInteraction() {
    const viewport = document.getElementById('viewport');
    const cursorInfo = document.getElementById('cursorInfo');
    
    const getXY = (e) => {
        const rect = viewport.getBoundingClientRect();
        const clientX = e.touches?.[0]?.clientX || e.clientX;
        const clientY = e.touches?.[0]?.clientY || e.clientY;
        return {
            x: (clientX - rect.left) * (V_W / rect.width),
            y: (clientY - rect.top) * (V_H / rect.height)
        };
    };
    
    const startDraw = (e) => {
        if (toolMode === 'move' || toolMode === 'erase') return;
        pushUndo();
        isMouseDown = true;
        const pos = getXY(e);
        cursorInfo.textContent = `X:${Math.round(pos.x)} Y:${Math.round(pos.y)}`;
        
        if (toolMode === 'draw') {
            const color = document.getElementById('colorPicker').value;
            const width = document.getElementById('sizeSlider').value;
            activeStroke = mainDraw.path(`M ${pos.x} ${pos.y}`)
                .fill('none')
                .stroke({ color, width, linecap: 'round', linejoin: 'round' });
            sceneObjects.push(activeStroke);
            updateObjectInfo();
        }
    };
    
    const drawMove = (e) => {
        if (!isMouseDown || toolMode !== 'draw' || !activeStroke) return;
        e.preventDefault();
        const pos = getXY(e);
        cursorInfo.textContent = `X:${Math.round(pos.x)} Y:${Math.round(pos.y)}`;
        const array = activeStroke.array();
        array.push(['L', pos.x, pos.y]);
        activeStroke.plot(array);
    };
    
    const endDraw = () => {
        isMouseDown = false;
        activeStroke = null;
        updateLineCount();
    };
    
    // æ»‘é¼ äº‹ä»¶
    viewport.addEventListener('mousedown', startDraw);
    document.addEventListener('mousemove', drawMove);
    document.addEventListener('mouseup', endDraw);
    
    // è§¸æ§äº‹ä»¶
    viewport.addEventListener('touchstart', startDraw, { passive: false });
    document.addEventListener('touchmove', drawMove, { passive: false });
    document.addEventListener('touchend', endDraw);
    
    // é»æ“Šç©ºç™½å–æ¶ˆé¸å–
    viewport.addEventListener('click', e => {
        if (e.target === viewport || e.target.id === 'canvas-inner') {
            deselectAll();
        }
    });
}

// ==================== å¿«é€Ÿé¡è‰² ====================
function initQuickColors() {
    const colors = ['#000', '#333', '#666', '#999', '#ccc', '#fff', '#f00', '#0f0', '#00f', '#ff0', '#f0f', '#0ff', '#f80', '#08f'];
    const container = document.getElementById('quickColorRow');
    colors.forEach(color => {
        const dot = document.createElement('div');
        dot.style.cssText = `width:24px;height:24px;border-radius:50%;background:${color};border:2px solid #666;cursor:pointer;margin:2px;`;
        dot.onclick = () => {
            document.getElementById('colorPicker').value = color;
            msg(`ç­†è‰²ï¼š${color}`, "info");
        };
        container.appendChild(dot);
    });
}

// ==================== ç•«å¸ƒæ“ä½œ ====================
function clearCanvas() {
    if (confirm("ç¢ºå®šæ¸…ç©ºç•«å¸ƒï¼Ÿ")) {
        pushUndo();
        mainDraw.clear();
        sceneObjects = [];
        updateObjectInfo();
        msg("ç•«å¸ƒå·²æ¸…ç©º", "info");
    }
}

function toggleGrid() {
    isGridOn = !isGridOn;
    const viewport = document.getElementById('viewport');
    viewport.style.backgroundImage = isGridOn ? 
        "linear-gradient(rgba(200,200,200,0.3) 1px, transparent 1px), linear-gradient(90deg, rgba(200,200,200,0.3) 1px, transparent 1px)" : 
        "none";
    viewport.style.backgroundSize = "20px 20px";
    msg(isGridOn ? "æ ¼ç·šå·²é–‹å•Ÿ" : "æ ¼ç·šå·²é—œé–‰", "info");
}

// ==================== åŒ¯å‡ºåŠŸèƒ½ ====================
function exportSVG() {
    const svgContent = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${V_W}" height="${V_H}" viewBox="0 0 ${V_W} ${V_H}">
${mainDraw.svg()}
</svg>`;
    const blob = new Blob([svgContent], { type: 'image/svg+xml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sketch_${Date.now()}.svg`;
    a.click();
    URL.revokeObjectURL(url);
    msg("âœ… SVG åŒ¯å‡ºæˆåŠŸï¼ï¼ˆå‘é‡åœ–ç„¡æç¸®æ”¾ï¼‰", "success");
}

function exportImg() {
    const svgData = new Blob([mainDraw.svg()], { type: 'image/svg+xml;charset=utf-8' });
    const domURL = URL || window.webkitURL || window;
    const url = domURL.createObjectURL(svgData);
    
    const img = new Image();
    img.onload = function() {
        const canvas = document.createElement('canvas');
        canvas.width = V_W;
        canvas.height = V_H;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, V_W, V_H);
        ctx.drawImage(img, 0, 0);
        
        const pngUrl = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = pngUrl;
        a.download = `sketch_${Date.now()}.png`;
        a.click();
        msg("âœ… PNG åŒ¯å‡ºæˆåŠŸï¼", "success");
    };
    img.src = url;
}

function downloadCode() {
    const html = document.documentElement.outerHTML;
    const blob = new Blob([html], { type: 'text/html' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'golden-sketch-full.html';
    a.click();
    msg("âœ… å®Œæ•´ç¨‹å¼ç¢¼å·²ä¸‹è¼‰ï¼", "success");
}

// ==================== AI ç”Ÿæˆ ====================
async function generateAISketch() {
    if (!dynamicApiKey) return msg("âŒ AI é‡‘é‘°æœªè¼‰å…¥", "error");
    
    const prompt = document.getElementById('aiPrompt').value || 'cute cat line art';
    const loading = document.getElementById('loading-overlay');
    loading.style.display = 'flex';
    
    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-001:predict?key=${dynamicApiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                instances: [{ prompt: `simple black line art sketch, white background, ${prompt}` }],
                parameters: { sampleCount: 1 }
            })
        });
        
        const data = await response.json();
        if (data.predictions?.[0]?.bytesBase64Encoded) {
            lastGeneratedB64 = data.predictions[0].bytesBase64Encoded;
            showPreview(`data:image/png;base64,${lastGeneratedB64}`);
            msg("âœ¨ AI åœ–ç‰‡ç”ŸæˆæˆåŠŸï¼", "success");
        }
    } catch (e) {
        msg("AI ç”Ÿæˆå¤±æ•—: " + e.message, "error");
    } finally {
        loading.style.display = 'none';
    }
}

function showPreview(src) {
    document.getElementById('ai-preview-img').src = src;
    document.getElementById('ai-preview-panel').style.display = 'block';
}

function closePreview() {
    document.getElementById('ai-preview-panel').style.display = 'none';
}

function applyPreviewToCanvas() {
    if (!lastGeneratedB64) return;
    pushUndo();
    const img = mainDraw.image(`data:image/png;base64,${lastGeneratedB64}`)
        .size(400, 400).center(V_W/2, V_H/2);
    sceneObjects.push(img);
    refreshEventHandlers();
    closePreview();
    msg("âœ… AI åœ–ç‰‡å·²è¼‰å…¥ï¼", "success");
}

// ==================== çè—åº« ====================
function saveToArchive() {
    const archives = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    archives.unshift({
        id: Date.now(),
        svg: mainDraw.svg(),
        time: new Date().toLocaleString()
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(archives.slice(0, 20)));
    renderArchive();
    msg("ğŸ’¾ å·²å­˜å…¥çè—åº«", "success");
}

function renderArchive() {
    const list = document.getElementById('archive-list');
    const archives = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    
    list.innerHTML = archives.length ? 
        archives.map(a => 
            `<div style="padding:8px;background:white;border-radius:8px;border:1px solid var(--gold-primary);margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;">
                <span>${a.time}</span>
                <div>
                    <button onclick="loadArchive(${a.id})" style="padding:4px 8px;margin-right:4px;border-radius:6px;background:var(--gold-primary);border:none;cursor:pointer;">è¼‰å…¥</button>
                    <button onclick="deleteArchive(${a.id})" style="padding:4px 8px;border-radius:6px;background:#ff4444;color:white;border:none;cursor:pointer;">åˆªé™¤</button>
                </div>
            </div>`
        ).join('') : 
        '<div style="text-align:center;padding:20px;color:#666;">æš«ç„¡çè—ç´€éŒ„</div>';
}

function loadArchive(id) {
    const archives = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    const archive = archives.find(a => a.id === id);
    if (archive) {
        pushUndo();
        mainDraw.clear().svg(archive.svg);
        sceneObjects = Array.from(mainDraw.children());
        refreshEventHandlers();
        updateObjectInfo();
        msg("âœ… å·²è¼‰å…¥çè—", "success");
    }
}

function deleteArchive(id) {
    let archives = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    archives = archives.filter(a => a.id !== id);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(archives));
    renderArchive();
    msg("å·²åˆªé™¤ç´€éŒ„", "info");
}

function clearArchive() {
    if (confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰çè—ï¼Ÿ")) {
        localStorage.removeItem(STORAGE_KEY);
        renderArchive();
        msg("å·²æ¸…ç©ºçè—åº«", "info");
    }
}

// ==================== ç‹€æ…‹æ›´æ–° ====================
function updateLineCount() {
    const lines = document.documentElement.outerHTML.split(/\r?\n/).length;
    document.getElementById('lineInfo').textContent = `è¡Œæ•¸: ${lines}`;
}

function updateObjectInfo() {
    document.getElementById('objInfo').textContent = `ç‰©ä»¶: ${sceneObjects.length}`;
}

// ==================== å…¨è¢å¹• ====================
function toggleFullscreen() {
    const card = document.getElementById('mainCard');
    if (!document.fullscreenElement) {
        card.requestFullscreen().then(() => {
            msg("é€²å…¥å…¨è¢å¹•æ¨¡å¼", "success");
        });
    } else {
        document.exitFullscreen();
        msg("é€€å‡ºå…¨è¢å¹•", "info");
    }
}

const style = document.createElement('style');
style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
document.head.appendChild(style);
</script>
</body>
</html>
