<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é‡‘å¹£è¼ç…Œ Gemini AI å…¨ç’°å¢ƒæ¸¬è©¦å·¥å…·</title>
    <style>
        :root {
            --gold-primary: #ffd700;
            --gold-dark: #b8860b;
            --gold-light: #fffacd;
            --bg-color: #fff8e1;
        }

        /* åš´æ ¼æ§åˆ¶æ–‡å­—å¤§å° 0.5rem */
        * {
            box-sizing: border-box;
            font-size: 0.5rem !important;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: radial-gradient(circle, var(--gold-light) 0%, var(--gold-primary) 100%);
            background-attachment: fixed;
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: #5d4037;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            width: 100vw;
            overflow-x: hidden;
            padding: 10px;
        }

        /* é‡‘å¹£èƒŒæ™¯ */
        body::before {
            content: "ğŸ’°";
            position: fixed;
            font-size: 10rem !important;
            opacity: 0.15;
            z-index: -1;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .container {
            width: 100%;
            max-width: 100%;
            background: rgba(255, 255, 255, 0.93);
            border: 2px solid var(--gold-dark);
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 8px 24px rgba(184, 134, 11, 0.45);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .header {
            text-align: center;
            border-bottom: 2px solid var(--gold-primary);
            padding-bottom: 5px;
        }

        .header h1 {
            font-size: 0.7rem !important;
            color: var(--gold-dark);
            font-weight: bold;
            letter-spacing: 1px;
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        button {
            background: linear-gradient(to bottom, var(--gold-primary), var(--gold-dark));
            border: 1px solid #8b4513;
            color: white;
            padding: 10px 2px;
            border-radius: 6px;
            cursor: pointer;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.4);
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        button:active {
            filter: brightness(0.85);
            transform: scale(0.97);
        }

        #status {
            background: #ffffff;
            border: 1px solid var(--gold-primary);
            padding: 8px;
            min-height: 45px;
            color: #b71c1c;
            border-radius: 4px;
            word-break: break-all;
            line-height: 1.3;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .content-area {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .data-view {
            background: #fdfaf0;
            border: 1px solid #d4a017;
            padding: 10px;
            height: 320px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border-radius: 4px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.06);
        }

        .pagination {
            display: flex;
            justify-content: space-around;
            padding: 6px;
            background: rgba(184, 134, 11, 0.15);
            border-radius: 6px;
        }

        .page-btn {
            background: none;
            border: none;
            color: var(--gold-dark);
            padding: 6px 15px;
            text-decoration: underline;
            cursor: pointer;
        }

        .page-btn.active {
            color: #ffffff;
            background: var(--gold-dark);
            text-decoration: none;
            border-radius: 4px;
        }

        .loader {
            display: none;
            text-align: center;
            font-weight: bold;
            color: #d48806;
            padding: 5px;
            background: #fffbe6;
            border: 1px dashed var(--gold-dark);
            margin: 5px 0;
            border-radius: 4px;
        }

        .line-count {
            position: fixed;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.8);
            color: #ffd700;
            padding: 2px 8px;
            border-radius: 3px;
            z-index: 9999;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Gemini AI å…¨ç’°å¢ƒçµ±ä¸€æ¸¬è©¦å·¥å…· (Hex ä¿®å¾©ç‰ˆ)</h1>
    </div>

    <div id="status">ç³»çµ±å°±ç·’ã€‚ç›®æ¨™ç¶²å€å·²æ›´æ–°ã€‚</div>

    <div class="btn-group">
        <button onclick="fetchDataProcess()">1. ç²å–è³‡æ–™/è½‰ Hex</button>
        <button onclick="pingGeminiApi()">2. é€£ç·šæ¸¬è©¦ (Ping)</button>
        <button onclick="analyzeWithAi()">3. AI çµæ§‹åˆ†æ</button>
        <button onclick="downloadHtml()">ä¸‹è¼‰æ­¤å·¥å…·</button>
    </div>

    <div id="ai-loader" class="loader">æ­£åœ¨é€šè¨Šä¸­ï¼Œè«‹ç¨å€™... (è‹¥é•·æ™‚é–“æœªéŸ¿æ‡‰è«‹æª¢æŸ¥é€£ç·š)</div>

    <div class="content-area">
        <div id="view-data" class="data-view">ç­‰å¾…ç²å–è³‡æ–™...</div>
        <div id="view-ai" class="data-view" style="display:none;">AI çµæœå°‡å‘ˆç¾æ–¼æ­¤ã€‚</div>
    </div>

    <div class="pagination">
        <div class="page-btn active" id="btn-data" onclick="switchTab('data')">è³‡æ–™é è¦½</div>
        <div class="page-btn" id="btn-ai" onclick="switchTab('ai')">AI å ±å‘Š</div>
    </div>
</div>

<div class="line-count" id="lineCountDisplay">ç›®å‰è¡Œæ•¸: 0</div>

<script>
    const APP_CONFIG = {
        // æ›´æ–°ç‚ºç›®æ¨™ API ç¶²å€
        apiUrl: "https://orlandotigereye.github.io/mytestweb/config/api.js",
        geminiModelUrl: "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent",
        apiKey: typeof __api_key !== 'undefined' ? __api_key : "" 
    };

    let cachedRawData = "";

    function updateStatus(msg, isError = false) {
        const statusEl = document.getElementById('status');
        statusEl.innerText = msg;
        statusEl.style.color = isError ? "#d32f2f" : "#b8860b";
    }

    function encodeToHex(str) {
        return "0x" + Array.from(str).map(char => char.charCodeAt(0).toString(16).toUpperCase().padStart(2, '0')).join('');
    }

    async function fetchDataProcess() {
        updateStatus("é€£ç·šè‡³ç›®æ¨™ä½å€æ“·å–ä¸­...");
        try {
            // ä½¿ç”¨ cache-buster é¿å…è¡Œå‹•ç«¯ç·©å­˜å•é¡Œ
            const response = await fetch(`${APP_CONFIG.apiUrl}?nocache=${Date.now()}`);
            if (!response.ok) throw new Error(`HTTP è«‹æ±‚å¤±æ•—: ${response.status}`);
            
            const rawText = await response.text();
            cachedRawData = rawText;

            let resultOutput = "// å…¨ç’°å¢ƒçµ±ä¸€è™•ç† (Key -> Hex)\n// ä¾†æº: " + APP_CONFIG.apiUrl + "\n\n";
            const lines = rawText.split('\n');
            lines.forEach(line => {
                const match = line.match(/^\s*["']?([\w-]+)["']?\s*:/);
                if (match) {
                    const originalKey = match[1];
                    const hexValue = encodeToHex(originalKey);
                    resultOutput += line.replace(originalKey, hexValue) + " // [Hex] " + hexValue + " (åŸ: " + originalKey + ")\n";
                } else {
                    resultOutput += line + "\n";
                }
            });

            document.getElementById('view-data').innerText = resultOutput;
            switchTab('data');
            updateStatus("è³‡æ–™ç²å–ä¸¦è™•ç†å®Œæˆã€‚");
            refreshLineCount();
        } catch (err) {
            updateStatus("ç²å–å¤±æ•—: " + err.message + " (è«‹ç¢ºèª CORS æˆ–ç¶²è·¯ç‹€æ…‹)", true);
        }
    }

    async function callGeminiApi(promptText, systemInstruction = "") {
        const url = `${APP_CONFIG.geminiModelUrl}?key=${APP_CONFIG.apiKey}`;
        const payload = {
            contents: [{ parts: [{ text: promptText }] }]
        };
        if (systemInstruction) {
            payload.systemInstruction = { parts: [{ text: systemInstruction }] };
        }

        let attempt = 0;
        const maxAttempts = 5;

        while (attempt < maxAttempts) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorJson = await response.json();
                    throw new Error(errorJson.error?.message || `HTTP ${response.status}`);
                }

                const resultData = await response.json();
                return resultData.candidates?.[0]?.content?.parts?.[0]?.text || "ç„¡æœ‰æ•ˆå›è¦†";
            } catch (error) {
                attempt++;
                if (attempt >= maxAttempts) throw error;
                const waitTime = Math.pow(2, attempt) * 1000;
                updateStatus(`API é€šè¨Šé‡è©¦ (${attempt}/5)... ${error.message}`);
                await new Promise(resolve => setTimeout(resolve, waitTime));
            }
        }
    }

    async function pingGeminiApi() {
        updateStatus("æ­£åœ¨å˜—è©¦ API é€£ç·šæ¸¬è©¦...");
        const loader = document.getElementById('ai-loader');
        loader.style.display = "block";
        try {
            const response = await callGeminiApi("æ¸¬è©¦è¨Šæ¯ï¼šè«‹ç¢ºèª API é€£ç·šæ˜¯å¦æ­£å¸¸ã€‚");
            document.getElementById('view-ai').innerText = "é€£ç·šæ¸¬è©¦å›å ±ï¼š\n\n" + response;
            switchTab('ai');
            updateStatus("Gemini API é€£ç·šæ¸¬è©¦æˆåŠŸï¼");
        } catch (err) {
            updateStatus("API é€£ç·šå¤±æ•—: " + err.message, true);
        } finally {
            loader.style.display = "none";
            refreshLineCount();
        }
    }

    async function analyzeWithAi() {
        if (!cachedRawData) return updateStatus("è«‹å…ˆåŸ·è¡Œã€Œç²å–è³‡æ–™ã€ï¼", true);
        updateStatus("ç™¼é€è³‡æ–™è‡³ AI åˆ†æä¸­...");
        const loader = document.getElementById('ai-loader');
        loader.style.display = "block";
        try {
            const prompt = `è«‹åˆ†ææ­¤ API è¨­å®šæª”å…§å®¹ä¸¦ç¸½çµå…¶åŠŸèƒ½ï¼š\n\n${cachedRawData}`;
            const sys = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ç³»çµ±æ¶æ§‹å¸«ï¼Œè«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡é€²è¡Œåˆ†æã€‚";
            const response = await callGeminiApi(prompt, sys);
            document.getElementById('view-ai').innerText = "AI çµæ§‹åˆ†æå ±å‘Šï¼š\n\n" + response;
            switchTab('ai');
            updateStatus("AI åˆ†æä»»å‹™å®Œæˆã€‚");
        } catch (err) {
            updateStatus("åˆ†æå‡ºéŒ¯: " + err.message, true);
        } finally {
            loader.style.display = "none";
            refreshLineCount();
        }
    }

    function switchTab(tabId) {
        const dView = document.getElementById('view-data');
        const aView = document.getElementById('view-ai');
        const dBtn = document.getElementById('btn-data');
        const aBtn = document.getElementById('btn-ai');

        if (tabId === 'data') {
            dView.style.display = "block";
            aView.style.display = "none";
            dBtn.classList.add('active');
            aBtn.classList.remove('active');
        } else {
            dView.style.display = "none";
            aView.style.display = "block";
            aBtn.classList.add('active');
            dBtn.classList.remove('active');
        }
    }

    function downloadHtml() {
        try {
            const blob = new Blob([document.documentElement.outerHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'gemini_test_updated.html';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            updateStatus("ç¨‹å¼ç¢¼ä¸‹è¼‰å®Œæˆã€‚");
        } catch (e) {
            updateStatus("ä¸‹è¼‰å¤±æ•—: " + e.message, true);
        }
    }

    function refreshLineCount() {
        const lines = document.documentElement.outerHTML.split('\n').length;
        document.getElementById('lineCountDisplay').innerText = "ç›®å‰è¨ˆç®—å¯¦éš›è¡Œæ•¸: " + lines;
    }

    window.onload = refreshLineCount;
</script>
</body>
</html>

