<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Firebase Email æˆæ¬Šç®¡ç†çµ‚ç«¯</title>

<!-- Firebase v8 SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
body{font-family:system-ui,"Noto Sans TC",sans-serif;background:#fff8dc;padding:14px}
.card{background:#fff;border:2px solid #b8860b;border-radius:10px;padding:12px;margin-bottom:12px}
input,button{width:100%;padding:10px;margin-top:6px;border-radius:6px;border:1px solid #ccc}
button{background:#b8860b;color:#fff;font-weight:bold;border:none}
button.danger{background:#7f1d1d}
.status{padding:8px;border-radius:6px;font-size:13px;margin-top:6px}
.ok{background:#e6fffa;color:#065f46}
.err{background:#fff5f5;color:#9b1c1c}
.hidden{display:none}
pre{background:#111;color:#0f0;padding:10px;border-radius:8px;font-size:11px;max-height:200px;overflow:auto}
</style>
</head>

<body>

<h2>ğŸ” Firebase éƒµä»¶é©—è­‰ç®¡ç†çµ‚ç«¯</h2>

<!-- ç™»å…¥å¡ -->
<div class="card" id="loginCard">
  <input id="email" type="email" placeholder="Email" value="orlandotigereye@gmail.com">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">ç™»å…¥ / è¨»å†Š</button>
  <div id="loginMsg" class="status"></div>
</div>

<!-- é©—è­‰æç¤º -->
<div class="card hidden" id="verifyCard">
  <div class="status err">
    âš ï¸ å°šæœªå®Œæˆ Email é©—è­‰<br>
    è«‹è‡³ä¿¡ç®±é»æ“Šé©—è­‰é€£çµ
  </div>
  <button onclick="sendVerify()">ğŸ“§ é‡æ–°å¯„é€é©—è­‰ä¿¡</button>
  <button onclick="logout()">ç™»å‡º</button>
</div>

<!-- ç®¡ç†ç«¯ -->
<div class="card hidden" id="adminCard">
  <div id="authStatus" class="status ok"></div>
  <button onclick="writeTest()">âœï¸ å¯«å…¥æ¸¬è©¦è³‡æ–™</button>
  <button class="danger" onclick="resetDB()">â™»ï¸ æ¸…ç©º RTDB</button>
</div>

<div class="card hidden" id="dataCard">
  <h4>ğŸ“¦ å³æ™‚è³‡æ–™</h4>
  <pre id="dataView">{}</pre>
</div>

<script>
/* ===== Firebase è¨­å®š ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCWym1iE7Rq2UAiFKhQMNuvHm_sHoCBbbw",
  authDomain: "keepsound-firebase-1c386.firebaseapp.com",
  databaseURL: "https://keepsound-firebase-1c386-default-rtdb.firebaseio.com",
  projectId: "keepsound-firebase-1c386"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* ===== UI refs ===== */
const loginCard = document.getElementById("loginCard");
const verifyCard = document.getElementById("verifyCard");
const adminCard = document.getElementById("adminCard");
const dataCard = document.getElementById("dataCard");
const authStatus = document.getElementById("authStatus");
const dataView = document.getElementById("dataView");
const loginMsg = document.getElementById("loginMsg");

/* ===== ç™»å…¥ / è¨»å†Š ===== */
function login(){
  const email = emailInput.value = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  auth.signInWithEmailAndPassword(email, password)
  .catch(err=>{
    if(err.code === "auth/user-not-found"){
      return auth.createUserWithEmailAndPassword(email, password);
    }
    throw err;
  })
  .catch(e=>{
    loginMsg.className="status err";
    loginMsg.innerText=e.message;
  });
}

/* ===== Auth ç‹€æ…‹ç›£è½ ===== */
auth.onAuthStateChanged(user=>{
  if(!user){
    loginCard.classList.remove("hidden");
    verifyCard.classList.add("hidden");
    adminCard.classList.add("hidden");
    dataCard.classList.add("hidden");
    return;
  }

  if(!user.emailVerified){
    loginCard.classList.add("hidden");
    verifyCard.classList.remove("hidden");
    adminCard.classList.add("hidden");
    dataCard.classList.add("hidden");
    return;
  }

  // âœ… å·²é©—è­‰
  loginCard.classList.add("hidden");
  verifyCard.classList.add("hidden");
  adminCard.classList.remove("hidden");
  dataCard.classList.remove("hidden");

  authStatus.innerText="ç™»å…¥æˆåŠŸï¼š" + user.email;

  // å³æ™‚è³‡æ–™
  db.ref().on("value",snap=>{
    dataView.textContent = JSON.stringify(snap.val()||{},null,2);
  });
});

/* ===== å¯„é€é©—è­‰ä¿¡ ===== */
function sendVerify(){
  auth.currentUser.sendEmailVerification()
  .then(()=>alert("ğŸ“§ é©—è­‰ä¿¡å·²å¯„å‡º"));
}

/* ===== å¯«å…¥ ===== */
function writeTest(){
  db.ref("secureTests").push({
    time:new Date().toISOString(),
    by:auth.currentUser.email
  })
  .then(()=>alert("âœ… å¯«å…¥æˆåŠŸ"))
  .catch(e=>alert("âŒ "+e.message));
}

/* ===== æ¸…ç©º ===== */
function resetDB(){
  if(!confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ"))return;
  db.ref().remove()
  .then(()=>alert("âœ… å·²æ¸…ç©º"))
  .catch(e=>alert("âŒ "+e.message));
}

/* ===== ç™»å‡º ===== */
function logout(){
  auth.signOut();
}
</script>

</body>
</html>
