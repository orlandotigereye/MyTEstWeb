<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>å¤©è±¡æ¸¬è©¦é  V4 - ç¯„æœ¬ç‰ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: system-ui; font-size: 13px; padding: 10px; background:#FFF8E7; color:#5D4037; }
.ok { color: #2ecc71; }
.fail { color: #e74c3c; }
button { margin: 6px 0; padding:5px 10px; cursor:pointer; }
textarea { width:100%; height:120px; margin:6px 0; }
#report { border:1px solid #C5A059; padding:10px; background:#FFFEF0; margin-top:10px; }
.progress { height:8px; background:#EEE; border-radius:4px; overflow:hidden; margin-bottom:6px; }
.progress-inner { height:100%; width:0%; background:#FFD700; transition:width 0.3s; }
</style>

<!-- æ ¸å¿ƒ JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://orlandotigereye.github.io/mytestweb/public/public/core.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</head>
<body>

<h2>ğŸŒŸ å¤©è±¡æ¸¬è©¦é  V4 - ç¯„æœ¬ç‰ˆ</h2>

<h3>ğŸ“¦ æ¨¡çµ„è¼‰å…¥æª¢æŸ¥é¢æ¿</h3>
<div id="status"></div>
<div id="progressContainer"></div>
<button onclick="reInit()">ğŸ”„ é‡æ–°åˆå§‹åŒ–</button>

<h3>ğŸ“Š JSON æ‘˜è¦</h3>
<div id="jsonSummary"></div>

<h3>ğŸ“ è¼¸å…¥è§€æ¸¬å…§å®¹</h3>
<textarea id="obsInput"></textarea>
<button onclick="startAnalyze()">ğŸš€ æ ¸å¿ƒåˆ†æ</button>

<h3>ğŸ–¼ å ±å‘Šå°å‡º</h3>
<div id="report">
  <h3 id="reportTitle">å°šç„¡åˆ†æ</h3>
  <div id="reportContent"></div>
  <button onclick="exportReport()">ğŸ“¥ å°å‡ºå ±å‘Šåœ–</button>
</div>

<script>
/* =====================================================
 é è¨­è§€æ¸¬å…§å®¹ç¯„æœ¬
===================================================== */
const defaultObs = `2025-12-27 08:00 å°åŒ—
è§€æ¸¬å¤©è±¡ï¼š
- æœˆäº®ï¼šä¸Šå¼¦
- å¤ªé™½ä½ç½®ï¼š78.5Â°
- æ°´æ˜Ÿï¼š94.1Â°
- é‡‘æ˜Ÿï¼š81.3Â°
- ç«æ˜Ÿï¼š74.7Â°
- æœ¨æ˜Ÿï¼š240.6Â°
- åœŸæ˜Ÿï¼š2.8Â°
è«‹åˆ†æä»Šæ—¥å¤©è±¡å°äººäº‹å½±éŸ¿ã€‚`;

document.getElementById("obsInput").value = defaultObs;

/* =====================================================
 API Key ç”±é ç«¯æŠ“å–ä¸¦ decodeHex
===================================================== */
let API_KEY = "";
const URL_API = "https://orlandotigereye.github.io/mytestweb/config/api.js";

function decodeHex(hex){
    try{
        let s="";
        for(let i=0;i<hex.length;i+=2) s+=String.fromCharCode(parseInt(hex.substr(i,2),16));
        return s;
    }catch(e){ return ""; }
}

async function fetchApiKey(){
    try{
        const res = await fetch(URL_API);
        const txt = await res.text();
        const match = txt.match(/"([a-fA-F0-9]+)"/);
        if(match && match[1]){
            API_KEY = decodeHex(match[1]);
            console.log("API Key è§£ç¢¼æˆåŠŸ:", API_KEY);
        }else{
            console.warn("æ‰¾ä¸åˆ° Hex API Keyï¼Œè«‹æ‰‹å‹•è¨­å®š");
        }
    }catch(e){
        console.error("æŠ“å– API Key å¤±æ•—:", e);
    }
}

/* =====================================================
 æ¸²æŸ“æ¨¡çµ„ç‹€æ…‹
===================================================== */
function renderStatus() {
  const box = document.getElementById("status");
  const progressContainer = document.getElementById("progressContainer");
  box.innerHTML = "";
  progressContainer.innerHTML = "";
  if(!Core.modules) return;
  Object.entries(Core.modules).forEach(([k,v])=>{
    const d=document.createElement("div");
    d.className = v.status?"ok":"fail";
    d.textContent = `${k}: ${v.status?"OK":"FAILED"}` + (v.err?` (${v.err})`:"");
    box.appendChild(d);

    const prog = document.createElement("div");
    prog.className="progress";
    const inner = document.createElement("div");
    inner.className="progress-inner";
    inner.style.width = v.status?"100%":"0%";
    prog.appendChild(inner);
    progressContainer.appendChild(prog);
  });
}

/* =====================================================
 JSON æ‘˜è¦
===================================================== */
function renderJSONSummary() {
  const summary=document.getElementById("jsonSummary");
  summary.innerHTML="";
  const astroCount = Core.data?.astro?.length ?? 0;
  const cjkCount = Core.data?.cjk?.length ?? 0;
  summary.innerHTML = `<b>æ˜Ÿè±¡è³‡æ–™ç­†æ•¸ï¼š</b>${astroCount}<br><b>CJK å­—å…¸ç­†æ•¸ï¼š</b>${cjkCount}<br>`;
}

/* =====================================================
 é‡æ–°åˆå§‹åŒ–
===================================================== */
async function reInit(){
    document.getElementById("status").textContent="åˆå§‹åŒ–ä¸­...";
    document.getElementById("jsonSummary").textContent="";
    await fetchApiKey(); // å…ˆæŠ“ API Key
    try{
        await Core.initAll();
        renderStatus();
        renderJSONSummary();
    }catch(e){
        document.getElementById("status").textContent="åˆå§‹åŒ–å¤±æ•—: "+e.message;
        console.error(e);
    }
}

/* =====================================================
 æ ¸å¿ƒåˆ†æ
===================================================== */
async function startAnalyze(){
  const input=document.getElementById("obsInput").value.trim();
  if(!input){ alert("è«‹è¼¸å…¥è§€æ¸¬å…§å®¹"); return; }
  if(!Core.data?.astro || !Core.data?.cjk){ alert("è³‡æ–™å°šæœªè¼‰å…¥å®Œæˆ"); return; }
  if(!API_KEY){ alert("API Key å°šæœªå–å¾—"); return; }

  const prompt = `è«‹åˆ†æä»¥ä¸‹å…§å®¹ä¸¦ä»¥ JSON æ ¼å¼å›å‚³ (åŒ…å« title, content)ï¼š\n${input}`;

  document.getElementById("reportTitle").textContent="åˆ†æä¸­...";
  document.getElementById("reportContent").textContent="è«‹ç¨å€™...";

  try{
    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`,
      {method:"POST",
       headers:{"Content-Type":"application/json"},
       body:JSON.stringify({
         contents:[{parts:[{text:prompt}]}],
         generationConfig:{responseMimeType:"application/json"}
       })}
    );
    const data=await res.json();
    const parsed=JSON.parse(data.candidates[0].content.parts[0].text);

    document.getElementById("reportTitle").textContent=parsed.title;
    document.getElementById("reportContent").textContent=parsed.content;
  }catch(e){
    document.getElementById("reportTitle").textContent="åˆ†æå¤±æ•—";
    document.getElementById("reportContent").textContent=e.message;
  }
}

/* =====================================================
 å°å‡ºå ±å‘Šåœ–
===================================================== */
async function exportReport(){
  if(!window.html2canvas){ alert("html2canvas å°šæœªè¼‰å…¥"); return; }
  const el=document.getElementById("report");
  const canvas=await html2canvas(el,{scale:2});
  const link=document.createElement("a");
  link.href=canvas.toDataURL();
  link.download="å¤©è±¡å ±å‘Š.png";
  link.click();
}

/* =====================================================
 é é¢åˆå§‹åŒ–
===================================================== */
reInit();
</script>

</body>
</html>
