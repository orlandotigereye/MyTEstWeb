<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ§¬ æª¢æ¸¬åˆ†æ - Sale3 V3.2</title>
    
    <!-- Dynamic Pathing -->
    <script id="path-helper-loader">
        (function() {
            const paths = ['/01js/path_helper.js', '../../../01js/path_helper.js', '../../01js/path_helper.js', '../01js/path_helper.js'];
            let index = 0;
            function tryNext() {
                if (index >= paths.length) return;
                const script = document.createElement('script');
                script.src = paths[index];
                script.async = false;
                script.onerror = function() {
                    if (script.parentNode) document.head.removeChild(script);
                    index++;
                    tryNext();
                };
                script.onload = function() { console.log('Path Helper active: ' + paths[index]); };
                document.head.appendChild(script);
            }
            tryNext();
        })();
    </script>

    <!-- 1. CSS Layer -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <style>
        .chart-box { width: 100%; max-width: 320px; margin: 10px auto; background: #fff; padding: 15px; border-radius: 12px; border: 2px solid var(--accent-light); }
        .record-card { border-bottom: 1px solid #eee; padding: 12px 0; }
        .tag { font-size: 10px; background: var(--accent-dark); color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    </style>

    <!-- 2. Fixed Data Layer -->
    <script>
        const TEST_CONFIG = {
            KEYS: { TESTS: 'sale3_tests', CURRENT: 'currentUser' }
        };
    </script>

    <!-- 3. Script Layer -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let healthChart = null;

        function fetchAPIReport() {
            const serial = document.getElementById('serial-id').value;
            if(!serial) return APP_CORE.showToast('è«‹è¼¸å…¥æª¢æ¸¬å–®è™Ÿ 2-1');
            
            APP_CORE.toggleSpinner('æ­£åœ¨å¾ API ç²å–æª¢æ¸¬å ±å‘Š 2-1...');
            setTimeout(() => {
                const user = APP_CORE.getLocal(TEST_CONFIG.KEYS.CURRENT);
                const report = {
                    id: 'T' + Date.now(),
                    userId: user.id,
                    serial: serial,
                    date: new Date().toISOString(),
                    type: 'è„‚è‚ªé…¸æ•¸æ“šåˆ†æ 2-2',
                    results: [75, 82, 68, 90, 85], // è„‚è‚ªé…¸æŒ‡æ¨™æ¨¡æ“¬
                    summary: 'è„‚è‚ªé…¸å¹³è¡¡åº¦è‰¯å¥½ï¼Œå»ºè­°è£œå…… Omega-3ã€‚'
                };
                const tests = APP_CORE.getLocal(TEST_CONFIG.KEYS.TESTS);
                tests.push(report);
                APP_CORE.saveLocal(TEST_CONFIG.KEYS.TESTS, tests);
                APP_CORE.toggleSpinner(false);
                APP_CORE.showToast('å ±å‘Šç²å–æˆåŠŸ');
                renderHistory();
                switchTab('historyTab');
            }, 1500);
        }

        function renderHistory() {
            const user = APP_CORE.getLocal(TEST_CONFIG.KEYS.CURRENT);
            const tests = APP_CORE.getLocal(TEST_CONFIG.KEYS.TESTS).filter(t => t.userId === user.id).reverse();
            const list = document.getElementById('record-list');
            
            if (tests.length > 0) renderRadar(tests[0]);
            
            list.innerHTML = tests.map(t => `
                <div class="record-card">
                    <div style="display:flex; justify-content:space-between"><b>å–®è™Ÿï¼š${t.serial}</b> <span class="tag">æŸ¥çœ‹çµæœ/é›·é”åœ– 2-2</span></div>
                    <div style="font-size:11px; color:#666; margin-top:5px;">é¡åˆ¥ï¼š${t.type}<br/>çµè«–ï¼š${t.summary}</div>
                    <button class="btn-gold" style="width:100%; margin-top:8px; font-size:10px;" onclick="location.href='../ecommerce/ShopA.html'">æˆ‘è¦æ”¹å–„</button>
                    <button class="btn-gold" style="width:100%; margin-top:5px; font-size:10px;" onclick="location.href='../expert/ConsultA.html'">æˆ‘è¦è«®è©¢</button>
                </div>
            `).join('') || '<p style="text-align:center; padding:20px;">å°šç„¡æª¢æ¸¬è³‡æ–™</p>';
        }

        function renderRadar(t) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            if (healthChart) healthChart.destroy();
            healthChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['é£½å’Œè„‚è‚ª', 'å–®å…ƒä¸é£½å’Œ', 'å¤šå…ƒä¸é£½å’Œ', 'Omega-3', 'Omega-6'],
                    datasets: [{ data: t.results, backgroundColor: 'rgba(184, 134, 11, 0.2)', borderColor: '#B8860B' }]
                },
                options: { plugins: { legend: { display: false } }, scales: { r: { min: 0, max: 100, ticks: { display: false } } } }
            });
        }

        window.addEventListener('coreReady', () => { renderHistory(); });
    </script>
</head>
<body>
    <div class="tabs-container">
        <button class="tab-btn active" onclick="switchTab('historyTab')"><i class="fas fa-chart-area"></i> æŸ¥çœ‹åˆ†æ 2-2</button>
        <button class="tab-btn" onclick="switchTab('apiTab')"><i class="fas fa-file-import"></i> ç²å–å ±å‘Š 2-1</button>
        <button class="tab-btn" onclick="location.href='../indexA.html'"><i class="fas fa-home"></i> è¿”å›</button>
    </div>

    <div id="historyTab" class="content-section active">
        <div class="card">
            <h2>ğŸ§¬ è„‚è‚ªé…¸æ•¸æ“šåˆ†æ 2-2</h2>
            <div class="chart-box"><canvas id="radarChart"></canvas></div>
            <div id="record-list"></div>
        </div>
    </div>

    <div id="apiTab" class="content-section">
        <div class="card">
            <h2>ğŸ§¬ è¼¸å…¥æª¢æ¸¬å–®è™Ÿ 2-1</h2>
            <div style="margin-bottom:15px">
                <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px;">è«‹è¼¸å…¥æª¢æ¸¬æµæ°´è™Ÿï¼š</label>
                <input type="text" id="serial-id" class="input-gold" placeholder="ä¾‹å¦‚ï¼šFA-2026-X">
            </div>
            <button class="btn-gold" style="width:100%; padding:12px;" onclick="fetchAPIReport()">API ç²å–æª¢æ¸¬å ±å‘Š 2-1</button>
        </div>
    </div>
</body>
</html>