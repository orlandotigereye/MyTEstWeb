<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ‘©â€âš•ï¸ å°ˆå®¶è«®è©¢ - Sale3 V3.2</title>
    
    <!-- Dynamic Pathing -->
    <script id="path-helper-loader">
        (function() {
            const paths = ['/01js/path_helper.js', '../../../01js/path_helper.js', '../../01js/path_helper.js', '../01js/path_helper.js'];
            let index = 0;
            function tryNext() {
                if (index >= paths.length) return;
                const script = document.createElement('script');
                script.src = paths[index];
                script.async = false;
                script.onerror = function() {
                    if (script.parentNode) document.head.removeChild(script);
                    index++;
                    tryNext();
                };
                script.onload = function() { console.log('Path Helper active: ' + paths[index]); };
                document.head.appendChild(script);
            }
            tryNext();
        })();
    </script>

    <!-- 1. CSS Layer -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <style>
        .consult-item { border: 1px solid #eee; padding: 12px; margin-bottom: 12px; border-radius: 8px; background: #fff; position: relative; }
        .status-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white; background: #999; }
        .status-rd { background: #1890ff; }
        .status-advice { background: #52c41a; }
        .advice-content { background: #f6ffed; border: 1px solid #b7eb8f; padding: 10px; margin-top: 10px; font-size: 12px; }
    </style>

    <!-- 2. Fixed Data Layer -->
    <script>
        const CONSULT_CONFIG = {
            KEYS: { CONSULTS: 'sale3_consults', CURRENT: 'currentUser' }
        };
    </script>

    <!-- 3. Script Layer -->
    <script>
        let user = null;

        function applyConsult() {
            const type = document.getElementById('service-type').value;
            const time = document.getElementById('apply-time').value;
            if(!time) return APP_CORE.showToast('è«‹é¸æ“‡é ç´„æ™‚é–“');

            const all = APP_CORE.getLocal(CONSULT_CONFIG.KEYS.CONSULTS);
            const newCase = {
                id: 'C' + Date.now(),
                userId: user.id,
                type: type,
                time: time,
                status: 'pending', // é¸æ“‡æœå‹™é¡å‹ 2-3
                rdName: null,
                advice: null,
                createdAt: new Date().toISOString()
            };
            all.push(newCase);
            APP_CORE.saveLocal(CONSULT_CONFIG.KEYS.CONSULTS, all);
            APP_CORE.showToast('é ç´„å·²é€å‡ºï¼Œç­‰å¾…ç‡Ÿé¤Šå¸«æ¥å–®');
            renderCases();
            switchTab('historyTab');
        }

        function renderCases() {
            const all = APP_CORE.getLocal(CONSULT_CONFIG.KEYS.CONSULTS);
            const myCases = all.filter(c => c.userId === user.id).reverse();
            const list = document.getElementById('case-list');

            list.innerHTML = myCases.map(c => `
                <div class="consult-item">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <b style="font-size:12px;">é¡åˆ¥ï¼š${c.type}</b>
                        <span class="status-badge ${c.status === 'accepted' ? 'status-rd' : (c.status === 'replied' ? 'status-advice' : '')}">
                            ${c.status === 'accepted' ? 'ç‡Ÿé¤Šå¸«æ¥å–®/å›è¦†æ™‚é–“' : (c.status === 'replied' ? 'æŸ¥çœ‹è«®è©¢å…§å®¹ 2-4' : 'ç­‰å¾…æ¥å–®')}
                        </span>
                    </div>
                    <div style="font-size:11px; color:#666;">é ç´„æ™‚é–“ï¼š${c.time}</div>
                    ${c.status === 'accepted' ? `
                        <div class="advice-content" style="background:#e6f7ff; border-color:#91d5ff;">
                            <b>æºé€šä¸¦å¡«å¯«è«®è©¢å…§å®¹ï¼š</b><br/>ç‡Ÿé¤Šå¸« ${c.rdName} å·²èˆ‡æ‚¨è¯ç¹«ï¼Œå°‡æ–¼ 2 å¤©å…§ä¸Šå‚³æ­£å¼å»ºè­°ã€‚
                        </div>
                    ` : ''}
                    ${c.status === 'replied' ? `
                        <div class="advice-content">
                            <b>æŸ¥çœ‹è«®è©¢å…§å®¹ 2-4ï¼š</b><br/>${c.advice}
                            <hr style="border:none; border-top:1px dashed #b7eb8f; margin:8px 0;">
                            <button class="btn-gold" style="width:100%; font-size:10px; height:28px;" onclick="location.href='../ecommerce/ShopA.html?suggested=true'">è¨‚è³¼å»ºè­°å•†å“/ç‡Ÿé¤Šå¸«æœå‹™</button>
                        </div>
                    ` : ''}
                </div>
            `).join('') || '<p style="text-align:center; padding:20px;">å°šç„¡è«®è©¢ç´€éŒ„</p>';
        }

        window.addEventListener('coreReady', () => {
            user = APP_CORE.getLocal(CONSULT_CONFIG.KEYS.CURRENT);
            renderCases();
        });
    </script>
</head>
<body>
    <div class="tabs-container">
        <button class="tab-btn active" onclick="switchTab('applyTab')"><i class="fas fa-calendar-plus"></i> é ç´„è«®è©¢ 2-3</button>
        <button class="tab-btn" onclick="switchTab('historyTab')"><i class="fas fa-clipboard-list"></i> è«®è©¢å…§å®¹ 2-4</button>
        <button class="tab-btn" onclick="location.href='../indexA.html'"><i class="fas fa-home"></i> è¿”å›</button>
    </div>

    <div id="applyTab" class="content-section active">
        <div class="card">
            <h2>ğŸ‘©â€âš•ï¸ é¸æ“‡æœå‹™é¡å‹ 2-3</h2>
            <div style="margin-bottom:12px;">
                <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px;">æœå‹™é¡å‹ï¼š</label>
                <select id="service-type" class="input-gold" style="height:40px;">
                    <option value="è„‚è‚ªé…¸æ”¹å–„è«®è©¢">è„‚è‚ªé…¸æ”¹å–„è«®è©¢</option>
                    <option value="å‚™å­•ç‡Ÿé¤Šè«®è©¢">å‚™å­•ç‡Ÿé¤Šè«®è©¢</option>
                    <option value="æ—¥å¸¸è†³é£Ÿè¦åŠƒ">æ—¥å¸¸è†³é£Ÿè¦åŠƒ</option>
                </select>
            </div>
            <div style="margin-bottom:12px;">
                <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px;">é¸æ“‡æ™‚é–“/ç‡Ÿé¤Šå¸«ï¼š</label>
                <input type="datetime-local" id="apply-time" class="input-gold">
            </div>
            <button class="btn-gold" style="width:100%; padding:12px;" onclick="applyConsult()">æäº¤é ç´„</button>
        </div>
    </div>

    <div id="historyTab" class="content-section">
        <div class="card">
            <h2>ğŸ‘©â€âš•ï¸ æŸ¥çœ‹è«®è©¢å…§å®¹ 2-4</h2>
            <div id="case-list"></div>
        </div>
    </div>
</body>
</html>