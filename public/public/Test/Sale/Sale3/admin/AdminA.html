<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ’» å…¬å¸å¾Œå° - Sale3 V3.2 ç®¡ç†ç³»çµ±</title>
    
    <!-- Dynamic Pathing -->
    <script id="path-helper-loader">
        (function() {
            const paths = ['/01js/path_helper.js', '../01js/path_helper.js', '../../01js/path_helper.js', '../../../01js/path_helper.js'];
            let index = 0;
            function tryNext() {
                if (index >= paths.length) return;
                const script = document.createElement('script');
                script.src = paths[index];
                script.async = false;
                script.onerror = function() {
                    if (script.parentNode) document.head.removeChild(script);
                    index++;
                    tryNext();
                };
                script.onload = function() { console.log('Path Helper active: ' + paths[index]); };
                document.head.appendChild(script);
            }
            tryNext();
        })();
    </script>

    <!-- 1. CSS Layer (Handled by path_helper.js) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <style>
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: #fff; border: 1px solid #ddd; padding: 12px; border-radius: 8px; text-align: center; }
        .stat-num { font-size: 20px; font-weight: bold; color: var(--accent-dark); }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; font-size: 11px; }
        .p-thumb { width: 40px; height: 40px; background: #eee; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 18px; color: var(--accent-dark); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 5000; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: white; width: 100%; max-width: 400px; padding: 20px; border-radius: 12px; }
        .food-item { padding: 10px; border-bottom: 1px dashed #ddd; display: flex; justify-content: space-between; font-size: 11px; background: #fff; }
        .log-card { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 10px; margin-bottom: 10px; }
    </style>

    <!-- 2. Fixed Data Layer -->
    <script>
        const ADMIN_CONFIG = {
            KEYS: { USERS: 'sale3_users', TESTS: 'sale3_tests', CONSULTS: 'sale3_consults', ORDERS: 'sale3_orders', PRODUCTS: 'sale3_products', FOODS: 'sale3_foods', IDEAL: 'sale3_ideal' }
        };
    </script>

    <!-- 3. Script Layer -->
    <script>
        function loadStats() {
            document.getElementById('cnt-u').innerText = APP_CORE.getLocal(ADMIN_CONFIG.KEYS.USERS).length;
            document.getElementById('cnt-t').innerText = APP_CORE.getLocal(ADMIN_CONFIG.KEYS.TESTS).length;
            document.getElementById('cnt-o').innerText = APP_CORE.getLocal(ADMIN_CONFIG.KEYS.ORDERS).length;
        }

        function renderLogs() {
            const users = APP_CORE.getLocal(ADMIN_CONFIG.KEYS.USERS);
            const orders = APP_CORE.getLocal(ADMIN_CONFIG.KEYS.ORDERS);
            const consults = APP_CORE.getLocal(ADMIN_CONFIG.KEYS.CONSULTS);
            const list = document.getElementById('member-list-h2');
            list.innerHTML = users.map(u => {
                const uOrders = orders.filter(o => o.userId === u.id);
                const uConsults = consults.filter(c => c.userId === u.id);
                return `<div class="log-card"><div style="font-weight:bold; border-bottom:1px solid #f0f0f0; padding-bottom:5px; margin-bottom:5px;">${u.name} <span style="font-weight:normal; font-size:10px; color:#999;">(${u.role})</span></div><div style="font-size:11px; color:#666;"><i class="fas fa-shopping-cart"></i> è³¼ç‰©ç´€éŒ„ï¼š${uOrders.length} ç­†<br/><i class="fas fa-user-md"></i> è«®è©¢ç´€éŒ„ï¼š${uConsults.length} ç­†</div></div>`;
            }).join('') || '<p style="text-align:center; color:#999;">ç„¡æœƒå“¡è³‡æ–™</p>';
        }

        function renderProducts() {
            const products = APP_CORE.getLocal(ADMIN_CONFIG.KEYS.PRODUCTS);
            document.getElementById('product-list-admin').innerHTML = products.map(p => `
                <div class="item-row"><div style="display:flex; align-items:center;"><div class="p-thumb"><i class="fas fa-box"></i></div><div><b>${p.name}</b><br/><span style="color:var(--accent-dark)">$${p.price}</span></div></div><div><i class="fas fa-edit" style="color:#1890ff; cursor:pointer; margin-right:12px;" onclick="openEditProduct('${p.id}')"></i><i class="fas fa-trash-alt" style="color:#ff4d4f; cursor:pointer;" onclick="deleteProduct('${p.id}')"></i></div></div>
            `).join('') || '<p style="text-align:center; padding:20px;">å°šç„¡å•†å“è³‡æ–™</p>';
        }

        function openAddProduct() {
            document.getElementById('modal-title').innerText = "æ–°å¢å•†å“";
            document.getElementById('p-id').value = ""; document.getElementById('p-name').value = ""; document.getElementById('p-price').value = ""; document.getElementById('p-tags').value = "";
            document.getElementById('productModal').style.display = "flex";
        }

        function openEditProduct(id) {
            const p = APP_CORE.getLocal(ADMIN_CONFIG.KEYS.PRODUCTS).find(x => x.id === id);
            document.getElementById('modal-title').innerText = "ç·¨è¼¯å•†å“";
            document.getElementById('p-id').value = p.id; document.getElementById('p-name').value = p.name; document.getElementById('p-price').value = p.price; document.getElementById('p-tags').value = (p.tags || []).join(',');
            document.getElementById('productModal').style.display = "flex";
        }

        function saveProduct() {
            const id = document.getElementById('p-id').value; const name = document.getElementById('p-name').value; const price = parseInt(document.getElementById('p-price').value);
            if(!name || isNaN(price)) return APP_CORE.showToast('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
            const products = APP_CORE.getLocal(ADMIN_CONFIG.KEYS.PRODUCTS);
            const newP = { id: id || 'P' + Date.now(), name, price, tags: document.getElementById('p-tags').value.split(',').map(t => t.trim()), desc: "ç®¡ç†è€…ç¶­è­·" };
            if (id) { const idx = products.findIndex(x => x.id === id); products[idx] = newP; } else { products.push(newP); }
            APP_CORE.saveLocal(ADMIN_CONFIG.KEYS.PRODUCTS, products); document.getElementById('productModal').style.display = "none"; renderProducts(); APP_CORE.showToast('åŒæ­¥æˆåŠŸ');
        }

        function deleteProduct(id) { if(confirm('åˆªé™¤ï¼Ÿ')) { const products = APP_CORE.getLocal(ADMIN_CONFIG.KEYS.PRODUCTS).filter(x => x.id !== id); APP_CORE.saveLocal(ADMIN_CONFIG.KEYS.PRODUCTS, products); renderProducts(); } }

        // --- ç†æƒ³æ¸…å–®é¡¯ç¤ºé‚è¼¯ ---
        function showIdealList() {
            const cat = document.getElementById('ideal-category').value;
            const all = APP_CORE.getLocal(ADMIN_CONFIG.KEYS.IDEAL);
            const filtered = cat === 'ALL' ? all : all.filter(f => f.type === cat);
            document.getElementById('ideal-list-container').innerHTML = filtered.map(f => `
                <div style="padding:6px; border-bottom:1px solid #e6f7ff; font-size:11px; display:flex; justify-content:space-between;">
                    <span><b>${f.name}</b> <span style="color:#1890ff;">[${f.major}]</span></span>
                    <span style="color:#666;">${f.ratio}</span>
                </div>
            `).join('') || '<p style="text-align:center;">ç„¡è³‡æ–™</p>';
        }

        function runFoodMatch() {
            const target = document.getElementById('match-acid').value;
            const allFoods = APP_CORE.getLocal(ADMIN_CONFIG.KEYS.FOODS);
            let filtered = (target === 'SFA') ? allFoods.filter(f => f.major === 'ä½è„‚' || f.major === 'æ©Ÿèƒ½') : allFoods.filter(f => f.major === target);
            document.getElementById('food-list-container').innerHTML = filtered.map(f => `
                <div class="food-item"><span><b>${f.name}</b> (${f.type})</span><span style="color:#B8860B; font-weight:bold;">${f.value}</span></div>
            `).join('') || '<p style="text-align:center; padding:20px;">ç„¡é…å°çµæœ</p>';
            APP_CORE.showToast(`å·²é…å° ${filtered.length} é …å»ºè­°`);
        }

        function renderCases() {
            const all = APP_CORE.getLocal(ADMIN_CONFIG.KEYS.CONSULTS);
            const pending = all.filter(c => c.status === 'pending');
            document.getElementById('case-list').innerHTML = pending.map(c => `
                <div class="item-row"><div><b>å®¢æˆ¶ï¼š${c.userId}</b><br/><span style="font-size:10px; color:#888;">${c.userQuery}</span></div><button class="btn-gold" style="padding:2px 10px; font-size:10px;" onclick="acceptCase('${c.id}')">ç‡Ÿé¤Šå¸«æ¥å–®</button></div>
            `).join('') || '<p style="text-align:center; padding:10px;">ç„¡å¾…æ¥æ¡ˆä»¶</p>';
            const accepted = all.filter(c => c.status === 'accepted');
            document.getElementById('work-list').innerHTML = accepted.map(c => `
                <div style="padding:10px; border-bottom:1px solid #eee; background:#fff; margin-bottom:10px; border-radius:8px;"><b>é€²è¡Œä¸­ï¼š${c.userId}</b><br/><div style="font-size:11px; background:#f9f9f9; padding:5px; margin:5px 0;">æå•ï¼š${c.userQuery}</div><textarea id="reply-${c.id}" class="input-gold" style="height:60px; font-size:11px; margin-top:5px;" placeholder="æ’°å¯«å»ºè­°..."></textarea><button class="btn-gold" style="width:100%; margin-top:5px; font-size:10px;" onclick="finishCase('${c.id}')">æäº¤å»ºè­° 2-4</button></div>
            `).join('') || '<p style="text-align:center; padding:10px;">ç„¡é€²è¡Œä¸­æ¡ˆä»¶</p>';
        }

        function acceptCase(id) { const all = APP_CORE.getLocal(ADMIN_CONFIG.KEYS.CONSULTS); const c = all.find(x => x.id === id); c.status = 'accepted'; c.rdName = 'æ—ç‡Ÿé¤Šå¸«'; APP_CORE.saveLocal(ADMIN_CONFIG.KEYS.CONSULTS, all); APP_CORE.showToast('å·²æ¥å–® G2'); renderCases(); }
        function finishCase(id) { const advice = document.getElementById(`reply-${id}`).value; if(!advice) return APP_CORE.showToast('è«‹è¼¸å…¥å»ºè­°'); const all = APP_CORE.getLocal(ADMIN_CONFIG.KEYS.CONSULTS); const c = all.find(x => x.id === id); c.status = 'replied'; c.rdAdvice = "æŸ¥çœ‹è«®è©¢å…§å®¹ 2-4ï¼š" + advice; APP_CORE.saveLocal(ADMIN_CONFIG.KEYS.CONSULTS, all); APP_CORE.showToast('å›è¦†å·²ç™¼é€'); renderCases(); renderLogs(); }

        window.addEventListener('coreReady', () => { loadStats(); renderProducts(); renderCases(); renderLogs(); showIdealList(); });
    </script>
</head>
<body>
    <div class="tabs-container">
        <button class="tab-btn active" onclick="switchTab('statTab')"><i class="fas fa-chart-line"></i> çµ±è¨ˆ H1</button>
        <button class="tab-btn" onclick="switchTab('logTab')"><i class="fas fa-history"></i> ç´€éŒ„ H2</button>
        <button class="tab-btn" onclick="switchTab('prodTab')"><i class="fas fa-boxes"></i> å•†å“</button>
        <button class="tab-btn" onclick="switchTab('matchTab')"><i class="fas fa-database"></i> é…å°åº«</button>
        <button class="tab-btn" onclick="switchTab('replyTab')"><i class="fas fa-edit"></i> å›è¦† G2</button>
        <button class="tab-btn" onclick="location.href='../indexA.html'"><i class="fas fa-home"></i> è¿”å›</button>
    </div>

    <div id="statTab" class="content-section active"><div class="card"><h2>ğŸ’» æ•¸æ“šçµ±è¨ˆ H1</h2><div class="stat-grid"><div class="stat-card"><div class="stat-num" id="cnt-u">0</div><div>ç¸½æœƒå“¡</div></div><div class="stat-card"><div class="stat-num" id="cnt-t">0</div><div>ç¸½æª¢æ¸¬</div></div><div class="stat-card" style="grid-column: span 2;"><div class="stat-num" id="cnt-o">0</div><div>ç¸½è¨‚å–®</div></div></div></div></div>
    <div id="logTab" class="content-section"><div class="card"><h2>ğŸ’» æœƒå“¡/è«®è©¢/è³¼ç‰©ç´€éŒ„ H2</h2><div id="member-list-h2" style="background:#fafafa; border-radius:8px; border:1px solid #eee; padding:10px;"></div></div></div>
    <div id="prodTab" class="content-section"><div class="card"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;"><h2 style="margin:0;"><i class="fas fa-list"></i> å•†å“ç®¡ç†</h2><button class="btn-gold" style="padding:4px 8px; font-size:10px;" onclick="openAddProduct()">æ–°å¢</button></div><div id="product-list-admin" style="background:#fafafa; border-radius:8px; border:1px solid #eee;"></div></div></div>
    
    <div id="matchTab" class="content-section">
        <div class="card">
            <h2>ğŸ’» ç†æƒ³è„‚è‚ªé…¸æ¯”ä¾‹æ¸…å–® (57ç¨®)</h2>
            <select id="ideal-category" class="input-gold" style="height:35px; margin-bottom:10px;" onchange="showIdealList()">
                <option value="ALL">å…¨éƒ¨é¡åˆ¥ (57)</option>
                <option value="é­šé¡">é­šé¡</option><option value="æ²¹è„‚">æ²¹è„‚</option><option value="å …æœç¨®å­">å …æœç¨®å­</option><option value="è‚‰é¡">è‚‰é¡</option><option value="ä¹³å“è›‹é¡">ä¹³å“è›‹é¡</option><option value="è”¬æœå…¨ç©€">è”¬æœå…¨ç©€</option><option value="æ©Ÿèƒ½è£œçµ¦">æ©Ÿèƒ½è£œçµ¦</option>
            </select>
            <div id="ideal-list-container" style="max-height:200px; overflow-y:auto; background:#f0f5ff; border-radius:8px; border:1px solid #91d5ff; padding:10px; margin-bottom:15px;"></div>
            <hr>
            <h2>ğŸ’» è„‚è‚ªé…¸æ•¸æ“šé…å°å»ºè­°</h2>
            <div style="display:flex; gap:10px; margin-bottom:10px;"><select id="match-acid" class="input-gold" style="flex:1;"><option value="Omega-3">é…å° Omega-3 ç¼ºä¹</option><option value="MUFA">é…å° MUFA éœ€æ±‚</option><option value="SFA">é…å° SFA éé«˜</option></select><button class="btn-gold" onclick="runFoodMatch()">åŸ·è¡Œé…å°</button></div>
            <div id="food-list-container" style="max-height:150px; overflow-y:auto; background:#fafafa; border-radius:8px; border:1px solid #eee; padding:10px;"></div>
        </div>
    </div>

    <div id="replyTab" class="content-section"><div class="card"><h2>ğŸ’» æ•´ç†æ’°å¯«å›è¦† G2/G3</h2><div id="case-list"></div><hr><h3>é€²è¡Œä¸­å€‹æ¡ˆ</h3><div id="work-list"></div></div></div>
    <div id="productModal" class="modal"><div class="modal-content card"><h2>å•†å“ç·¨è¼¯</h2><input type="hidden" id="p-id"><div style="margin-bottom:10px;"><label style="font-size:11px;">åç¨±</label><input type="text" id="p-name" class="input-gold"></div><div style="margin-bottom:10px;"><label style="font-size:11px;">åƒ¹æ ¼</label><input type="number" id="p-price" class="input-gold"></div><div style="margin-bottom:10px;"><label style="font-size:11px;">æ¨™ç±¤</label><input type="text" id="p-tags" class="input-gold"></div><div style="display:flex; gap:10px; margin-top:20px;"><button class="btn-gold" style="flex:1;" onclick="saveProduct()">å„²å­˜</button><button class="btn-gold" style="flex:1; background:#999;" onclick="document.getElementById('productModal').style.display='none'">å–æ¶ˆ</button></div></div></div>
</body>
</html>