<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shizuku Bio-Sync V8.3 - ğŸ’ çš‡å®¶å¤§ä¸€çµ±æ——è‰¦ç‰ˆ (Sale7)</title>
    
    <!-- Firebase SDK (Compat v9) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    
    <!-- 1. CSS å±¤ (çš‡å®¶æ——è‰¦å…¨å…§åµŒ) -->
    <style>
        :root {
            --primary-color: #2c3e50; --accent-color: #FFD700; --accent-dark: #B8860B;
            --accent-light: #FFFACD; --bg-gradient: radial-gradient(circle, #fdf5e6 0%, #ffd700 100%);        
            --card-bg: rgba(255, 255, 255, 0.98); --text-color: #5d4037; --muted-color: #7f8c8d;
            --success-color: #27ae60; --space-sm: 8px; --space-md: 12px; --radius-md: 15px;
            --base-font-size: 13px; --main-font: 'Segoe UI', 'Noto Sans TC', sans-serif;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }      
        body { font-family: var(--main-font); font-size: var(--base-font-size); background: var(--bg-gradient); background-attachment: fixed; color: var(--text-color); margin: 0; line-height: 1.4; overflow-x: hidden; }
        
        .tabs-container { display: flex; background: var(--accent-dark); position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); overflow-x: auto; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; color: rgba(255,255,255,0.8); font-size: 9px; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; min-width: 55px; transition: 0.3s; }
        .tab-btn.active { color: #fff; background: rgba(255,255,255,0.15); border-bottom: 3px solid #fff; }
        
        .content-section { display: none; padding: 10px; animation: fadeIn 0.3s ease; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { background: var(--card-bg); border: 2px solid var(--accent-dark); border-radius: var(--radius-md); padding: 15px; margin-bottom: 10px; box-shadow: 0 4px 15px rgba(184, 134, 11, 0.15); }
        .card h2 { margin-top: 0; font-size: 15px; color: var(--accent-dark); border-bottom: 1px solid var(--accent-dark); padding-bottom: 5px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        
        .btn-gold { background: linear-gradient(to bottom, var(--accent-color), var(--accent-dark)); color: #fff; border: 1px solid #8b4513; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 6px; text-shadow: 1px 1px 1px rgba(0,0,0,0.2); }
        .btn-gold:active { transform: scale(0.95); }
        
        /* åˆ†æçµ„ä»¶ */
        .diag-box { border-left: 4px solid var(--success-color); background: #fafffa; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .comp-bar-container { background: #eee; height: 10px; border-radius: 5px; margin: 5px 0; overflow: hidden; }
        .comp-bar { height: 100%; transition: 0.5s; }
        .trend-chart { display: flex; align-items: flex-end; gap: 8px; height: 100px; padding: 10px; background: #fff; border: 1px solid #eee; border-radius: 10px; }
        .trend-bar { flex: 1; background: var(--accent-dark); border-radius: 3px 3px 0 0; position: relative; min-width: 12px; transition: 0.5s; }
        .trend-val { position: absolute; top: -12px; width: 100%; text-align: center; font-size: 8px; font-weight: bold; }

        /* é …ç›®ç¶²æ ¼ */
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .item-card { background: #fff; border: 1px solid #eee; padding: 10px; border-radius: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .item-card img { width: 100%; height: 90px; object-fit: cover; border-radius: 8px; margin-bottom: 8px; background: #f9f9f9; }
        
        /* DBMS æ¨£å¼ */
        .db-item { background: #fff; border-left: 5px solid var(--accent-dark); padding: 10px; margin-bottom: 8px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); font-size: 11px; }
        pre { font-size: 9px; background: #272822; color: #f8f8f2; padding: 8px; border-radius: 6px; overflow-x: auto; margin-top: 8px; max-height: 120px; border: 1px solid #444; }
        .thumb-preview { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 1px solid var(--accent-dark); margin-right: 10px; }
        .search-bar { background: #fff; border: 2px solid var(--accent-dark); border-radius: 10px; padding: 5px 10px; display: flex; align-items: center; margin-bottom: 10px; }
        .search-bar input { border: none; background: transparent; padding: 5px; font-size: 13px; width: 100%; outline: none; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 5000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: #fff; width: 95%; max-width: 500px; padding: 15px; border-radius: 15px; border: 4px solid var(--accent-dark); max-height: 90vh; overflow-y: auto; }
        textarea { width: 100%; height: 250px; font-family: monospace; font-size: 12px; background: #fffdf0; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
        
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(44, 62, 80, 0.95); color: white; padding: 10px 20px; border-radius: 25px; z-index: 9999; font-size: 12px; display: none; }
        .spinner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); display: none; justify-content: center; align-items: center; z-index: 9000; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent-dark); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <!-- 2. JS å±¤ -->
    <script>
        const APP_CORE = {
            version: "8.3.0-Sale7-Flagship-Ultimate",
            firebaseConfig: {
                apiKey: "AIzaSyCdtLo2glycCj2SwxlS-PVsYVyBjQ5hJMo",
                authDomain: "open-json.firebaseapp.com",
                projectId: "open-json",
                storageBucket: "open-json.firebasestorage.app",
                messagingSenderId: "210389093947",
                appId: "1:210389093947:web:ab91992676db8618e3961e"
            },
            init() {
                this.setupTabs();
                window.dispatchEvent(new CustomEvent('coreReady'));
            },
            showToast(msg) {
                let t = document.getElementById('toast') || Object.assign(document.createElement('div'), {id:'toast', className:'toast'});
                if(!t.parentElement) document.body.appendChild(t);
                t.textContent = msg; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 3000);
            },
            toggleSpinner(show) {
                let s = document.getElementById('spinner') || Object.assign(document.createElement('div'), {id:'spinner', className:'spinner-overlay', innerHTML:'<div class="loader"></div>'});
                if(!s.parentElement) document.body.appendChild(s);
                s.style.display = show ? 'flex' : 'none';
            },
            setupTabs() {
                window.switchTab = (id) => {
                    document.querySelectorAll('.content-section, .tab-btn').forEach(el => el.classList.remove('active'));
                    const target = document.getElementById(id);
                    if(target) target.classList.add('active');
                    const btn = document.querySelector(`[onclick*="${id}"]`);
                    if(btn) btn.classList.add('active');
                    if(id === 'analyticsTab') renderAnalytics();
                };
            },
            downloadSelf(fn) {
                const b = new Blob(["<!DOCTYPE html>\n"+document.documentElement.outerHTML], {type:'text/html'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = fn; a.click();
            }
        };
        window.APP_CORE = APP_CORE;
        document.addEventListener('DOMContentLoaded', () => APP_CORE.init());
    </script>
</head>
<body>

    <div class="tabs-container">
        <button class="tab-btn active" onclick="switchTab('mainTab')"><i class="fas fa-home"></i> é¦–é </button>
        <button class="tab-btn" onclick="switchTab('analyticsTab')"><i class="fas fa-chart-line"></i> åˆ†æ</button>
        <button class="tab-btn" onclick="switchTab('shopTab')"><i class="fas fa-shopping-basket"></i> å•†åŸ</button>
        <button class="tab-btn" onclick="switchTab('courseTab')"><i class="fas fa-graduation-cap"></i> èª²ç¨‹</button>
        <button class="tab-btn" onclick="switchTab('expertTab')"><i class="fas fa-user-md"></i> å°ˆå®¶</button>
        <button class="tab-btn" onclick="switchTab('dbTab')"><i class="fas fa-database"></i> ç¶­è­·</button>
        <button class="tab-btn" onclick="switchTab('sysTab')"><i class="fas fa-cog"></i> ç³»çµ±</button>
    </div>

    <!-- MAIN -->
    <div id="mainTab" class="content-section active">
        <div class="card" style="text-align:center;">
            <h2>ğŸ§¬ ç”Ÿç†åŒæ­¥æ——è‰¦ç³»çµ± V8.3</h2>
            <div id="login-area" style="margin-bottom:15px;">
                <button id="loginBtn" class="btn-gold" style="padding:10px 20px;" onclick="login()"><i class="fab fa-google"></i> Google ç™»å…¥</button>
                <div id="user-info" style="display:none; align-items:center; gap:10px; background:#fff; padding:10px; border-radius:12px; border:2px solid var(--accent-dark); text-align:left;">
                    <img id="userImg" src="" style="width:32px; border-radius:50%; border:2px solid var(--accent-color);">
                    <div><div id="userName" style="font-weight:bold; font-size:12px;"></div><div id="userEmail" style="font-size:9px; opacity:0.6;"></div></div>
                    <div id="roleBadge" style="font-size:9px; font-weight:bold; padding:2px 8px; border-radius:10px; border:1px solid #ccc; background:#f9f9f9;">è­˜åˆ¥ä¸­...</div>
                    <button class="btn-gold" style="margin-left:auto; font-size:9px;" onclick="logout()">ç™»å‡º</button>
                </div>
            </div>
            <div class="card">
                <h3>ğŸ§¬ å³æ™‚åŒæ­¥æª¢æ¸¬</h3>
                <button class="btn-gold" style="width:100%; padding:15px;" onclick="runRealTest()"><i class="fas fa-atom"></i> å•Ÿå‹•ç´°èƒæƒæä¸¦å­˜å…¥é›²ç«¯</button>
            </div>
        </div>
    </div>

    <!-- ANALYTICS (Sale5 Core) -->
    <div id="analyticsTab" class="content-section">
        <div class="card">
            <h2>ğŸ“Š ç”Ÿç†æ•¸æ“šå¤§æ•¸æ“šåˆ†æ</h2>
            <div id="analytics-content">æ­£åœ¨è¨ˆç®—åŒæ­¥ç‡...</div>
        </div>
    </div>

    <!-- SHOP -->
    <div id="shopTab" class="content-section">
        <div class="card">
            <h2>ğŸ›’ æ™ºæ§æ”¹å–„å•†åŸ</h2>
            <div id="shop-list" class="item-grid">è¼‰å…¥é›²ç«¯ç”¢å“...</div>
        </div>
    </div>

    <!-- COURSE -->
    <div id="courseTab" class="content-section">
        <div class="card" id="expert-course-ui" style="display:none; background:#e8f5e9;">
            <h3 style="color:#2e7d32; font-size:13px;"><i class="fas fa-plus-circle"></i> ç‡Ÿé¤Šå¸«ï¼šç™¼ä½ˆæ–°èª²ç¨‹</h3>
            <button class="btn-gold" style="width:100%; background:#2e7d32;" onclick="openAdd('courses')">å»ºç«‹èª²ç¨‹é …ç›®</button>
        </div>
        <div class="card">
            <h2>ğŸ“ åŒæ­¥åŸ¹è¨“èª²ç¨‹</h2>
            <div id="course-list" class="item-grid">è®€å–èª²ç¨‹æ¸…å–®...</div>
        </div>
    </div>

    <!-- EXPERT -->
    <div id="expertTab" class="content-section">
        <div class="card">
            <h2>ğŸ‘©â€âš•ï¸ å°ˆå®¶é¡§å•åœ˜éšŠ</h2>
            <div id="expert-list" class="item-grid">é€£ç·šå°ˆå®¶åº«...</div>
        </div>
    </div>

    <!-- DBMS -->
    <div id="dbTab" class="content-section">
        <div class="card">
            <h2><i class="fas fa-database"></i> æ•¸æ“šåº« DBMS ç®¡ç†</h2>
            <div class="search-bar"><i class="fas fa-search" style="opacity:0.5; margin-right:10px;"></i><input id="dbSearch" placeholder="æœå°‹é—œéµå­—æˆ– ID..." oninput="filterDbList()"></div>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <select id="dbColSelect" onchange="syncData(this.value)">
                    <option value="users">æœƒå“¡ç®¡ç†</option>
                    <option value="products">ç”¢å“ç®¡ç†</option>
                    <option value="courses">èª²ç¨‹ç®¡ç†</option>
                    <option value="dietitians">å°ˆå®¶ç®¡ç†</option>
                    <option value="tests">æª¢æ¸¬å ±å‘Š</option>
                    <option value="admins">ç®¡ç†è€…</option>
                </select>
                <button id="addBtn" class="btn-gold" style="background:#27ae60; display:none;" onclick="openAdd()"><i class="fas fa-plus"></i></button>
            </div>
            <div id="db-list"></div>
        </div>
    </div>

    <!-- SYS -->
    <div id="sysTab" class="content-section">
        <div class="card">
            <h2>ğŸ›  ç³»çµ±å…¨é‡éƒ¨ç½²</h2>
            <button class="btn-gold" style="width:100%; padding:15px; background:#4caf50;" onclick="batchInject()">ä¸€éµæ³¨å…¥ 60 ç­†å…¨åŠŸèƒ½æ•¸æ“š (å«åˆ†æèˆ‡æ¬Šé™)</button>
        </div>
        <button class="btn-gold" style="width:100%;" onclick="APP_CORE.downloadSelf('Sale7_Master_V83.html')">å‚™ä»½æœ¬é åŸå§‹ç¢¼</button>
    </div>

    <!-- MODAL -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modalTitle">æ•¸æ“šç¶­è­·</h2>
            <div style="margin-bottom:8px;"><button class="btn-gold" style="font-size:9px; padding:2px 6px; background:#607d8b;" onclick="formatJSON()">æ ¼å¼åŒ– JSON</button></div>
            <textarea id="editArea"></textarea>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                <button class="btn-gold" onclick="saveData()">ç¢ºèªå„²å­˜</button>
                <button class="btn-gold" style="background:#666;" onclick="document.getElementById('editModal').style.display='none'">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        const APP_ID = 'Sale7_Flagship_Master';
        let db = null, auth = null, dataStore = {}, userRole = 'user';
        let activeEditId = '';
        const fallback = "https://via.placeholder.com/150?text=Shizuku+Bio";

        window.addEventListener('coreReady', () => {
            const app = firebase.apps.length ? firebase.app() : firebase.initializeApp(APP_CORE.firebaseConfig);
            db = firebase.firestore(app);
            auth = firebase.auth(app);

            auth.onAuthStateChanged(async user => {
                if (user) {
                    document.getElementById('loginBtn').style.display = 'none';
                    document.getElementById('user-info').style.display = 'flex';
                    document.getElementById('userImg').src = user.photoURL || '';
                    document.getElementById('userName').innerText = user.displayName;
                    document.getElementById('userEmail').innerText = user.email;
                    await detectRole(user.email);
                    startSyncing();
                } else {
                    document.getElementById('loginBtn').style.display = 'inline-flex';
                    document.getElementById('user-info').style.display = 'none';
                }
            });
        });

        async function login() { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        async function logout() { await auth.signOut(); location.reload(); }

        async function detectRole(email) {
            const adminSnap = await db.collection(`artifacts/${APP_ID}/public/data/admins`).where('email', '==', email).get();
            if(!adminSnap.empty) { userRole = 'admin'; } else {
                const expertSnap = await db.collection(`artifacts/${APP_ID}/public/data/dietitians`).where('email', '==', email).get();
                if(!expertSnap.empty) userRole = 'dietitian';
            }
            updateRoleUI();
        }

        function updateRoleUI() {
            const b = document.getElementById('roleBadge');
            b.innerText = userRole === 'admin' ? 'ç®¡ç†è€…' : userRole === 'dietitian' ? 'ç‡Ÿé¤Šå¸«' : 'æœƒå“¡';
            b.style.color = userRole === 'admin' ? '#d32f2f' : userRole === 'dietitian' ? '#2e7d32' : '#666';
            document.getElementById('expert-course-ui').style.display = (userRole === 'dietitian' || userRole === 'admin') ? 'block' : 'none';
            if(db) filterDbList();
        }

        function startSyncing() {
            ['users', 'dietitians', 'products', 'courses', 'admins', 'tests'].forEach(col => {
                db.collection(`artifacts/${APP_ID}/public/data/${col}`).orderBy('updated_at', 'desc').onSnapshot(snap => {
                    dataStore[col] = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderModuleUI(col);
                    if(document.getElementById('dbColSelect').value === col) filterDbList();
                });
            });
        }

        function renderModuleUI(col) {
            if(col === 'products') {
                document.getElementById('shop-list').innerHTML = (dataStore.products || []).map(p => `
                    <div class="item-card">
                        <img src="${p.imageUrl || fallback}">
                        <div style="font-weight:bold; font-size:11px;">${p.title}</div>
                        <div style="color:#d32f2f; font-weight:bold;">$${p.price}</div>
                        <button class="btn-gold" style="font-size:9px;" onclick="APP_CORE.showToast('å·²åŠ å…¥è³¼ç‰©è»Š')">é¸è³¼</button>
                    </div>
                `).join('');
            }
            if(col === 'courses') {
                document.getElementById('course-list').innerHTML = (dataStore.courses || []).map(c => `
                    <div class="item-card">
                        <img src="${c.coverUrl || fallback}">
                        <div style="font-weight:bold; font-size:11px;">${c.title}</div>
                        <div style="font-size:9px; opacity:0.7;">${c.instructor}</div>
                    </div>
                `).join('');
            }
            if(col === 'dietitians') {
                document.getElementById('expert-list').innerHTML = (dataStore.dietitians || []).map(e => `
                    <div class="item-card">
                        <img src="${e.avatarUrl || fallback}">
                        <div style="font-weight:bold; font-size:11px;">${e.name}</div>
                        <div style="font-size:9px; opacity:0.7;">${e.expert}</div>
                    </div>
                `).join('');
            }
        }

        function renderAnalytics() {
            if(!auth.currentUser) return;
            const myTests = (dataStore.tests || []).filter(t => t.user === auth.currentUser.email);
            const container = document.getElementById('analytics-content');
            if(!myTests.length) { container.innerHTML = "<p>å°šç„¡æ•¸æ“šç´€éŒ„</p>"; return; }
            
            const latest = myTests[0];
            const trendData = myTests.slice(0, 7).reverse();
            container.innerHTML = `
                <div class="diag-box">
                    <h3 style="margin:0; font-size:13px; color:var(--success-color);"><i class="fas fa- stethoscope"></i> ç²¾æº–è¨ºæ–·å ±å‘Š</h3>
                    <p style="font-size:11px; margin-top:5px;">æœ€æ–°åŒæ­¥ç‡ï¼š<span style="font-weight:bold; font-size:14px;">${latest.score}%</span></p>
                    <p style="font-size:10px; color:#666;">è¨ºæ–·ï¼š${latest.score > 80 ? 'ç”Ÿç†ç¯€å¾‹é«˜åº¦åŒæ­¥ï¼Œå»ºè­°ç¶­æŒç¾ç‹€ã€‚' : 'åµæ¸¬åˆ°ç”Ÿç‰©èƒ½é‡æ³¢å‹•ï¼Œå»ºè­°åŠ å¼·ç‡Ÿé¤Šå¹²é ã€‚'}</p>
                </div>
                <div class="card" style="border-width:1px;">
                    <h3 style="font-size:12px; margin-bottom:5px;"><i class="fas fa-history"></i> è¿‘ 7 æ¬¡ç”Ÿç†è¶¨å‹¢åœ–</h3>
                    <div class="trend-chart">
                        ${trendData.map(t => `<div class="trend-bar" style="height:${t.score}%"><div class="trend-val">${t.score}</div></div>`).join('')}
                    </div>
                </div>
            `;
        }

        async function runRealTest() {
            if(!auth.currentUser) return APP_CORE.showToast("è«‹å…ˆç™»å…¥");
            APP_CORE.toggleSpinner("åŒæ­¥ç”Ÿç†æŒ‡æ¨™ä¸­...");
            setTimeout(async () => {
                await db.collection(`artifacts/${APP_ID}/public/data/tests`).add({
                    user: auth.currentUser.email,
                    score: Math.floor(Math.random()*30 + 70),
                    updated_at: firebase.firestore.FieldValue.serverTimestamp()
                });
                APP_CORE.toggleSpinner(false);
                APP_CORE.showToast("å ±å‘Šå·²åŒæ­¥è‡³åˆ†æåˆ†é ");
                switchTab('analyticsTab');
            }, 1500);
        }

        function filterDbList() {
            const col = document.getElementById('dbColSelect').value;
            const q = document.getElementById('dbSearch').value.toLowerCase();
            const data = (dataStore[col] || []).filter(i => JSON.stringify(i).toLowerCase().includes(q));
            document.getElementById('addBtn').style.display = (userRole === 'admin' || (userRole === 'dietitian' && (col==='courses' || col==='products'))) ? 'block' : 'none';
            
            document.getElementById('db-list').innerHTML = data.map(item => {
                const canEdit = (userRole === 'admin') || (userRole === 'dietitian' && (col === 'courses' || col === 'products'));
                const canDel = (userRole === 'admin');
                const thumb = item.imageUrl || item.avatarUrl || item.coverUrl || "";
                return `
                    <div class="db-item">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div style="display:flex; align-items:center;">
                                ${thumb ? `<img class="thumb-preview" src="${thumb}">` : ''}
                                <div><strong>${item.name || item.title || 'Untitled'}</strong> <span class="id-badge" onclick="copyID('${item.id}')">${item.id.slice(0,6)}</span></div>
                            </div>
                            <div style="display:flex; gap:3px;">
                                ${canEdit ? `<button class="btn-gold" style="padding:2px 6px; font-size:9px;" onclick="openEdit('${col}', '${item.id}')">ä¿®</button>` : ''}
                                ${canDel ? `<button class="btn-gold" style="padding:2px 6px; font-size:9px; background:#f44336;" onclick="delDoc('${col}', '${item.id}')">åˆª</button>` : ''}
                            </div>
                        </div>
                        <pre>${JSON.stringify(item, null, 1)}</pre>
                    </div>
                `;
            }).join('');
        }

        function copyID(id) { navigator.clipboard.writeText(id).then(()=>APP_CORE.showToast("ID å·²è¤‡è£½")); }
        function openAdd(tc) {
            const col = tc || document.getElementById('dbColSelect').value;
            activeEditId = '';
            document.getElementById('modalTitle').innerText = "æ–°å¢è‡³ " + col;
            document.getElementById('editArea').value = JSON.stringify({ title: "æ–°æ•¸æ“šé …ç›®", imageUrl: "", updated_at: "" }, null, 4);
            document.getElementById('editModal').style.display = 'flex';
        }
        function openEdit(col, id) {
            activeEditId = id; const item = dataStore[col].find(i => i.id === id); const {id:_, updated_at:__, ...clean} = item;
            document.getElementById('modalTitle').innerText = "ä¿®æ”¹ " + id;
            document.getElementById('editArea').value = JSON.stringify(clean, null, 4);
            document.getElementById('editModal').style.display = 'flex';
        }
        async function saveData() {
            const col = document.getElementById('dbColSelect').value;
            try {
                const data = JSON.parse(document.getElementById('editArea').value);
                const ref = db.collection(`artifacts/${APP_ID}/public/data/${col}`);
                if(activeEditId) await ref.doc(activeEditId).update({...data, updated_at: firebase.firestore.FieldValue.serverTimestamp()});
                else await ref.add({...data, updated_at: firebase.firestore.FieldValue.serverTimestamp()});
                document.getElementById('editModal').style.display = 'none';
                APP_CORE.showToast("é‡‘åº«å·²åŒæ­¥");
            } catch(e) { APP_CORE.showToast("æ ¼å¼éŒ¯èª¤"); }
        }
        async function delDoc(col, id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await db.doc(`artifacts/${APP_ID}/public/data/${col}/${id}`).delete(); }
        function formatJSON() { const e = document.getElementById('editArea'); try { e.value = JSON.stringify(JSON.parse(e.value), null, 4); } catch(e) { } }

        async function batchInject() {
            if(!auth.currentUser) return APP_CORE.showToast("è«‹ç™»å…¥");
            APP_CORE.toggleSpinner("æ——è‰¦æ•¸æ“šéƒ¨ç½²ä¸­...");
            const email = auth.currentUser.email;
            const sets = {
                admins: [{ name: "æœ€é«˜æŒ‡æ® (æ‚¨)", email: email, role: "super" }],
                dietitians: [{ name: "é¦–å¸­å¤§å¸« (æ‚¨)", email: email, expert: "åŸºå› åŒæ­¥", avatarUrl: "https://i.pravatar.cc/150?u=master" }],
                products: Array.from({length:10}, (_, i) => ({ title: `æ™ºæ§è£œçµ¦ ${i+1}`, price: 1500 + i*50, imageUrl: `https://picsum.photos/seed/p${i}/300/200` })),
                courses: Array.from({length:10}, (_, i) => ({ title: `ç²¾æº–èª²ç¨‹ ${i+1}`, instructor: "é¦–å¸­å¤§å¸«", coverUrl: `https://picsum.photos/seed/c${i}/300/200` })),
                tests: Array.from({length:7}, (_, i) => ({ user: email, score: 65 + Math.floor(Math.random()*30) })),
                users: Array.from({length:10}, (_, i) => ({ name: `å­¸å“¡ ${i+1}`, email: `st${i}@sale7.com` }))
            };
            for(let col of ['admins', 'dietitians', 'products', 'courses', 'tests', 'users']) {
                for(let item of sets[col]) {
                    await db.collection(`artifacts/${APP_ID}/public/data/${col}`).add({...item, updated_at: firebase.firestore.FieldValue.serverTimestamp()});
                }
            }
            APP_CORE.showToast("æ³¨å…¥æˆåŠŸï¼Œè«‹é‡æ–°æ•´ç†ï¼"); APP_CORE.toggleSpinner(false);
        }
    </script>

</body>
</html>