<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>é‡‘è¼å’–å•¡å»³ V28R - å°ˆå®¶ç´šå½±ç‰‡+ç¸®åœ–</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
:root {
    --gold-light: #fef3c7;
    --gold-main: #fbbf24;
    --gold-dark: #b45309;
    --panel-bg: rgba(251, 191, 36, 0.98);
}
html, body { height: 100%; margin: 0; padding: 0; background:#fbbf24;color:#451a03;font-family:"PingFang TC","Microsoft JhengHei",sans-serif; overflow:hidden; font-size:0.5rem; }
#dynamic-bg { position: fixed; inset:0; z-index:1; background-size: cover; background-position:center; transition: background-image 0.6s; background-image: url('https://images.unsplash.com/photo-1634128221889-82ed6efebfc3?q=80&w=2400'); }
.gold-texture { position:fixed; inset:0; z-index:2; background-image:url('https://www.transparenttextures.com/patterns/gold-glitter.png'); opacity:0.35; pointer-events:none; mix-blend-mode: overlay; }

.main-ui { display:flex; flex-direction:column; height:100vh; width:100vw; position:relative; z-index:3000; transition: transform 0.4s ease-in-out; pointer-events:none; }
.main-ui.hidden-ui { transform: translateY(-110%); }
.ui-header { padding:6px 12px; background: var(--panel-bg); border-bottom:2px solid #fff; box-shadow:0 4px 20px rgba(180,83,9,0.5); pointer-events:auto; }

.stage { position: fixed; inset:0; z-index:5; pointer-events:none; }
.draggable-box { position:absolute; pointer-events:auto; cursor:move; touch-action:none; display:flex; align-items:center; justify-content:center; transform:translate(-50%, -50%); transform-origin:center center; will-change: transform,left,top; }
.draggable-box.dragging { filter:brightness(1.2) drop-shadow(0 0 20px #fff); z-index:2000; }
#container-main { width:350px; height:500px; z-index:100; }
#subtitle-box { width:280px; min-height:120px; z-index:600; transition:opacity 0.3s; }
.bubble-hidden { opacity:0; pointer-events:none; transform:translate(-50%,-50%) scale(0.8); }
.bubble-visible { opacity:1; pointer-events:auto; transform:translate(-50%,-50%) scale(1); }
.bubble-svg { position:absolute; inset:0; z-index:-1; width:100%; height:100%; filter: drop-shadow(4px 4px 0px rgba(0,0,0,0.2)); }
.bubble-text { padding:25px 25px 40px 25px; color:#000; font-weight:900; font-size:1.1rem; text-align:center; word-break:break-all; line-height:1.4; }

.btn-gold { background: linear-gradient(180deg, #ffffff 0%, #fbbf24 100%); border:1px solid var(--gold-dark); padding:4px 10px; border-radius:4px; color:#451a03; cursor:pointer; font-weight:900; font-size:0.5rem; box-shadow:1px 1px 0 #b45309; transition:all 0.1s; }
.btn-gold:active { transform: translate(1px,1px); box-shadow:none; }
.btn-rec-active { background:#ef4444 !important; color:white !important; animation: blink 1s infinite; }
@keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.6;} }

.btn-toggle-ui { position:fixed; top:145px; right:10px; z-index:4000; background:var(--gold-dark); color:white; padding:6px 14px; border-radius:20px; font-size:0.5rem; font-weight:bold; cursor:pointer; border:1px solid #fff; box-shadow:0 4px 10px rgba(0,0,0,0.3); }
#console-log { font-size:0.5rem; height:50px; overflow-y:auto; background: rgba(255,255,255,0.95); padding:5px; color:#451a03; margin-top:6px; border:1px inset var(--gold-dark); border-radius:4px; }

input, select { background:white; border:1px solid var(--gold-dark); font-size:0.5rem; padding:3px 6px; border-radius:4px; color:#451a03; }
.info-strip { background: rgba(255,255,255,0.5); border-radius:6px; padding:4px 12px; margin-top:6px; display:flex; align-items:center; gap:8px; border:1px solid rgba(180,83,9,0.2); }
#script-line { font-style:italic; color:#78350f; font-weight:bold; font-size:0.7rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex:1; text-shadow:1px 1px 0 #fff; }
.tab-btn { padding:6px 14px; cursor:pointer; border-radius:6px 6px 0 0; background: rgba(180,83,9,0.1); border:1px solid var(--gold-dark); border-bottom:none; font-weight:bold; margin-right:4px; font-size:0.5rem; }
.tab-btn.active { background:var(--gold-main); border-bottom:3px solid var(--gold-main); color:#000; }
.tab-content { display:none; pointer-events:auto; padding-top:8px; }
.tab-content.active { display:block; }
.control-label { font-weight:bold; min-width:80px; color:#451a03; }
</style>
</head>
<body>

<div id="dynamic-bg"></div>
<div class="gold-texture"></div>
<button class="btn-toggle-ui" onclick="toggleUI()">éš±è—æ§åˆ¶é¢æ¿</button>
<button id="btn-download-src" class="btn-gold" onclick="exportCode()">ğŸ“¥ ä¸‹è¼‰å°ˆå®¶ç‰ˆæºç¢¼</button>

<div class="main-ui">
    <div class="ui-header">
        <div class="flex justify-between items-center gap-2">
            <span class="font-bold text-amber-950" style="font-size:0.6rem;">ğŸ‘‘ é‡‘è¼å°ˆå®¶ç‰ˆ V28R</span>
            <div class="flex gap-1">
                <button class="btn-gold" onclick="playScript()">ğŸ¬ æ’­æ”¾åŠ‡æœ¬</button>
                <button id="rec-btn" class="btn-gold" onclick="toggleRec()">ğŸ”´ éŒ„è£½å½±ç‰‡</button>
                <button id="pause-btn" class="btn-gold" onclick="handlePause()">â¸ æš«åœ</button>
                <button class="btn-gold" onclick="exportThumbnail()">ğŸ–¼ï¸ ç”Ÿæˆç¸®åœ–</button>
                <button class="btn-gold" style="background:#ff0000;color:white;" onclick="openYouTubeUpload()">ğŸ“º ä¸Šå‚³ YouTube</button>
            </div>
        </div>
        <div class="info-strip">
            <span id="p-status" class="font-black text-amber-800" style="min-width:40px;">IDLE</span>
            <div id="script-line">ç³»çµ±å°±ç·’ã€‚æ‰€æœ‰ä½ç½®è®Šæ›´å‡æœƒè‡ªå‹•æŒä¹…åŒ–å„²å­˜ã€‚</div>
        </div>

        <div class="flex mt-2">
            <div class="tab-btn active" onclick="switchTab('tab-layout')">ä½ˆå±€æ“æ§</div>
            <div class="tab-btn" onclick="switchTab('tab-system')">ç³»çµ±è¨­ç½®</div>
            <div class="tab-btn" onclick="switchTab('tab-storage')">è³‡æ–™ç®¡ç†</div>
        </div>

        <!-- Layout Tab -->
        <div id="tab-layout" class="tab-content active">
            <div class="grid grid-cols-2 gap-2 mb-2">
                <button class="btn-gold" onclick="initActor()">æ‰‹å‹•é‡è¼‰ Live2D</button>
                <button class="btn-gold" onclick="const b=document.getElementById('subtitle-box'); b.classList.toggle('bubble-visible'); b.classList.toggle('bubble-hidden');">åˆ‡æ›å°è©±æ°£æ³¡</button>
            </div>
            <div class="flex items-center gap-2">
                <span class="control-label">æ¨¡å‹ V-Offset:</span>
                <input type="range" id="voffset-range" min="-600" max="600" value="-50" class="flex-grow" oninput="document.getElementById('v-val').innerText=this.value">
                <span id="v-val" style="min-width:35px;">-50</span>
            </div>
            <div id="console-log">å°ˆå®¶æ§åˆ¶å°ï¼šç­‰å¾…æŒ‡ä»¤...</div>
        </div>

        <!-- System Tab -->
        <div id="tab-system" class="tab-content">
            <div class="flex flex-col gap-2">
                <div class="flex items-center gap-2">
                    <span class="control-label">è§’è‰²åˆ‡æ›:</span>
                    <select id="avatar-main" class="flex-grow" onchange="initActor()"></select>
                </div>
                <div class="flex items-center gap-2">
                    <span class="control-label">é è¨­èƒŒæ™¯:</span>
                    <select id="bg-selector" class="flex-grow" onchange="if(this.value!=='custom'){applyBG(this.value); document.getElementById('bg-manual-url').value=this.value;}"></select>
                </div>
                <div class="flex items-center gap-2">
                    <span class="control-label">èƒŒæ™¯ç¶²å€:</span>
                    <input type="text" id="bg-manual-url" class="flex-grow" placeholder="è«‹è¼¸å…¥åœ–ç‰‡ URL..." onchange="applyBG(this.value)">
                </div>
            </div>
        </div>

        <!-- Storage Tab -->
        <div id="tab-storage" class="tab-content">
            <div class="flex flex-col gap-2">
                <div class="flex items-center gap-2">
                    <span class="control-label">Sheet ID:</span>
                    <input type="text" id="sheet-id" class="flex-grow" onchange="saveAll()" placeholder="Google Sheet ID...">
                </div>
                <div class="grid grid-cols-2 gap-2 mt-1">
                    <button class="btn-gold" onclick="saveAll(); sysLog('é…ç½®å·²æ‰‹å‹•å­˜æª”ã€‚');">ğŸ’¾ æ‰‹å‹•å­˜æª”</button>
                    <button class="btn-gold" onclick="loadAll(); initActor();">ğŸ“‚ å¼·åˆ¶è®€å–</button>
                </div>
                <button class="btn-gold w-full mt-1" style="background:#78350f;color:white;" onclick="localStorage.clear(); location.reload();">âš ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™ä¸¦é‡ç½®</button>
            </div>
        </div>
    </div>
</div>

<div class="stage">
    <div id="container-main" class="draggable-box"></div>
    <div id="subtitle-box" class="draggable-box bubble-hidden">
        <svg class="bubble-svg" viewBox="0 0 280 120" preserveAspectRatio="none">
            <path d="M20,5 L260,5 Q275,5 275,20 L275,80 Q275,95 260,95 L165,95 L140,115 L115,95 L20,95 Q5,95 5,80 L5,20 Q5,5 20,5" fill="white" stroke="#451a03" stroke-width="3"/>
        </svg>
        <div id="manga-text" class="bubble-text">å°ˆå®¶ç³»çµ±å·²å•Ÿå‹•ã€‚</div>
    </div>
</div>

<script>
const AVATARS = {
"shizuku":"https://unpkg.com/live2d-widget-model-shizuku@1.0.5/assets/shizuku.model.json",
"koharu":"https://unpkg.com/live2d-widget-model-koharu@1.0.5/assets/koharu.model.json",
"haruto":"https://unpkg.com/live2d-widget-model-haruto@1.0.5/assets/haruto.model.json",
"miku":"https://unpkg.com/live2d-widget-model-miku@1.0.5/assets/miku.model.json",
"hijiki":"https://unpkg.com/live2d-widget-model-hijiki@1.0.5/assets/hijiki.model.json",
"tororo":"https://unpkg.com/live2d-widget-model-tororo@1.0.5/assets/tororo.model.json",
"z16":"https://unpkg.com/live2d-widget-model-z16@1.0.5/assets/z16.model.json",
"epsilon":"https://unpkg.com/live2d-widget-model-epsilon2_1@1.0.5/assets/epsilon2_1.model.json",
"chitose":"https://unpkg.com/live2d-widget-model-chitose@1.0.5/assets/chitose.model.json",
"tsumiki":"https://unpkg.com/live2d-widget-model-tsumiki@1.0.5/assets/tsumiki.model.json",
"unitychan":"https://unpkg.com/live2d-widget-model-unitychan@1.0.5/assets/unitychan.model.json",
"hibiki":"https://unpkg.com/live2d-widget-model-hibiki@1.0.5/assets/hibiki.model.json"
};

const BACKGROUNDS = {
"gold_vault":"https://images.unsplash.com/photo-1634128221889-82ed6efebfc3?q=80&w=2400",
"cafe_interior":"https://images.unsplash.com/photo-1590283603385-17ffb3a7f29f?q=80&w=2400",
"morning_sun":"https://images.unsplash.com/photo-1554118811-1e0d58224f24?q=80&w=2400",
"cyber_room":"https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?q=80&w=2400",
"luxury_palace":"https://images.unsplash.com/photo-1518531933037-91b2f5f229cc?q=80&w=2400"
};

let state = { char:{x:"50%",y:"60%",scale:1.0,rotation:0}, sub:{x:"50%",y:"25%",scale:1.0,rotation:0}, playing:false, currentActor:"shizuku", vOffset:-50, sheetId:"", bgUrl:BACKGROUNDS.gold_vault };
let mediaRecorder, recordedChunks=[], isRecording=false;

function sysLog(msg){const logBox=document.getElementById('console-log');if(!logBox) return; const div=document.createElement('div'); div.innerHTML=`<span style="color:#b45309">â—</span> [${new Date().toLocaleTimeString()}] ${msg}`; logBox.prepend(div);}

function toggleUI(){const ui=document.querySelector('.main-ui');const btn=document.querySelector('.btn-toggle-ui'); ui.classList.toggle('hidden-ui'); btn.innerText=ui.classList.contains('hidden-ui')?"é¡¯ç¤ºæ§åˆ¶é¢æ¿":"éš±è—æ§åˆ¶é¢æ¿"; btn.style.top=ui.classList.contains('hidden-ui')?"15px":"145px";}

// --- Persistence ---
function saveAll(){state.vOffset=parseInt(document.getElementById('voffset-range').value); state.sheetId=document.getElementById('sheet-id').value; state.currentActor=document.getElementById('avatar-main').value; state.bgUrl=document.getElementById('bg-manual-url').value; localStorage.setItem('CAFE_PRO_V28_DATA', JSON.stringify(state));}
function loadAll(){const saved=localStorage.getItem('CAFE_PRO_V28_DATA');if(saved){state={...state,...JSON.parse(saved)}; sysLog("ç³»çµ±ï¼šæˆåŠŸå¾æœ¬åœ°å„²å­˜è¼‰å…¥é…ç½®ã€‚");} document.getElementById('voffset-range').value=state.vOffset; document.getElementById('v-val').innerText=state.vOffset; document.getElementById('sheet-id').value=state.sheetId; document.getElementById('avatar-main').value=state.currentActor; document.getElementById('bg-manual-url').value=state.bgUrl; applyBG(state.bgUrl); updateElementUI('container-main','char'); updateElementUI('subtitle-box','sub'); }
function updateElementUI(id,key){const el=document.getElementById(id); el.style.left=state[key].x; el.style.top=state[key].y; applyTransform(el,key);}

// --- Interaction ---
const getDist=(t1,t2)=>Math.hypot(t1.clientX-t2.clientX,t1.clientY-t2.clientY);
const getAng=(t1,t2)=>Math.atan2(t2.clientY-t1.clientY,t2.clientX-t1.clientX)*180/Math.PI;

function bindControls(el,key){let dragging=false,pinching=false,startX,startY,initL,initT,initDist,initScale,initAngle,initRot;
const start=(e)=>{if(e.target.closest('button,select,input')) return; el.classList.add('dragging'); const ts=e.touches; if(ts && ts.length===2){pinching=true; initDist=getDist(ts[0],ts[1]); initAngle=getAng(ts[0],ts[1]); initScale=state[key].scale; initRot=state[key].rotation;} else{dragging=true;startX=e.clientX;e.clientY=startY=parseFloat(el.style.top)||el.offsetTop;initL=parseFloat(el.style.left)||el.offsetLeft;initT=parseFloat(el.style.top)||el.offsetTop;}}; const move=(e)=>{const ts=e.touches;if(dragging){const dx=e.clientX-startX; const dy=e.clientY-startY; state[key].x=(initL+dx)+'px'; state[key].y=(initT+dy)+'px';el.style.left=state[key].x;el.style.top=state[key].y;} if(pinching && ts && ts.length===2){const d=getDist(ts[0],ts[1]); const a=getAng(ts[0],ts[1]); state[key].scale=initScale*d/initDist; state[key].rotation+=a-initAngle; applyTransform(el,key); initAngle=a;}}; const end=(e)=>{el.classList.remove('dragging'); dragging=false; pinching=false; saveAll();}; el.addEventListener('mousedown',start); el.addEventListener('touchstart',start); window.addEventListener('mousemove',move); window.addEventListener('touchmove',move); window.addEventListener('mouseup',end); window.addEventListener('touchend',end);}
function applyTransform(el,key){el.style.transform=`translate(-50%,-50%) scale(${state[key].scale}) rotate(${state[key].rotation}deg)`;}
bindControls(document.getElementById('container-main'),'char'); bindControls(document.getElementById('subtitle-box'),'sub');

// --- Background ---
function applyBG(url){state.bgUrl=url; document.getElementById('dynamic-bg').style.backgroundImage=`url('${url}')`; sysLog("èƒŒæ™¯å·²æ›´æ›ã€‚");}
function switchTab(id){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));document.getElementById(id).classList.add('active'); event.currentTarget?.classList.add('active');}

// --- Actor ---
function initActor(){const sel=document.getElementById('avatar-main');if(sel.options.length===0){for(const k in AVATARS){const o=document.createElement('option');o.value=k;o.text=k;sel.appendChild(o);}} document.getElementById('container-main').innerHTML=`<canvas id="l2d-canvas" width="350" height="500"></canvas>`; loadLive2D(AVATARS[sel.value]||AVATARS.shizuku); saveAll();}
function loadLive2D(url){if(window.Live2DWidget){Live2DWidget.init({model:url,canvas:document.getElementById('l2d-canvas')}); sysLog("è§’è‰²è¼‰å…¥å®Œæˆ");}}

// --- Subtitle / Script ---
function playScript(){state.playing=true; document.getElementById('p-status').innerText="PLAYING"; const textBox=document.getElementById('manga-text'); let idx=0; const lines=["æ­¡è¿ä¾†åˆ°é‡‘è¼å’–å•¡å»³","ä»Šå¤©çš„ç‰¹èª¿æ˜¯é»ƒé‡‘æ‹¿éµ","æº–å‚™å¥½é–‹å•Ÿä¸€å¤©çš„ç²¾å½©å§ï¼"]; const timer=setInterval(()=>{textBox.innerText=lines[idx]; document.getElementById('script-line').innerText=lines[idx]; idx++; if(idx>=lines.length){clearInterval(timer); state.playing=false; document.getElementById('p-status').innerText="IDLE";}},1500);}
function handlePause(){state.playing=false; document.getElementById('p-status').innerText="PAUSED";}

// --- Recording ---
function toggleRec(){if(!isRecording){startRec();}else{stopRec();}}
function startRec(){const stage=document.querySelector('.stage'); const stream=stage.captureStream(30); recordedChunks=[]; mediaRecorder=new MediaRecorder(stream,{mimeType:'video/webm; codecs=vp9'}); mediaRecorder.ondataavailable=e=>{if(e.data.size>0) recordedChunks.push(e.data);}; mediaRecorder.onstop=()=>{const blob=new Blob(recordedChunks,{type:'video/webm'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`CafeVideo_${Date.now()}.webm`; a.click(); sysLog("å½±ç‰‡éŒ„è£½å®Œæˆï¼Œå·²ç”Ÿæˆ WebM æª”æ¡ˆ");}; mediaRecorder.start(); isRecording=true; document.getElementById('rec-btn').classList.add('btn-rec-active'); sysLog("é–‹å§‹éŒ„è£½å½±ç‰‡");}
function stopRec(){if(mediaRecorder){mediaRecorder.stop(); isRecording=false; document.getElementById('rec-btn').classList.remove('btn-rec-active');}}

// --- Thumbnail ---
function exportThumbnail(){
    const stage=document.querySelector('.stage');
    const canvas=document.createElement('canvas');
    canvas.width=1280; canvas.height=720;
    const ctx=canvas.getContext('2d');
    const scaleX=canvas.width/stage.offsetWidth;
    const scaleY=canvas.height/stage.offsetHeight;

    html2canvas(stage,{backgroundColor:null, scale:1}).then(c=>{
        ctx.drawImage(c,0,0,canvas.width,canvas.height);
        canvas.toBlob(blob=>{
            const a=document.createElement('a');
            a.href=URL.createObjectURL(blob);
            a.download=`Thumbnail_${Date.now()}.png`;
            a.click();
            sysLog("ç¸®åœ–å·²ç”Ÿæˆï¼š1280x720 PNG");
        });
    });
}

// --- YouTube ---
function openYouTubeUpload(){
    window.open('https://studio.youtube.com/channel/UC/upload','_blank');
    sysLog("YouTube ä¸Šå‚³é å·²é–‹å•Ÿï¼Œè«‹æ‰‹å‹•æ‹–å…¥å½±ç‰‡èˆ‡ç¸®åœ–ã€‚");
}

// --- Init ---
loadAll();
initActor();
applyBG(state.bgUrl);
</script>

</body>
</html>
