<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>é‡‘è¼å’–å•¡å»³ V29R - å…¨åŠŸèƒ½å°ˆå®¶ç‰ˆ</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root {
--gold-light:#fef3c7;--gold-main:#fbbf24;--gold-dark:#b45309;--panel-bg:rgba(251,191,36,0.98);
}
html,body{height:100%;margin:0;padding:0;background-color:#fbbf24;color:#451a03;font-family:"PingFang TC","Microsoft JhengHei",sans-serif;overflow:hidden;font-size:0.5rem;}
#dynamic-bg{position:fixed;inset:0;z-index:1;background-size:cover;background-position:center;background-repeat:no-repeat;transition:background-image 0.6s cubic-bezier(0.4,0,0.2,1);background-image:url('https://images.unsplash.com/photo-1634128221889-82ed6efebfc3?q=80&w=2400');}
.gold-texture{position:fixed;inset:0;z-index:2;background-image:url('https://www.transparenttextures.com/patterns/gold-glitter.png');opacity:0.35;pointer-events:none;mix-blend-mode:overlay;}
.main-ui{display:flex;flex-direction:column;height:100vh;width:100vw;position:relative;z-index:3000;transition:transform 0.4s ease-in-out;pointer-events:none;}
.main-ui.hidden-ui{transform:translateY(-110%);}
.ui-header{padding:6px 12px;background:var(--panel-bg);border-bottom:2px solid #fff;box-shadow:0 4px 20px rgba(180,83,9,0.5);pointer-events:auto;}
.stage{position:fixed;inset:0;z-index:5;pointer-events:none;}
.draggable-box{position:absolute;pointer-events:auto;cursor:move;touch-action:none;display:flex;align-items:center;justify-content:center;transform:translate(-50%,-50%);transform-origin:center center;will-change:transform,left,top;}
.draggable-box.dragging{filter:brightness(1.2) drop-shadow(0 0 20px #fff);z-index:2000;}
#container-main{width:350px;height:500px;z-index:100;}
#subtitle-box{width:280px;min-height:120px;z-index:600;transition:opacity 0.3s;}
.bubble-hidden{opacity:0;pointer-events:none;transform:translate(-50%,-50%) scale(0.8);}
.bubble-visible{opacity:1;pointer-events:auto;transform:translate(-50%,-50%) scale(1);}
.bubble-svg{position:absolute;inset:0;z-index:-1;width:100%;height:100%;filter:drop-shadow(4px 4px 0px rgba(0,0,0,0.2));}
.bubble-text{padding:25px 25px 40px 25px;color:#000;font-weight:900;font-size:1.1rem;text-align:center;word-break:break-all;line-height:1.4;}
iframe{border:none;background:transparent !important;width:100%;height:100%;pointer-events:none;}
.btn-gold{background:linear-gradient(180deg,#ffffff 0%,#fbbf24 100%);border:1px solid var(--gold-dark);padding:4px 10px;border-radius:4px;color:#451a03;cursor:pointer;font-weight:900;font-size:0.5rem;box-shadow:1px 1px 0 #b45309;transition:all 0.1s;}
.btn-gold:active{transform:translate(1px,1px);box-shadow:none;}
.btn-rec-active{background:#ef4444 !important;color:white !important;animation:blink 1s infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0.6;}}
.btn-toggle-ui{position:fixed;top:145px;right:10px;z-index:4000;background:var(--gold-dark);color:white;padding:6px 14px;border-radius:20px;font-size:0.5rem;font-weight:bold;cursor:pointer;border:1px solid #fff;box-shadow:0 4px 10px rgba(0,0,0,0.3);}
#console-log{font-size:0.5rem;height:50px;overflow-y:auto;background:rgba(255,255,255,0.95);padding:5px;color:#451a03;margin-top:6px;border:1px inset var(--gold-dark);border-radius:4px;}
#btn-download-src{position:fixed;left:10px;bottom:10px;z-index:5000;background:#3b82f6;color:white;border:1px solid #fff;font-size:0.5rem;padding:5px 14px;border-radius:20px;font-weight:bold;}
input,select{background:white;border:1px solid var(--gold-dark);font-size:0.5rem;padding:3px 6px;border-radius:4px;color:#451a03;}
.info-strip{background:rgba(255,255,255,0.5);border-radius:6px;padding:4px 12px;margin-top:6px;display:flex;align-items:center;gap:8px;border:1px solid rgba(180,83,9,0.2);}
#script-line{font-style:italic;color:#78350f;font-weight:bold;font-size:0.7rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;text-shadow:1px 1px 0px #fff;}
.tab-btn{padding:6px 14px;cursor:pointer;border-radius:6px 6px 0 0;background:rgba(180,83,9,0.1);border:1px solid var(--gold-dark);border-bottom:none;font-weight:bold;margin-right:4px;font-size:0.5rem;}
.tab-btn.active{background:var(--gold-main);border-bottom:3px solid var(--gold-main);color:#000;}
.tab-content{display:none;pointer-events:auto;padding-top:8px;}
.tab-content.active{display:block;}
.control-label{font-weight:bold;min-width:80px;color:#451a03;}
</style>
</head>
<body>
<script>
// --- æ¨¡å‹èˆ‡èƒŒæ™¯ ---
const AVATARS={
"shizuku":"https://unpkg.com/live2d-widget-model-shizuku@1.0.5/assets/shizuku.model.json",
"koharu":"https://unpkg.com/live2d-widget-model-koharu@1.0.5/assets/koharu.model.json",
"haruto":"https://unpkg.com/live2d-widget-model-haruto@1.0.5/assets/haruto.model.json",
"miku":"https://unpkg.com/live2d-widget-model-miku@1.0.5/assets/miku.model.json",
"hijiki":"https://unpkg.com/live2d-widget-model-hijiki@1.0.5/assets/hijiki.model.json",
"tororo":"https://unpkg.com/live2d-widget-model-tororo@1.0.5/assets/tororo.model.json",
"z16":"https://unpkg.com/live2d-widget-model-z16@1.0.5/assets/z16.model.json",
"epsilon":"https://unpkg.com/live2d-widget-model-epsilon2_1@1.0.5/assets/epsilon2_1.model.json",
"chitose":"https://unpkg.com/live2d-widget-model-chitose@1.0.5/assets/chitose.model.json",
"tsumiki":"https://unpkg.com/live2d-widget-model-tsumiki@1.0.5/assets/tsumiki.model.json",
"unitychan":"https://unpkg.com/live2d-widget-model-unitychan@1.0.5/assets/unitychan.model.json",
"hibiki":"https://unpkg.com/live2d-widget-model-hibiki@1.0.5/assets/hibiki.model.json"
};
const BACKGROUNDS={
"gold_vault":"https://images.unsplash.com/photo-1634128221889-82ed6efebfc3?q=80&w=2400",
"cafe_interior":"https://images.unsplash.com/photo-1590283603385-17ffb3a7f29f?q=80&w=2400",
"morning_sun":"https://images.unsplash.com/photo-1554118811-1e0d58224f24?q=80&w=2400",
"cyber_room":"https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?q=80&w=2400",
"luxury_palace":"https://images.unsplash.com/photo-1518531933037-91b2f5f229cc?q=80&w=2400"
};

// --- ç³»çµ±ç‹€æ…‹ ---
let state={
char:{x:"50%",y:"60%",scale:1.0,rotation:0},
sub:{x:"50%",y:"25%",scale:1.0,rotation:0},
playing:false,
currentActor:"shizuku",
vOffset:-50,
sheetId:"",
bgUrl:BACKGROUNDS.gold_vault
};
let mediaRecorder; let recordedChunks=[]; let isRecording=false;

// --- ç³»çµ±æ—¥èªŒ ---
function sysLog(msg){
const logBox=document.getElementById('console-log'); if(!logBox) return;
const div=document.createElement('div'); div.innerHTML=`<span style="color:#b45309">â—</span> [${new Date().toLocaleTimeString()}] ${msg}`;
logBox.prepend(div);
}

// --- UI åŠŸèƒ½ ---
function toggleUI(){
const ui=document.querySelector('.main-ui'); const btn=document.querySelector('.btn-toggle-ui');
ui.classList.toggle('hidden-ui');
btn.innerText=ui.classList.contains('hidden-ui')?"é¡¯ç¤ºæ§åˆ¶é¢æ¿":"éš±è—æ§åˆ¶é¢æ¿";
btn.style.top=ui.classList.contains('hidden-ui')?"15px":"145px";
}

// --- localStorage ---
function saveAll(){
state.vOffset=parseInt(document.getElementById('voffset-range').value);
state.sheetId=document.getElementById('sheet-id').value;
state.currentActor=document.getElementById('avatar-main').value;
state.bgUrl=document.getElementById('bg-manual-url').value;
localStorage.setItem('CAFE_PRO_V29_DATA',JSON.stringify(state));
}
function loadAll(){
const saved=localStorage.getItem('CAFE_PRO_V29_DATA');
if(saved){state={...state,...JSON.parse(saved)}; sysLog("ç³»çµ±ï¼šæˆåŠŸå¾æœ¬åœ°å„²å­˜è¼‰å…¥é…ç½®ã€‚");}
document.getElementById('voffset-range').value=state.vOffset;
document.getElementById('v-val').innerText=state.vOffset;
document.getElementById('sheet-id').value=state.sheetId;
document.getElementById('avatar-main').value=state.currentActor;
document.getElementById('bg-manual-url').value=state.bgUrl;
applyBG(state.bgUrl);
updateElementUI('container-main','char');
updateElementUI('subtitle-box','sub');
}
function updateElementUI(id,key){
const el=document.getElementById(id);
el.style.left=state[key].x; el.style.top=state[key].y;
applyTransform(el,key);
}

// --- æ‹–æ‹‰ & æ—‹è½‰ ---
const getDist=(t1,t2)=>Math.hypot(t1.clientX-t2.clientX,t1.clientY-t2.clientY);
const getAng=(t1,t2)=>Math.atan2(t2.clientY-t1.clientY,t2.clientX-t1.clientX)*180/Math.PI;
function bindControls(el,key){
let dragging=false,pinching=false; let startX,startY,initL,initT,initDist,initScale,initAngle,initRot;
const start=(e)=>{
if(e.target.closest('button,input,select'))return;
el.classList.add('dragging'); const ts=e.touches;
if(ts&&ts.length===2){dragging=false;pinching=true;initDist=getDist(ts[0],ts[1]);initScale=state[key].scale;initAngle=getAng(ts[0],ts[1]);initRot=state[key].rotation;}
else{dragging=true;pinching=false;const p=ts?ts[0]:e; startX=p.clientX; startY=p.clientY; initL=el.offsetLeft; initT=el.offsetTop;}
};
const move=(e)=>{
const ts=e.touches;
if(pinching&&ts&&ts.length===2){e.preventDefault(); const d=getDist(ts[0],ts[1]); if(initDist>0)state[key].scale=initScale*(d/initDist); const a=getAng(ts[0],ts[1]); state[key].rotation=initRot+(a-initAngle); applyTransform(el,key);}
else if(dragging){e.preventDefault(); const p=ts?ts[0]:e; state[key].x=(initL+(p.clientX-startX))+'px'; state[key].y=(initT+(p.clientY-startY))+'px'; el.style.left=state[key].x; el.style.top=state[key].y;}
};
const end=()=>{dragging=false;pinching=false;el.classList.remove('dragging'); saveAll();};
el.addEventListener('mousedown',start);
el.addEventListener('touchstart',start,{passive:false});
window.addEventListener('mousemove',(e)=>{if(dragging||pinching)move(e);});
window.addEventListener('touchmove',(e)=>{if(dragging||pinching)move(e);},{passive:false});
window.addEventListener('mouseup',end);
window.addEventListener('touchend',end);
}
function applyTransform(el,key){el.style.transform=`translate(-50%,-50%) scale(${state[key].scale}) rotate(${state[key].rotation}deg)`;}
function applyBG(url){if(!url)return; state.bgUrl=url; document.getElementById('dynamic-bg').style.backgroundImage=`url('${url}')`; saveAll();}

// --- Live2D Actor ---
function initActor(){
const v=parseInt(document.getElementById('voffset-range').value);
const actorKey=document.getElementById('avatar-main').value;
const stage=document.getElementById('container-main');
stage.innerHTML=`<iframe></iframe>`;
const doc=stage.querySelector('iframe').contentWindow.document;
doc.open();
doc.write(`<!DOCTYPE html><html><head><script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/lib/L2Dwidget.min.js"><\/script><style>body{margin:0;background:transparent!important;overflow:hidden;height:100vh;width:100vw;}canvas{width:100%!important;height:100%!important;object-fit:contain!important;}</style></head><body><script>L2Dwidget.init({model:{jsonPath:"${AVATARS[actorKey]}"},display:{position:"center",width:350,height:500,vOffset:${v}},mobile:{show:true,scale:1}});<\/script></body></html>`);
doc.close(); state.currentActor=actorKey; sysLog(`è§’è‰²åŠ è¼‰ï¼š${actorKey}`); saveAll();
}

// --- éŒ„è£½å½±ç‰‡ ---
async function toggleRec(){
if(!isRecording){
try{
const stream=await navigator.mediaDevices.getDisplayMedia({video:{frameRate:30},audio:true});
mediaRecorder=new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp9'});
recordedChunks=[];
mediaRecorder.ondataavailable=(e)=>{if(e.data.size>0)recordedChunks.push(e.data);};
mediaRecorder.onstop=()=>{
const blob=new Blob(recordedChunks,{type:'video/mp4'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a'); a.href=url; a.download=`Golden_Manga_Expert_${Date.now()}.mp4`; a.click();
sysLog("éŒ„è£½æˆåŠŸï¼šæª”æ¡ˆå·²åŒ¯å‡ºç‚º MP4ã€‚"); isRecording=false;
document.getElementById('rec-btn').classList.remove('btn-rec-active');
document.getElementById('rec-btn').innerText="ğŸ”´ é–‹å§‹éŒ„å½±";
stream.getTracks().forEach(t=>t.stop());
};
mediaRecorder.start(); isRecording=true;
document.getElementById('rec-btn').classList.add('btn-rec-active'); document.getElementById('rec-btn').innerText="â¹ åœæ­¢éŒ„å½±";
sysLog("éŒ„å½±ä¸­... è«‹æ“ä½œæˆ–æ’­æ”¾åŠ‡æœ¬ã€‚");
}catch(err){sysLog("ç³»çµ±éŒ¯èª¤ï¼š"+err.message);}
}else{mediaRecorder.stop();}
}
function handlePause(){if(!mediaRecorder)return;if(mediaRecorder.state==="recording"){mediaRecorder.pause();sysLog("éŒ„è£½å·²æš«åœ");document.getElementById('pause-btn').innerText="â–¶ æ¢å¾©";}
else if(mediaRecorder.state==="paused"){mediaRecorder.resume();sysLog("éŒ„è£½å·²æ¢å¾©");document.getElementById('pause-btn').innerText="â¸ æš«åœ";}}

// --- ç¸®åœ–ç”Ÿæˆ 1280x720 ---
function generateThumbnail(){
const canvas=document.createElement('canvas'); canvas.width=1280; canvas.height=720;
const ctx=canvas.getContext('2d');
const bg=document.getElementById('dynamic-bg'); 
ctx.fillStyle="#fbbf24"; ctx.fillRect(0,0,1280,720);
const img=new Image(); img.crossOrigin="anonymous"; img.src=state.bgUrl;
img.onload=()=>{
ctx.drawImage(img,0,0,1280,720);
const charEl=document.getElementById('container-main');
html2canvas(charEl,{backgroundColor:null,scale:2}).then(canvasChar=>{
ctx.drawImage(canvasChar, (1280-350)/2,(720-500)/2,350,500);
const subEl=document.getElementById('subtitle-box');
html2canvas(subEl,{backgroundColor:null,scale:2}).then(canvasSub=>{
ctx.drawImage(canvasSub,(1280-280)/2,50,280,120);
const a=document.createElement('a'); a.href=canvas.toDataURL('image/png'); a.download=`thumbnail_${Date.now()}.png`; a.click();
sysLog("ç¸®åœ–å·²ç”Ÿæˆä¸¦ä¸‹è¼‰ã€‚");
});
});
};
}

// --- ç”Ÿæˆå½±ç‰‡ + æ‰“é–‹ YouTube ä¸Šå‚³ ---
function openYouTubeUpload(){window.open("https://www.youtube.com/upload","_blank"); sysLog("å·²æ‰“é–‹ YouTube ä¸Šå‚³é ");}

// --- DOM ç”Ÿæˆ ---
document.write(`
<div id="dynamic-bg"></div><div class="gold-texture"></div>
<div class="main-ui">
<div class="ui-header">
<span class="tab-btn active" data-tab="tab-system">ç³»çµ±</span>
<span class="tab-btn" data-tab="tab-actor">è§’è‰²</span>
<span class="tab-btn" data-tab="tab-data">è³‡æ–™</span>
</div>
<div class="tab-content active" id="tab-system">
<div class="info-strip"><label class="control-label">èƒŒæ™¯é¸å–®:</label>
<select id="bg-select">
${Object.keys(BACKGROUNDS).map(k=>`<option value="${BACKGROUNDS[k]}">${k}</option>`).join('')}
</select>
<input id="bg-manual-url" placeholder="æˆ–æ‰‹å‹•è²¼ URL" style="width:140px;">
<button class="btn-gold" onclick="applyBG(document.getElementById('bg-manual-url').value)">å¥—ç”¨</button>
</div>
<div class="info-strip"><label class="control-label">V-offset:</label>
<input type="range" min="-200" max="200" id="voffset-range" value="-50">
<span id="v-val">-50</span>
</div>
<button class="btn-gold" onclick="initActor()">æ›´æ–°è§’è‰²</button>
</div>
<div class="tab-content" id="tab-actor">
<div class="info-strip"><label class="control-label">è§’è‰²æ¨¡å‹:</label>
<select id="avatar-main">${Object.keys(AVATARS).map(k=>`<option value="${k}">${k}</option>`).join('')}</select>
</div>
</div>
<div class="tab-content" id="tab-data">
<div class="info-strip"><label class="control-label">åŠ‡æœ¬ Sheet ID:</label>
<input id="sheet-id" placeholder="Google Sheet CSV ID">
</div>
<button class="btn-gold" onclick="saveAll()">å„²å­˜é…ç½®</button>
<button class="btn-gold" onclick="loadAll()">è¼‰å…¥é…ç½®</button>
<button class="btn-gold" id="rec-btn" onclick="toggleRec()">ğŸ”´ é–‹å§‹éŒ„å½±</button>
<button class="btn-gold" id="pause-btn" onclick="handlePause()">â¸ æš«åœ</button>
<button class="btn-gold" onclick="generateThumbnail()">ğŸ“¸ ç”Ÿæˆç¸®åœ–</button>
<button class="btn-gold" onclick="openYouTubeUpload()">ğŸ“¤ æ‰“é–‹ YouTube ä¸Šå‚³</button>
<div id="console-log"></div>
</div>
</div>
<button class="btn-toggle-ui" onclick="toggleUI()">éš±è—æ§åˆ¶é¢æ¿</button>
<div id="stage" class="stage">
<div id="container-main" class="draggable-box"></div>
<div id="subtitle-box" class="draggable-box bubble-hidden">
<div class="bubble-svg"></div>
<div class="bubble-text">é€™è£¡é¡¯ç¤ºå­—å¹•</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
// Tab æ§åˆ¶
document.querySelectorAll('.tab-btn').forEach(btn=>{
btn.addEventListener('click',()=>{document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
btn.classList.add('active'); const tab=document.getElementById(btn.dataset.tab);
document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
tab.classList.add('active');
});
});
document.getElementById('bg-select').addEventListener('change',(e)=>{applyBG(e.target.value);document.getElementById('bg-manual-url').value=e.target.value;});
document.getElementById('voffset-range').addEventListener('input',(e)=>{document.getElementById('v-val').innerText=e.target.value;});
bindControls(document.getElementById('container-main'),'char');
bindControls(document.getElementById('subtitle-box'),'sub');
loadAll();
initActor();
</script>
`);
</script>
</body>
</html>
