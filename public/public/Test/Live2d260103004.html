<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>é‡‘è¼å’–å•¡å»³ V21 - èƒŒæ™¯åˆ‡æ›ä¿®å¾©ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --gold-light:#fef3c7;
            --gold-main:#fbbf24;
            --gold-dark:#b45309;
            --panel-bg:rgba(251,191,36,.96);
        }
        html,body{
            height:100%;margin:0;
            background:#000;
            font-family:"PingFang TC","Microsoft JhengHei",sans-serif;
            overflow:hidden;font-size:.5rem;
        }
        #dynamic-bg{
            position:fixed;inset:0;z-index:-5;
            background-size:cover;
            background-position:center;
            background-repeat:no-repeat;
            transition:background-image .6s ease-in-out;
        }
        .gold-texture{
            position:fixed;inset:0;z-index:-4;
            background-image:url('https://www.transparenttextures.com/patterns/gold-glitter.png');
            opacity:.25;pointer-events:none;mix-blend-mode:screen;
        }
        .main-ui{display:flex;flex-direction:column;height:100vh;z-index:10}
        .ui-header{
            padding:5px 12px;background:var(--panel-bg);
            border-bottom:2px solid #fff;
            box-shadow:0 4px 15px rgba(180,83,9,.5);
        }
        .stage{flex:1;display:flex;align-items:flex-end;justify-content:space-around}
        iframe{width:50%;height:100%;border:none;background:transparent}
        .btn-gold{
            background:linear-gradient(#fff,var(--gold-main));
            border:1px solid var(--gold-dark);
            padding:2px 8px;border-radius:4px;
            font-weight:900;font-size:.5rem;
        }
        #console-log{
            height:42px;overflow:auto;background:rgba(255,255,255,.88);
            padding:4px;border:1px inset var(--gold-dark);border-radius:4px;
        }
        #btn-download{
            position:fixed;right:12px;bottom:12px;z-index:3000;
            background:#059669;color:#fff;border-radius:20px;
            font-size:.5rem;padding:4px 15px;font-weight:bold;
        }
        input{
            background:#fff;border:1px solid var(--gold-dark);
            font-size:.5rem;padding:2px 6px;border-radius:4px;
        }
        .info-strip{
            background:rgba(255,255,255,.4);
            border-radius:4px;padding:2px 8px;margin-top:4px;
            display:flex;gap:8px;align-items:center;
        }
        #script-line{
            font-style:italic;font-weight:bold;
            overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;
        }
    </style>
</head>
<body>

<div id="dynamic-bg"></div>
<div class="gold-texture"></div>

<button id="btn-download" onclick="downloadV21()">ğŸ’¾ ä¸‹è¼‰ V21 ç¨‹å¼ç¢¼</button>

<div class="main-ui">
    <div class="ui-header">
        <div class="flex justify-between items-center">
            <span class="font-bold">âœ¨ é‡‘è¼åŠ‡æœ¬è¦–ç•Œ V21</span>
            <div class="flex gap-1">
                <button class="btn-gold" onclick="runDrama()">å•Ÿå‹•åŠ‡æœ¬</button>
                <button class="btn-gold" onclick="location.reload()">é‡æ–°æ•´ç†</button>
            </div>
        </div>

        <div class="flex gap-2 items-center mt-1">
            <span class="font-bold">Sheet ID</span>
            <input id="sheet-id" class="flex-grow"
              value="15h6v7zh05fbtNfoauduL9OjpzF8pIeMl86JR9Y9aZbU">
            <button class="btn-gold" onclick="document.getElementById('bg-upload').click()">ğŸ“· ä¸Šå‚³èƒŒæ™¯</button>
            <input id="bg-upload" type="file" hidden accept="image/*" onchange="uploadLocalBg(this)">
        </div>

        <div class="info-strip">
            <span id="p-status">IDLE</span>
            <div id="script-line">ç­‰å¾…åŠ‡æœ¬å•Ÿå‹•â€¦</div>
        </div>

        <div class="flex gap-1 mt-1 flex-wrap">
            <button class="btn-gold" onclick="updateBg('gold')">ğŸ’° é‡‘è¼</button>
            <button class="btn-gold" onclick="updateBg('day')">â˜€ï¸ æ™¨é–“</button>
            <button class="btn-gold" onclick="updateBg('dusk')">ğŸŒ† é»ƒæ˜</button>
            <button class="btn-gold" onclick="updateBg('night')">ğŸŒ™ éœå¤œ</button>
        </div>

        <div id="console-log">ç³»çµ±å°±ç·’ã€‚</div>
    </div>

    <div class="stage">
        <iframe id="char-left"></iframe>
        <iframe id="char-right"></iframe>
    </div>
</div>

<script>
const logger=document.getElementById('console-log');
const bgContainer=document.getElementById('dynamic-bg');

const THEMES={
gold:"https://images.unsplash.com/photo-1590283603385-17ffb3a7f29f?q=80&w=2400",
day:"https://images.unsplash.com/photo-1554118811-1e0d58224f24?q=80&w=2400",
dusk:"https://images.unsplash.com/photo-1511920170033-f8396924c348?q=80&w=2400",
night:"https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&w=2400"
};

function sysMsg(t){
const d=document.createElement('div');
d.textContent="â€¢ "+t;
logger.prepend(d);
}

/* âœ… ä¿®å¾©å¾ŒèƒŒæ™¯åˆ‡æ›ï¼ˆå”¯ä¸€ä¿®æ”¹è™•ï¼‰ */
function updateBg(key){
const url=THEMES[key];
if(!url)return;
bgContainer.style.backgroundImage="none";
void bgContainer.offsetHeight;   // å¼·åˆ¶ reflow
const img=new Image();
img.onload=()=>{
bgContainer.style.backgroundImage=`url('${url}')`;
sysMsg("èƒŒæ™¯åˆ‡æ›ï¼š"+key);
};
img.src=url;
}

function uploadLocalBg(input){
if(input.files&&input.files[0]){
const r=new FileReader();
r.onload=e=>{
bgContainer.style.backgroundImage=`url('${e.target.result}')`;
sysMsg("å·²ä½¿ç”¨è‡ªè¨‚èƒŒæ™¯");
};
r.readAsDataURL(input.files[0]);
}
}

const CHARS=[
{id:"left",path:"https://unpkg.com/live2d-widget-model-shizuku@1.0.5/assets/shizuku.model.json"},
{id:"right",path:"https://unpkg.com/live2d-widget-model-koharu@1.0.5/assets/koharu.model.json"}
];

function createCharHTML(path,side){
return `<!DOCTYPE html><html><head>
<script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/lib/L2Dwidget.min.js"></script>
<style>
body{margin:0;overflow:hidden;background:transparent}
#pop{position:fixed;top:10%;${side==="left"?"right":"left"}:20px;
background:#fff;border:2px solid #b45309;padding:10px;
font-size:15px;font-weight:bold;display:none;max-width:80%}
</style></head><body>
<div id="pop"></div>
<script>
L2Dwidget.init({model:{jsonPath:"${path}"},
display:{position:"center",width:window.innerWidth*.9,height:window.innerHeight*.85}});
window.addEventListener("message",e=>{
if(e.data.text){
const p=document.getElementById("pop");
p.innerText=e.data.text;p.style.display="block";
setTimeout(()=>p.style.display="none",Math.max(3000,e.data.text.length*400));
}});
</script></body></html>`;
}

function initTheatre(){
CHARS.forEach(c=>{
const f=document.getElementById("char-"+c.id);
const d=f.contentWindow.document;
d.open();d.write(createCharHTML(c.path,c.id));d.close();
});
updateBg("gold");
}

let playing=false;
async function runDrama(){
if(playing)return;
playing=true;
document.getElementById("p-status").innerText="PLAYING";
const sid=document.getElementById("sheet-id").value.trim();
const csv=await fetch(`https://docs.google.com/spreadsheets/d/${sid}/export?format=csv&gid=0`).then(r=>r.text());
const rows=csv.split(/\r?\n/).slice(1).filter(Boolean);

for(const r of rows){
const c=r.split(",");
const role=(c[0]||"").toLowerCase();
const text=(c[1]||"").replace(/"/g,"");
const bg=c[4]?c[4].trim().toLowerCase():null;
if(bg)updateBg(bg);
document.getElementById("script-line").innerText=text;
const isR=role.includes("right")||role.includes("koharu")||role.includes("hibiki");
document.getElementById(isR?"char-right":"char-left")
.contentWindow.postMessage({text},"*");
await new Promise(res=>setTimeout(res,Math.max(5000,text.length*400)));
}
playing=false;
document.getElementById("p-status").innerText="IDLE";
}

function downloadV21(){
const b=new Blob([document.documentElement.outerHTML],{type:"text/html"});
const a=document.createElement("a");
a.href=URL.createObjectURL(b);
a.download="Golden_Cafe_V21_Fixed.html";
a.click();
}

window.onload=()=>setTimeout(initTheatre,600);
</script>
</body>
</html>
