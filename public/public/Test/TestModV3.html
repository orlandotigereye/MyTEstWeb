<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¹™å·³é›†æˆæ¨ç®— V11 - æ·±åº¦å…¨æ•¸æ“šç‰ˆ</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@latest/astronomy.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --bg-gold: #FFFDE7; --main-gold: #D4AF37; --deep-gold: #B8860B; --coin-gold: #FFD700; --text-brown: #3E2723; --gold-grad: linear-gradient(135deg, #FFD700 0%, #FFF176 50%, #DAA520 100%); --font-size: 0.5rem; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: var(--bg-gold) url('https://www.transparenttextures.com/patterns/gold-dust.png') fixed; color: var(--text-brown); font-size: var(--font-size); width: 100vw; overflow-x: hidden; }
        header { height: 40px; background: var(--gold-grad); display: flex; justify-content: space-between; align-items: center; padding: 0 10px; border-bottom: 2px solid var(--deep-gold); position: sticky; top: 0; z-index: 1000; font-weight: 900; }
        .status-bar { background: rgba(255,255,255,0.9); padding: 5px; display: flex; gap: 8px; border-bottom: 1px solid var(--main-gold); font-size: 0.4rem; overflow-x: auto; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 2px; }
        .ok { background: #2E7D32; } .fail { background: #C62828; }
        .nav-tabs { display: flex; background: #FFF; border-bottom: 1px solid var(--main-gold); }
        .tab { flex: 1; text-align: center; padding: 12px 0; font-weight: 900; color: #A68B5A; cursor: pointer; }
        .tab.active { background: rgba(255, 215, 0, 0.2); border-bottom: 3px solid var(--deep-gold); color: var(--text-brown); }
        .content { padding: 10px; }
        .page { display: none; } .page.active { display: block; }
        .card { background: rgba(255,255,255,0.9); border: 1.5px solid var(--coin-gold); border-radius: 8px; padding: 10px; margin-bottom: 10px; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); }
        .title-gold { color: var(--deep-gold); font-weight: 900; margin-bottom: 6px; border-left: 3px solid var(--main-gold); padding-left: 6px; border-bottom: 1px solid rgba(184, 134, 11, 0.2); }
        textarea { width: 100%; height: 120px; border: 1px solid var(--main-gold); border-radius: 4px; padding: 6px; font-size: 0.5rem; background: #FFFEF9; font-family: monospace; }
        .btn-p { background: var(--gold-grad); border: 1px solid var(--deep-gold); color: var(--text-brown); font-weight: 900; padding: 10px; width: 100%; border-radius: 4px; cursor: pointer; margin-top: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .score-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin: 10px 0; }
        .score-item { background: #FFF; border: 1px solid var(--coin-gold); padding: 5px; text-align: center; border-radius: 4px; }
        .score-val { font-size: 0.8rem; font-weight: 900; color: var(--deep-gold); display: block; }
        .energy-bar-container { height: 12px; background: #eee; border-radius: 6px; overflow: hidden; margin: 4px 0; border: 1px solid #ddd; }
        .energy-bar { height: 100%; transition: width 0.5s; }
        .dl-btn { position: fixed; bottom: 10px; right: 10px; width: 45px; height: 45px; background: #000; color: #fff; border-radius: 50%; font-size: 0.4rem; z-index: 3000; border: 1px solid var(--coin-gold); }
        .report-text { white-space: pre-wrap; line-height: 1.5; font-size: 0.5rem; color: #444; }
    </style>
</head>
<body>
<header>ğŸ”± ä¹™å·³é›†æˆæ¨ç®— V11</header>
<div class="status-bar" id="mod-status"></div>
<nav class="nav-tabs"><div class="tab active" onclick="goTab(0)">æ¨æ¼”è¼¸å…¥</div><div class="tab" onclick="goTab(1)">å…¨æ•¸æ“šå ±å‘Š</div></nav>
<div class="content">
    <div id="p0" class="page active">
        <div class="card">
            <div class="title-gold">è§€æ¸¬æ•¸æ“šéŒ„å…¥</div>
            <textarea id="astroInput" placeholder="è«‹è²¼å…¥è§€æ¸¬æ•¸æ“šï¼Œä¾‹å¦‚ï¼š
æœ€è¿‘è¡Œæ˜Ÿ: Saturn
Saturn: 1.45 AU
æœˆç›¸: ä¸Šå¼¦
å¹²æ”¯: ä¹™å·³ æˆŠå­ ä¸å¯ ç™¸å¯
æœ¨:30 ç«:40 åœŸ:20 é‡‘:10 æ°´:50">æœ€è¿‘è¡Œæ˜Ÿ: Saturn
Saturn: 1.45
æœˆç›¸: ä¸Šå¼¦
å¹²æ”¯: ä¹™å·³ æˆŠå­ ä¸å¯ ç™¸å¯
æœ¨:30 ç«:40 åœŸ:20 é‡‘:15 æ°´:45</textarea>
            <button class="btn-p" onclick="runIntegratedAnalysis()">ğŸš€ å•Ÿå‹•é›†æˆå¼•æ“æ¨æ¼”</button>
        </div>
        <div class="card" id="error-note" style="display:none; color:red;"></div>
    </div>
    <div id="p1" class="page">
        <div class="card">
            <div class="title-gold">ã€äº”æ¨¡çµ„æ ¸å¿ƒåˆ¤åˆ†ã€‘</div>
            <div class="score-row">
                <div class="score-item"><span>å‡¶å‰å¾—åˆ†</span><span id="v-score" class="score-val">--</span></div>
                <div class="score-item"><span>æ€¥ç·©æŒ‡æ¨™</span><span id="v-urgency" class="score-val">--</span></div>
                <div class="score-item"><span>äº‹æ…‹å±¬æ€§</span><span id="v-type" class="score-val">--</span></div>
            </div>
        </div>
        <div class="card">
            <div class="title-gold">ã€èƒ½é‡èˆ‡é•·ç”Ÿåˆ†æã€‘</div>
            <div id="energy-zone"></div>
            <div id="stage-zone" style="margin-top:8px; font-weight:bold;"></div>
        </div>
        <div class="card">
            <div class="title-gold">ã€æ·±åº¦æ¨è«–åŸæ–‡ã€‘</div>
            <div id="full-report" class="report-text">ç­‰å¾…æ•¸æ“šéŒ„å…¥...</div>
        </div>
    </div>
</div>
<button class="dl-btn" onclick="downloadThis()">ä¸‹è¼‰<br>ä»£ç¢¼</button>

<script>
    let API_KEY = ""; let IS_AI_OK = false;
    const FIVE_ELEMENTS = { "ç”²":"æœ¨","ä¹™":"æœ¨","ä¸™":"ç«","ä¸":"ç«","æˆŠ":"åœŸ","å·±":"åœŸ","åºš":"é‡‘","è¾›":"é‡‘","å£¬":"æ°´","ç™¸":"æ°´" };
    const STAGE_MAP = { "ä¸™": { "å¯…":"é•·ç”Ÿ", "å¯":"æ²æµ´", "å­":"èƒ" }, "ä¸": { "å¯":"æ²æµ´", "å­":"èƒ", "å·³":"å¸æ—º" } };
    const ECI_CONST = { Planets: { "Mars": -7, "Saturn": -6, "Jupiter": 9, "Venus": 6, "Mercury": 5 }, Urgency: { "ä¸Šå¼¦": 33, "ä¸‹å¼¦": 67, "æ»¿æœˆ": 50, "æ–°æœˆ": 10 } };

    async function init() {
        try {
            const res = await fetch("https://orlandotigereye.github.io/mytestweb/config/api.js");
            const txt = await res.text();
            const match = txt.match(/"([a-fA-F0-9]+)"/);
            if(match) {
                API_KEY = decodeHex(match[1]);
                const check = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`);
                IS_AI_OK = check.ok;
            }
        } catch(e) { IS_AI_OK = false; }
        renderStatus();
    }

    function decodeHex(h){ let s=""; for(let i=0;i<h.length;i+=2) s+=String.fromCharCode(parseInt(h.substr(i,2),16)); return s; }
    function renderStatus(){
        const con = $('#mod-status').empty();
        con.append(`<span><i class="status-dot ${IS_AI_OK?'ok':'fail'}"></i>AI_Key</span>`);
        con.append(`<span><i class="status-dot ok"></i>ä¹™å·³V10.5</span>`);
        con.append(`<span><i class="status-dot ok"></i>é›†æˆæ¨¡çµ„J</span>`);
    }

    function runIntegratedAnalysis() {
        const raw = $('#astroInput').val();
        if(!raw.trim()) return;

        // 1. è§£ææ•¸æ“š (ä¾†è‡ª God251224_J é‚è¼¯)
        const moonPhase = raw.match(/æœˆç›¸[ï¼š\s]*(.*)/)?.[1]?.trim() || "æœªçŸ¥";
        const gzMatch = raw.match(/å¹²æ”¯[ï¼š\s]*(.*)/);
        const gzParts = gzMatch ? gzMatch[1].trim().split(/\s+/) : ["ä¹™å·³","æˆŠå­","ä¸å¯","ç™¸å¯"];
        const energies = {
            æœ¨: parseInt(raw.match(/æœ¨:(\d+)/)?.[1] || 0),
            ç«: parseInt(raw.match(/ç«:(\d+)/)?.[1] || 0),
            åœŸ: parseInt(raw.match(/åœŸ:(\d+)/)?.[1] || 0),
            é‡‘: parseInt(raw.match(/é‡‘:(\d+)/)?.[1] || 0),
            æ°´: parseInt(raw.match(/æ°´:(\d+)/)?.[1] || 0)
        };

        // 2. ä¹™å·³å åˆ¤åˆ† (ä¾†è‡ª ä¹™å·³å _V10_5 é‚è¼¯)
        let score = 0;
        Object.entries(ECI_CONST.Planets).forEach(([p, v]) => { if(raw.includes(p)) score += v; });
        let urgency = ECI_CONST.Urgency[moonPhase] || 50;

        // 3. é•·ç”Ÿæ¨ç®—
        const riGan = gzParts[2] ? gzParts[2][0] : "ä¸";
        const shiZhi = gzParts[3] ? gzParts[3][1] : "å¯";
        const stage = STAGE_MAP[riGan]?.[shiZhi] || "å¹³";

        // æ›´æ–° UI
        $('#v-score').text((score > 0 ? "+" : "") + score);
        $('#v-urgency').text(urgency);
        $('#v-type').text(urgency > 60 ? "æ€¥åŠ‡è®Šé©" : "ç©©å®šç™¼å±•");

        // æ¸²æŸ“äº”è¡Œèƒ½é‡åœ–
        let eHtml = "";
        const colors = { æœ¨:"#10b981", ç«:"#ef4444", åœŸ:"#f59e0b", é‡‘:"#94a3b8", æ°´:"#3b82f6" };
        Object.entries(energies).forEach(([k, v]) => {
            eHtml += `<div>${k}: ${v}%</div><div class="energy-bar-container"><div class="energy-bar" style="width:${v}%; background:${colors[k]}"></div></div>`;
        });
        $('#energy-zone').html(eHtml);
        $('#stage-zone').html(`é•·ç”Ÿç‹€æ…‹ï¼š${riGan}è¦‹${shiZhi} â” <span style="color:var(--deep-gold)">${stage}</span>`);

        // ç”Ÿæˆå ±å‘Š
        let rpt = `ã€é›†æˆæ¨è«–çµæœã€‘\n`;
        rpt += `â— ä¹™å·³å ï¼šå¾—åˆ† ${score}ï¼Œç•¶å‰æ°£æ•¸ç‚º${score >= 0 ? 'æ—º' : 'è¡°'}ã€‚\n`;
        rpt += `â— äº‹æ…‹ï¼šæ€¥ç·©åº¦ç‚º ${urgency}ï¼Œå»ºè­°${urgency > 50 ? 'é€Ÿæ±ºä»¥å…å¤œé•·å¤¢å¤š' : 'éœå¾…æ™‚æ©Ÿæˆç†Ÿ'}ã€‚\n`;
        rpt += `â— å‘½ç†ï¼šæ—¥å¹²${riGan}è™•æ–¼${stage}ä½ï¼Œèƒ½é‡æµå‹•ä»¥${Object.keys(energies).reduce((a,b)=>energies[a]>energies[b]?a:b)}ç‚ºä¸»å°ã€‚\n`;
        rpt += `â— ç¶œåˆï¼šå¤©æ™‚èˆ‡åœ°æ°£${(score > 0 && stage !== 'èƒ') ? 'æ„Ÿæ‡‰è‰¯å¥½ï¼Œå¤§å‰ä¹‹å…†' : 'ç¨æœ‰æ»¯ç¤™ï¼Œå®œä¿å®ˆè¡Œäº‹'}ã€‚`;
        
        $('#full-report').text(rpt);
        goTab(1);
    }

    function goTab(i){ $('.page').removeClass('active'); $(`#p${i}`).addClass('active'); $('.tab').removeClass('active').eq(i).addClass('active'); }
    function downloadThis(){ const b=new Blob([document.documentElement.outerHTML],{type:'text/html'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='Integrated_Astro_V11.html'; a.click(); }
    $(document).ready(init);
</script>
</body>
</html>
