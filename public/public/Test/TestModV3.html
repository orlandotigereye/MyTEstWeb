<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é‡‘ç¢§åå…¨ Pro - å®¹éŒ¯å¼·åŒ–ç‰ˆ</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@latest/astronomy.browser.min.js"></script>
    <script src="https://orlandotigereye.github.io/mytestweb/public/public/core.js"></script>
    <style>
        :root { --bg-gold: #FFFDE7; --main-gold: #D4AF37; --deep-gold: #B8860B; --coin-gold: #FFD700; --text-brown: #3E2723; --gold-grad: linear-gradient(135deg, #FFD700 0%, #FFF176 50%, #DAA520 100%); --font-size: 0.5rem; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg-gold) url('https://www.transparenttextures.com/patterns/gold-dust.png') fixed; color: var(--text-brown); font-size: var(--font-size); line-height: 1.4; width: 100vw; overflow-x: hidden; }
        header { height: 45px; background: var(--gold-grad); display: flex; justify-content: space-between; align-items: center; padding: 0 10px; border-bottom: 2px solid var(--deep-gold); position: sticky; top: 0; z-index: 1000; }
        .status-bar { background: rgba(255,255,255,0.9); padding: 5px; display: flex; gap: 8px; border-bottom: 1px solid var(--main-gold); font-size: 0.4rem; overflow-x: auto; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 2px; }
        .ok { background: #2E7D32; } .fail { background: #C62828; } .wait { background: #F9A825; }
        .nav-tabs { display: flex; background: #FFF; border-bottom: 1px solid var(--main-gold); }
        .tab { flex: 1; text-align: center; padding: 10px 0; font-weight: 900; color: #A68B5A; cursor: pointer; font-size: var(--font-size); }
        .tab.active { background: rgba(255, 215, 0, 0.2); border-bottom: 3px solid var(--deep-gold); color: var(--text-brown); }
        .content { padding: 10px; padding-bottom: 20px; }
        .page { display: none; } .page.active { display: block; }
        .card { background: rgba(255,255,255,0.9); border: 1.5px solid var(--coin-gold); border-radius: 8px; padding: 10px; margin-bottom: 10px; }
        .title-gold { color: var(--deep-gold); font-weight: 900; margin-bottom: 6px; border-left: 3px solid var(--main-gold); padding-left: 6px; }
        textarea { width: 100%; height: 80px; border: 1px solid var(--main-gold); border-radius: 4px; padding: 6px; font-size: var(--font-size); background: #FFFEF9; }
        .btn { border: none; border-radius: 4px; font-weight: 900; font-size: var(--font-size); cursor: pointer; padding: 10px; width: 100%; margin-top: 10px; }
        .btn-p { background: var(--gold-grad); border: 1px solid var(--deep-gold); color: var(--text-brown); }
        .visual-item { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
        .visual-box { flex: 0 0 45%; aspect-ratio: 1/1; background: #000; position: relative; border-radius: 4px; border: 1px solid var(--main-gold); }
        .visual-box img { width: 100%; height: 100%; object-fit: cover; }
        .visual-summary { flex: 1; font-weight: bold; text-align: right; border-right: 3px solid var(--coin-gold); padding-right: 5px; }
        .error-note { background: #FFEBEE; border: 1px solid #FFCDD2; padding: 8px; border-radius: 4px; margin-top: 10px; color: #C62828; font-size: 0.45rem; }
        .dl-btn { position: fixed; bottom: 10px; right: 10px; width: 45px; height: 45px; background: #000; color: #fff; border-radius: 50%; font-size: 0.4rem; z-index: 3000; border: 1px solid var(--coin-gold); }
    </style>
</head>
<body>
<header><div style="font-weight:900;">ğŸ”± åå…¨ Core Pro</div><div id="json-info" style="font-size:0.4rem;"></div></header>
<div class="status-bar" id="mod-status"></div>
<nav class="nav-tabs"><div class="tab active" onclick="goTab(0)">æ¨æ¼”</div><div class="tab" onclick="goTab(1)">å ±å‘Š</div><div class="tab" onclick="goTab(2)">æ„è±¡</div></nav>
<div class="content">
    <div id="p0" class="page active">
        <div class="card"><div class="title-gold">å¤©æ©Ÿè¼¸å…¥</div><textarea id="main-in">2025-12-27 å°åŒ— å¤©è±¡åˆ†æ</textarea><button class="btn btn-p" id="run-btn" onclick="runAnalysis()">ğŸš€ å•Ÿå‹•æ¨æ¼”</button></div>
        <div id="error-footer" class="error-note" style="display:none;"></div>
    </div>
    <div id="p1" class="page"><div class="card"><div class="title-gold">æ¨æ¼”å ±å‘Š</div><div id="out-report">ç­‰å¾…è¼¸å…¥...</div></div></div>
    <div id="p2" class="page">
        <div class="card"><div class="title-gold">ä¸‰æ‰æ„è±¡</div>
            <div class="visual-item"><div class="visual-box"><img id="v1"></div><div class="visual-summary" id="s1">...</div></div>
            <div class="visual-item"><div class="visual-box"><img id="v2"></div><div class="visual-summary" id="s2">...</div></div>
            <div class="visual-item"><div class="visual-box"><img id="v3"></div><div class="visual-summary" id="s3">...</div></div>
        </div>
    </div>
</div>
<button class="dl-btn" onclick="downloadThis()">ä¸‹è¼‰<br>ä»£ç¢¼</button>
<script>
    let API_KEY = ""; 
    let IS_KEY_VALID = false;
    const URL_API_CONFIG = "https://orlandotigereye.github.io/mytestweb/config/api.js";

    async function init(){
        try {
            const res = await fetch(URL_API_CONFIG);
            const txt = await res.text();
            const match = txt.match(/"([a-fA-F0-9]+)"/);
            if(match) {
                API_KEY = decodeHex(match[1]);
                const check = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`);
                IS_KEY_VALID = check.ok;
            }
        } catch(e) { IS_KEY_VALID = false; }
        
        await Core.initAll();
        renderStatus();
        checkFailures();
    }

    function decodeHex(h){ let s=""; for(let i=0;i<h.length;i+=2) s+=String.fromCharCode(parseInt(h.substr(i,2),16)); return s; }

    function renderStatus(){
        const con = $('#mod-status').empty();
        con.append(`<span><i class="status-dot ${IS_KEY_VALID?'ok':'fail'}"></i>AI_Key</span>`);
        if(Core.modules) Object.entries(Core.modules).forEach(([k,v])=>{ con.append(`<span><i class="status-dot ${v.status?'ok':'fail'}"></i>${k}</span>`); });
    }

    function checkFailures(){
        let msg = [];
        if(!IS_KEY_VALID) msg.push("âš ï¸ Gemini AI ç§˜é‘°ç„¡æ•ˆï¼šç„¡æ³•ä½¿ç”¨ AI è‡ªå‹•åˆ†æåŠ Imagen æ„è±¡ç”Ÿæˆã€‚");
        if(Core.data && !Core.data.astro) msg.push("âš ï¸ æ˜Ÿè±¡å­—å…¸è¼‰å…¥å¤±æ•—ï¼šç„¡æ³•æ¯”å°å°ˆæ¥­æ˜Ÿè±¡æ•¸æ“šã€‚");
        if(msg.length > 0) $('#error-footer').html(msg.join('<br>')).show();
    }

    async function runAnalysis(){
        const input = $('#main-in').val();
        if(!IS_KEY_VALID) {
            $('#out-report').html("<b>[æœ¬åœ°æ¨¡å¼é‹ä½œ]</b><br>AI å¯†é‘°ç„¡æ•ˆï¼Œæ”¹ç”¨æ˜Ÿè±¡å­—å…¸æœ¬åœ°åŒ¹é…...<br>" + (Core.data?.astro ? "æ˜Ÿè±¡è³‡æ–™å·²å°±ç·’ï¼Œå»ºè­°æ‰‹å‹•å°ç…§ã€‚" : "å­—å…¸äº¦ä¸å¯ç”¨ã€‚"));
            goTab(1); return;
        }
        $('#run-btn').prop('disabled', true).text('âŒ› é‹ç®—ä¸­...');
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ contents:[{parts:[{text: `åˆ†æï¼š${input}ã€‚å›å‚³JSON:{"report":"..","p1":"..","s1":"..","p2":"..","s2":"..","p3":"..","s3":".."}`}]}], generationConfig:{responseMimeType:"application/json"} })
            });
            const d = await res.json();
            const r = JSON.parse(d.candidates[0].content.parts[0].text);
            $('#out-report').html(r.report);
            $('#s1').text(r.s1); $('#s2').text(r.s2); $('#s3').text(r.s3);
            [1,2,3].forEach(i => genImg(i, r['p'+i]));
            goTab(1);
        } catch(e) { $('#out-report').text("é‹ç®—å¤±æ•—: " + e.message); }
        finally { $('#run-btn').prop('disabled', false).text('ğŸš€ å•Ÿå‹•æ¨æ¼”'); }
    }

    async function genImg(idx, p){
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-001:predict?key=${API_KEY}`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ instances:[{prompt:"Gold style, "+p}], parameters:{sampleCount:1} })
            });
            const d = await res.json();
            if(d.predictions) $(`#v${idx}`).attr('src', `data:image/png;base64,${d.predictions[0].bytesBase64Encoded}`);
        } catch(e){}
    }

    function goTab(i){ $('.page').removeClass('active'); $(`#p${i}`).addClass('active'); $('.tab').removeClass('active').eq(i).addClass('active'); }
    function downloadThis(){ const b=new Blob([document.documentElement.outerHTML],{type:'text/html'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='Golden_Core_Fix.html'; a.click(); }
    $(document).ready(init);
</script>
</body>
</html>
