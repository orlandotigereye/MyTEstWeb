<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>é‡‘ç¢§è¼ç…Œãƒ»å¤©è±¡é›†æˆ G-4.5 (API ä¿®æ­£ç‰ˆ)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- æ ¸å¿ƒä¾è³´åº« -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@latest/astronomy.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>

    <style>
        :root {
            --base-gold: #FFFDF0; 
            --royal-gold: #C5A059;
            --bright-gold: #FFD700;
            --text-gold: #8B6B23;
            --panel-gold: rgba(255, 250, 240, 0.98);
            --border-gold: #E2C08D;
            --font-nano: 0.5rem; /* åš´æ ¼ 0.5rem */
            --shadow-gold: 0 12px 40px rgba(197, 160, 89, 0.3);
            --gold-gradient: linear-gradient(135deg, #D4AF37 0%, #FCF6BA 20%, #D4AF37 40%, #FBF5B7 60%, #AA771C 80%, #FCF6BA 100%);
            --coin-bg: url('https://www.transparenttextures.com/patterns/gold-dust.png');
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }

        body {
            font-family: 'PingFang TC', 'Noto Sans TC', sans-serif;
            background-color: var(--base-gold);
            background-image: var(--coin-bg);
            color: var(--text-gold);
            font-size: var(--font-nano);
            line-height: 1.8;
            min-height: 100vh;
        }

        .header-bar {
            height: 60px; background: var(--gold-gradient);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; border-bottom: 3px solid var(--royal-gold);
            position: sticky; top: 0; z-index: 1000;
        }
        .header-title { font-size: 0.6rem; font-weight: 900; color: #3E2723; }

        .btn-action {
            background: #FFF; border: 1.5px solid var(--royal-gold);
            color: var(--text-gold); font-size: 0.5rem; font-weight: 900;
            padding: 6px 12px; border-radius: 4px; cursor: pointer;
        }

        .tab-nav {
            display: flex; background: #FFF; border-bottom: 1px solid var(--border-gold);
            position: sticky; top: 60px; z-index: 999;
        }
        .tab-btn {
            flex: 1; text-align: center; padding: 15px 0;
            font-size: var(--font-nano); font-weight: bold; cursor: pointer;
            border-bottom: 3px solid transparent; color: #A68B5A;
        }
        .tab-btn.active {
            color: #5D4037; background: rgba(255, 215, 0, 0.1);
            border-bottom: 3px solid var(--royal-gold);
        }

        .page-content { display: none; padding: 20px; max-width: 800px; margin: 0 auto; }
        .page-content.active { display: block; }

        .gold-card {
            background: var(--panel-gold); border: 1px solid var(--border-gold);
            border-radius: 12px; padding: 20px; margin-bottom: 20px;
            box-shadow: var(--shadow-gold);
        }
        .card-title {
            font-size: 0.55rem; font-weight: 900; margin-bottom: 15px;
            border-left: 4px solid var(--royal-gold); padding-left: 10px;
        }

        .diag-item { margin-bottom: 12px; }
        .diag-label { display: flex; justify-content: space-between; margin-bottom: 4px; font-weight: bold; }
        .diag-bar { height: 8px; background: #EEE; border-radius: 4px; overflow: hidden; }
        .diag-bar-inner { height: 100%; width: 0%; background: var(--gold-gradient); transition: width 0.3s; }
        .diag-status { font-size: 0.45rem; color: #998C71; }

        textarea {
            width: 100%; height: 200px; border: 1px solid var(--border-gold);
            padding: 15px; font-size: 0.5rem; border-radius: 8px; resize: none;
            background: #FFFEF9; outline: none;
        }

        .btn-main {
            width: 100%; margin-top: 15px; padding: 15px;
            background: var(--gold-gradient); border: none; border-radius: 8px;
            color: #3E2723; font-weight: 900; font-size: 0.6rem; cursor: pointer;
        }

        #report-output { white-space: pre-wrap; font-size: 0.5rem; color: #5D4037; }

        .report-tpl {
            width: 800px; background: #FFFDF0; padding: 60px;
            border: 20px solid var(--royal-gold); color: #3E2723;
            font-family: serif; position: relative;
        }
        #offscreen-container { position: absolute; left: -9999px; }
    </style>
</head>
<body>

<header class="header-bar">
    <div class="header-title">G-CORE 4.5 REMOTE MASTER (FIXED)</div>
    <button class="btn-action" onclick="downloadCode()">ğŸ’¾ ä¸‹è¼‰ç¨‹å¼ç¢¼</button>
</header>

<nav class="tab-nav">
    <div class="tab-btn active" onclick="showTab(0)">æ ¸å¿ƒè¨ºæ–·</div>
    <div class="tab-btn" onclick="showTab(1)">æ•¸æ“šè¼¸å…¥</div>
    <div class="tab-btn" onclick="showTab(2)">æ ¸ç®—çµæœ</div>
</nav>

<main id="tab-0" class="page-content active">
    <div class="gold-card">
        <div class="card-title">âšœï¸ æ ¸å¿ƒèˆ‡å¯†é‘°æª¢æ¸¬</div>
        <div class="diag-item" id="diag-api">
            <div class="diag-label"><span>é ç«¯ API KEY è§£å¯†</span><span class="diag-status">ç­‰å¾…ä¸­...</span></div>
            <div class="diag-bar"><div class="diag-bar-inner"></div></div>
        </div>
        <div class="diag-item" id="diag-cjk">
            <div class="diag-label"><span>CJK Lite å­—å…¸</span><span class="diag-status">ç­‰å¾…ä¸­...</span></div>
            <div class="diag-bar"><div class="diag-bar-inner"></div></div>
        </div>
        <div class="diag-item" id="diag-astro">
            <div class="diag-label"><span>æ˜Ÿè±¡åˆä½µè³‡æ–™</span><span class="diag-status">ç­‰å¾…ä¸­...</span></div>
            <div class="diag-bar"><div class="diag-bar-inner"></div></div>
        </div>
        <div id="system-msg" style="margin-top:15px; font-weight:bold;"></div>
    </div>
</main>

<main id="tab-1" class="page-content">
    <div class="gold-card">
        <div class="card-title">ğŸ“¡ è§€æ¸¬æ•¸æ“šè¼¸å…¥</div>
        <textarea id="obs-input" placeholder="è«‹è¼¸å…¥æ¬²æ ¸ç®—ä¹‹å…§å®¹..."></textarea>
        <button class="btn-main" id="btn-submit" onclick="startAnalyze()">å•Ÿå‹•æ ¸å¿ƒæ ¸ç®—</button>
    </div>
</main>

<main id="tab-2" class="page-content">
    <div id="report-output">
        <div class="gold-card" style="text-align:center;">å°šç„¡æ ¸ç®—è³‡æ–™</div>
    </div>
</main>

<div id="offscreen-container">
    <div id="tpl-main" class="report-tpl">
        <h1 id="tpl-title" style="text-align:center; font-size:40px;"></h1>
        <div id="tpl-content" style="font-size:20px; margin-top:30px;"></div>
    </div>
</div>

<script>
/**
 * æ ¸å¿ƒé…ç½®èˆ‡å…¨å±€ç‹€æ…‹
 */
let API_KEY = "";
const URL_API = "https://orlandotigereye.github.io/mytestweb/config/api.js";
const URL_CJK = "https://raw.githubusercontent.com/orlandotigereye/mytestweb/4ea567726353330f2301bca768a6325ab5611699/public/public/Dictionary_lite.json"; 
const URL_ASTRO = "https://raw.githubusercontent.com/orlandotigereye/Analy13/refs/heads/main/astrology_merged.json";

let DB_CJK = null;
let DB_ASTRO = null;

function updateDiag(id, per, txt, err = null) {
    const $e = $(`#diag-${id}`);
    $e.find('.diag-bar-inner').css('width', per + '%');
    $e.find('.diag-status').text(txt);
    if(err) $e.append(`<div style="color:red;font-size:8px;">Error: ${err}</div>`);
}

function decodeHex(hex) {
    try {
        let s = "";
        for (let i = 0; i < hex.length; i += 2) s += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
        return s;
    } catch(e) { return ""; }
}

/**
 * æŒ‡æ•¸é€€é¿é‡è©¦ Fetch
 */
async function fetchWithRetry(url, options = {}, retries = 5, backoff = 1000) {
    try {
        const response = await fetch(url, options);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
    } catch (error) {
        if (retries > 0) {
            await new Promise(res => setTimeout(res, backoff));
            return fetchWithRetry(url, options, retries - 1, backoff * 2);
        }
        throw error;
    }
}

/**
 * ç³»çµ±åˆå§‹åŒ–
 */
async function initSystem() {
    // 1. æŠ“å–é ç«¯ API KEY
    try {
        updateDiag('api', 30, 'ç²å– hex...');
        const res = await fetch(URL_API);
        const text = await res.text();
        // åŒ¹é…è…³æœ¬ä¸­çš„ Hex å­—ä¸² (ä¾‹å¦‚ const _KEY = "414243...")
        const match = text.match(/"([a-fA-F0-9]+)"/);
        if(match && match[1]) {
            API_KEY = decodeHex(match[1]);
            updateDiag('api', 100, 'è§£ç¢¼æˆåŠŸ');
        } else {
            // å¦‚æœæ²’æŠ“åˆ°ï¼Œé è¨­ API_KEY ç‚ºç©ºï¼Œç”±å¾Œç«¯ç’°å¢ƒè‡ªå‹•è£œæ­£
            API_KEY = typeof __apiKey !== 'undefined' ? __apiKey : "";
            updateDiag('api', 100, 'ä½¿ç”¨ç’°å¢ƒé è¨­');
        }
    } catch (e) {
        updateDiag('api', 100, 'é ç«¯è·³éï¼Œä½¿ç”¨ç’°å¢ƒé è¨­');
    }

    // 2. æŠ“å–å­—å…¸
    try {
        updateDiag('cjk', 50, 'è®€å–ä¸­...');
        const data = await fetchWithRetry(URL_CJK);
        DB_CJK = data;
        updateDiag('cjk', 100, 'å®Œæˆ');
    } catch (e) {
        updateDiag('cjk', 0, 'è¼‰å…¥å¤±æ•—', e.message);
    }

    // 3. æŠ“å–æ˜Ÿè±¡
    try {
        updateDiag('astro', 50, 'è®€å–ä¸­...');
        const data = await fetchWithRetry(URL_ASTRO);
        DB_ASTRO = data;
        updateDiag('astro', 100, 'å®Œæˆ');
    } catch (e) {
        updateDiag('astro', 0, 'è¼‰å…¥å¤±æ•—', e.message);
    }

    if(DB_CJK && DB_ASTRO) {
        $('#system-msg').html('<span style="color:green">âœ¨ æ ¸å¿ƒå…¨éƒ¨å°±ç·’ï¼Œè«‹é–‹å§‹è§€æ¸¬ã€‚</span>');
    }
}

/**
 * å•Ÿå‹•æ ¸ç®—
 */
async function startAnalyze() {
    const input = $('#obs-input').val().trim();
    if(!input) return;
    if(!API_KEY && typeof __apiKey === 'undefined') {
        $('#system-msg').html('<span style="color:red">âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°æœ‰æ•ˆçš„ API KEY</span>');
        return;
    }

    const finalKey = API_KEY || (typeof __apiKey !== 'undefined' ? __apiKey : "");
    const $btn = $('#btn-submit');
    $btn.prop('disabled', true).text('æ ¸ç®—ä¸­...');

    const prompt = `ä½ æ˜¯ä¸€ä½é‡‘ç‰Œå¤©è±¡å°ˆå®¶ï¼Œè«‹åˆ†æä»¥ä¸‹å…§å®¹ä¸¦ä»¥ JSON æ ¼å¼å›å‚³ (åŒ…å« title, content æ¬„ä½)ï¼š\n${input}`;

    try {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${finalKey}`;
        const result = await fetchWithRetry(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            })
        });

        const parsed = JSON.parse(result.candidates[0].content.parts[0].text);
        renderReport(parsed);
        showTab(2);
    } catch (e) {
        $('#system-msg').html(`<span style="color:red">âŒ æ ¸ç®—å¤±æ•—: ${e.message} (è«‹æª¢æŸ¥ API Key æ˜¯å¦æœ‰æ•ˆ)</span>`);
    } finally {
        $btn.prop('disabled', false).text('å•Ÿå‹•æ ¸å¿ƒæ ¸ç®—');
    }
}

function renderReport(data) {
    const html = `
        <div class="gold-card">
            <div class="card-title">ğŸ’ ${data.title}</div>
            <div>${data.content}</div>
            <button class="btn-main" onclick="exportImage('${data.title}')">å°å‡ºé«˜æ¸…åœ–å ±</button>
        </div>
    `;
    $('#report-output').html(html);
    $('#tpl-title').text(data.title);
    $('#tpl-content').text(data.content);
}

async function exportImage(name) {
    const canvas = await html2canvas(document.getElementById('tpl-main'), { scale: 2 });
    const link = document.createElement('a');
    link.download = `${name}.png`;
    link.href = canvas.toDataURL();
    link.click();
}

function showTab(idx) {
    $('.page-content').removeClass('active');
    $(`#tab-${idx}`).addClass('active');
    $('.tab-btn').removeClass('active').eq(idx).addClass('active');
}

function downloadCode() {
    const blob = new Blob([document.documentElement.outerHTML], { type: 'text/html' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "G45_REMOTE_FIXED.html";
    a.click();
}

$(document).ready(() => {
    initSystem();
});
</script>
</body>
</html>
