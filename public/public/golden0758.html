<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>é‡‘ç¢§å¤©è±¡ G-4.5 TEMPLATE STABLE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- å¤–éƒ¨ä¾è³´åº« -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@latest/astronomy.browser.min.js"></script>
    <style>
        :root {
            --bg-gold: #FDF5E6;
            --main-gold: #C5A059;
            --gold-grad: linear-gradient(135deg, #D4AF37 0%, #FCF6BA 50%, #AA771C 100%);
            --font-size: 0.4rem;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'PingFang TC', 'Noto Sans TC', sans-serif;
            margin: 0; padding: 0; background: var(--bg-gold); color: #5D4037;
            font-size: var(--font-size); overflow-x: hidden; width: 100vw;
            line-height: 1.6;
        }

        header {
            height: 60px; background: var(--gold-grad);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; border-bottom: 2px solid var(--main-gold);
            position: sticky; top: 0; z-index: 1000;
        }

        .logo-text { font-size: 0.45rem; font-weight: 900; color: #4E342E; }

        .nav-tabs {
            display: flex; background: #FFF; border-bottom: 1px solid var(--main-gold);
            position: sticky; top: 60px; z-index: 999;
        }
        .tab {
            flex: 1; text-align: center; padding: 12px 0;
            font-size: 0.36rem; font-weight: bold; color: #A68B5A; cursor: pointer;
        }
        .tab.active {
            color: #5D4037; background: rgba(197, 160, 89, 0.1);
            border-bottom: 3px solid #5D4037;
        }

        .content-area { padding: 12px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card {
            background: #FFF; border: 1.5px solid var(--main-gold);
            border-radius: 12px; padding: 15px; margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(197, 160, 89, 0.15);
        }
        .card-title {
            font-size: 0.4rem; font-weight: 900; margin-bottom: 10px;
            color: #5D4037; border-left: 4px solid var(--main-gold); padding-left: 8px;
        }

        textarea {
            width: 100%; height: 220px; border: 1px solid var(--main-gold);
            border-radius: 8px; padding: 10px; font-size: 0.38rem;
            color: #4E342E; resize: none; background: #FFFEFA;
        }

        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            font-weight: 900; font-size: 0.4rem; cursor: pointer; margin-top: 10px;
        }
        .btn-primary { background: var(--gold-grad); color: #4E342E; }
        .btn-secondary { background: #FFF; border: 1.5px solid var(--main-gold); color: var(--main-gold); }

        .diag-row { margin-bottom: 8px; font-size: 0.32rem; }
        .diag-bar-outer { width: 100%; height: 6px; background: #EEE; border-radius: 3px; overflow: hidden; margin-top: 4px; }
        .diag-bar-inner { width: 0%; height: 100%; background: var(--main-gold); transition: width 0.3s ease; }
        .diag-status { float: right; font-weight: bold; }

        #loading-overlay {
            position: fixed; inset: 0; background: rgba(253, 245, 230, 0.98);
            z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .loader { width: 40px; height: 40px; border: 4px solid #EEE; border-top-color: var(--main-gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #msg-stage { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 85%; pointer-events: none; }
        .toast { background: #4E342E; color: #FFF; padding: 10px 15px; border-radius: 20px; font-size: 0.32rem; text-align: center; margin-top: 5px; }

        .img-box { width: 100%; margin-top: 10px; border-radius: 8px; overflow: hidden; background: #000; display: flex; align-items: center; justify-content: center; min-height: 200px; }
        .img-box img { max-width: 100%; display: block; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="loader"></div>
    <div id="loader-msg" style="margin-top:15px; font-weight:900;">é›²ç«¯åŒæ­¥ä¸­...</div>
</div>

<div id="msg-stage"></div>

<div class="app-shell">
    <header>
        <div class="logo-text">ğŸ”± é‡‘ç¢§å¤©è±¡ G-4.5</div>
        <button class="btn btn-secondary" style="width:auto; padding:5px 12px; font-size:0.32rem; margin:0;" onclick="downloadCode()">ğŸ’¾ å°å‡º</button>
    </header>

    <nav class="nav-tabs">
        <div class="tab active" data-idx="0">å•Ÿå‹•</div>
        <div class="tab" data-idx="1">åˆ†æ</div>
        <div class="tab" data-idx="2">äº”è¡Œ</div>
        <div class="tab" data-idx="3">æ„è±¡</div>
        <div class="tab" data-idx="4">æ±ºç­–</div>
    </nav>

    <div class="content-area">
        <section id="p0" class="page active">
            <div class="card">
                <div class="card-title">ğŸŒ æ ¸å¿ƒæ•¸æ“šåŒæ­¥</div>
                <div class="diag-row" id="diag-api">
                    å¯†é‘°è§£æ <span class="diag-status">ç­‰å¾…</span>
                    <div class="diag-bar-outer"><div class="diag-bar-inner"></div></div>
                </div>
                <div class="diag-row" id="diag-cjk">
                    ä¸­æ–‡å­—å…¸ (10MB) <span class="diag-status">ç­‰å¾…</span>
                    <div class="diag-bar-outer"><div class="diag-bar-inner"></div></div>
                </div>
                <div class="diag-row" id="diag-astro">
                    æ˜Ÿè±¡å¤§æ•¸æ“š <span class="diag-status">ç­‰å¾…</span>
                    <div class="diag-bar-outer"><div class="diag-bar-inner"></div></div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ“¡ è§€æ¸¬ç¯„æœ¬è¼¸å…¥</div>
                <textarea id="main-in">æœˆâ†’æœ€è¿‘è¡Œæ˜Ÿ: Saturn | åœŸæ˜Ÿ (é®æ˜Ÿ): 8.2Â°
æœˆç›¸ï¼šä¸Šå¼¦
å¹²æ”¯ï¼šä¹™å·³ æˆŠå­æœˆ å·±å·³æ—¥ ç™¸é…‰æ™‚
å®¿æ›œï¼šè»«æœ¨èŸ¹ (æœ¨)
çŠ¯/å®ˆï¼šç¿¼ç«è›‡:çŠ¯ | è»«æœ¨èŸ¹:å®ˆ
äº”è¡Œåˆæˆèƒ½é‡ï¼šæœ¨:28 ç«:33 åœŸ:25 é‡‘:20 æ°´:35
ç¤¾æœƒæ°£é‹ï¼š63
é›²å±¤è¦†è“‹ï¼š90% | é¢¨é€Ÿ 29.1 km/h
å¤©æ°£ç‹€æ³ï¼šé™°å¤©</textarea>
                <button class="btn btn-primary" id="btn-start" disabled>ç­‰å¾…åŒæ­¥å®Œæˆ...</button>
            </div>
        </section>

        <section id="p1" class="page"></section>
        <section id="p2" class="page">
            <div class="card">
                <div class="card-title">ğŸŒ€ äº”è¡Œèƒ½é‡åŠ›å ´</div>
                <div id="d3-canvas" style="width:100%; height:320px; background:#111; border-radius:10px;"></div>
            </div>
            <div id="energy-list"></div>
        </section>
        <section id="p3" class="page"></section>
        <section id="p4" class="page"></section>
    </div>
</div>

<script>
/**
 * G-4.5 æ ¸å¿ƒè¼‰å…¥æ¨¡çµ„ (Remote Only)
 */
let API_KEY = "";
const URL_API = "https://orlandotigereye.github.io/mytestweb/config/api.js";
const URL_CJK = "https://raw.githubusercontent.com/max32002/chinese_dictionary/0db111bb3dbe335a956732413557a710ef6901dc/Dictionary.json";
const URL_ASTRO = "https://raw.githubusercontent.com/orlandotigereye/Analy13/refs/heads/main/astrology_merged.json";

let DB_CJK = null, DB_ASTRO = null, FINAL_RESULT = null;

function updateDiag(id, per, txt, err = null) {
    const $e = $(`#diag-${id}`);
    $e.find('.diag-bar-inner').css('width', per + '%');
    $e.find('.diag-status').text(txt);
    if(err) $e.append(`<div style="color:red;font-size:10px;">${err}</div>`);
}

function decodeHex(hex) {
    let s = "";
    for (let i = 0; i < hex.length; i += 2) s += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
    return s;
}

async function initSystem() {
    try {
        updateDiag('api', 30, 'è§£æä¸­');
        const r = await fetch(URL_API);
        const t = await r.text();
        const m = t.match(/["']([a-fA-F0-9]+)["']/);
        if(m) { API_KEY = decodeHex(m[1]); updateDiag('api', 100, 'å®Œæˆ'); }
        
        updateDiag('cjk', 10, 'ä¸‹è¼‰ä¸­');
        updateDiag('astro', 10, 'ä¸‹è¼‰ä¸­');
        
        const [cjk, astro] = await Promise.all([
            fetch(URL_CJK).then(r => r.json()),
            fetch(URL_ASTRO).then(r => r.json())
        ]);
        
        DB_CJK = cjk; DB_ASTRO = astro;
        updateDiag('cjk', 100, 'å®Œæˆ');
        updateDiag('astro', 100, 'å®Œæˆ');
        $('#btn-start').prop('disabled', false).text('å•Ÿå‹•ç¯„æœ¬æ¼”ç®—');
    } catch(e) { showToast("è³‡æºåŒæ­¥å¤±æ•—"); }
}

$(document).ready(() => {
    initSystem();
    $('.tab').click(function() {
        const i = $(this).data('idx');
        $('.tab, .page').removeClass('active');
        $(this).addClass('active');
        $('.page').eq(i).addClass('active');
        if(i == 2 && FINAL_RESULT) setTimeout(renderD3, 50);
    });
    $('#btn-start').click(run);
});

function showToast(m) {
    const t = $(`<div class="toast">${m}</div>`);
    $('#msg-stage').append(t);
    setTimeout(() => t.fadeOut(400, () => t.remove()), 3000);
}

function getStrokes(txt) {
    let n = 0;
    const chars = txt.replace(/[^\u4e00-\u9fa5]/g, '');
    for (let c of chars) {
        const d = DB_CJK.find(x => x.word === c);
        n += d ? parseInt(d.stroke_count) : 8;
    }
    return n || 10;
}

async function run() {
    const raw = $('#main-in').val().trim();
    if(!API_KEY) return showToast("API Key éŒ¯èª¤");

    $('#loading-overlay').css('display', 'flex');
    const strokes = getStrokes(raw);

    const prompt = `åˆ†ææ­¤ç¯„æœ¬æ•¸æ“š: "${raw}"ã€‚ç­†åŠƒèƒ½é‡å€¼: ${strokes}ã€‚
    è«‹åŸºæ–¼æœˆç›¸ã€å®¿æ›œã€çŠ¯å®ˆèˆ‡äº”è¡Œåˆæˆèƒ½é‡ï¼Œå›è¦† JSONï¼š
    {
      "summary": "ä¸€å¥è©±æ–·èª",
      "analysis": [{"title": "é …", "content": "è¿°"}],
      "energy": {"wood": 0.2, "fire": 0.2, "earth": 0.2, "metal": 0.2, "water": 0.2},
      "visuals": [{"prompt": "AIç¹ªåœ–æè¿°", "desc": "æ„è±¡"}],
      "verdict": {"do": "å®œ", "avoid": "å¿Œ", "final": "çµè«–"}
    }`;

    try {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
        });
        const data = await res.json();
        FINAL_RESULT = JSON.parse(data.candidates[0].content.parts[0].text);
        
        renderOutput();
        showToast("åŒæ­¥æ¼”ç®—å®Œæˆ");
        $('.tab').eq(1).click();
    } catch (e) { showToast("æ¼”ç®—å¤±æ•—: " + e.message); }
    $('#loading-overlay').hide();
}

function renderOutput() {
    let h1 = `<div class="card"><div class="card-title">å¤©è±¡ç¸½è©•</div><p>${FINAL_RESULT.summary}</p></div>`;
    FINAL_RESULT.analysis.forEach(a => h1 += `<div class="card"><div class="card-title">${a.title}</div><p>${a.content}</p></div>`);
    $('#p1').html(h1);

    let h2 = `<div class="card"><table style="width:100%; font-size:0.36rem;">`;
    const names = {wood:"æœ¨", fire:"ç«", earth:"åœŸ", metal:"é‡‘", water:"æ°´"};
    Object.entries(FINAL_RESULT.energy).forEach(([k,v]) => h2 += `<tr><td>${names[k]}èƒ½é‡</td><td>${(v*100).toFixed(1)}%</td></tr>`);
    $('#energy-list').html(h2 + `</table></div>`);

    $('#p4').html(`
        <div class="card" style="background:var(--gold-grad); text-align:center; padding:20px;">
            <div style="font-size:0.5rem; font-weight:900;">ã€Œ${FINAL_RESULT.verdict.final}ã€</div>
        </div>
        <div class="card"><div class="card-title">è¡Œç‚ºæŒ‡å¼•</div>ğŸŸ¢ å®œ: ${FINAL_RESULT.verdict.do}<br>ğŸ”´ å¿Œ: ${FINAL_RESULT.verdict.avoid}</div>
    `);
    
    genImages();
}

async function genImages() {
    let h = "";
    for (let v of FINAL_RESULT.visuals) {
        try {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${API_KEY}`, {
                method: "POST",
                body: JSON.stringify({ instances: { prompt: v.prompt }, parameters: { sampleCount: 1 } })
            });
            const d = await r.json();
            h += `<div class="card"><div class="card-title">${v.desc}</div><div class="img-box"><img src="data:image/png;base64,${d.predictions[0].bytesBase64Encoded}"></div></div>`;
        } catch(e) {}
    }
    $('#p3').html(h);
}

function renderD3() {
    const box = d3.select("#d3-canvas");
    box.selectAll("*").remove();
    const w = $('#d3-canvas').width(), h = 320;
    const svg = box.append("svg").attr("width", w).attr("height", h);
    const colors = {wood:"#27ae60", fire:"#e74c3c", earth:"#f1c40f", metal:"#bdc3c7", water:"#3498db"};
    const nodes = Object.entries(FINAL_RESULT.energy).map(([k,v]) => ({
        id: k, label: ({wood:"æœ¨",fire:"ç«",earth:"åœŸ",metal:"é‡‘",water:"æ°´"})[k], r: 30+(v*75), color: colors[k]
    }));
    const sim = d3.forceSimulation(nodes).force("center", d3.forceCenter(w/2, h/2)).force("collide", d3.forceCollide().radius(d => d.r + 5));
    const g = svg.selectAll("g").data(nodes).enter().append("g");
    g.append("circle").attr("r", d => d.r).attr("fill", d => d.color).attr("stroke", "#D4AF37").style("opacity", 0.85);
    g.append("text").text(d => d.label).attr("text-anchor", "middle").attr("dy", ".3em").attr("fill", "#FFF").style("font-weight", "900");
    sim.on("tick", () => g.attr("transform", d => `translate(${d.x},${d.y})`));
}

function downloadCode() {
    const b = new Blob([document.documentElement.outerHTML], {type:'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(b);
    a.download = "G45_Template.html";
    a.click();
}
</script>
</body>
</html>

