<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Mobile QR Gun</title>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<style>
body{margin:0;background:#000;color:#fff;font-family:sans-serif;text-align:center;}
#reader{width:100vw;height:70vh;}
#status{padding:12px;background:#111;font-size:15px;}
.success{color:#00ff99;font-weight:bold;}
</style>
</head>
<body>

<div id="reader"></div>
<div id="status">åˆå§‹åŒ–ä¸­...</div>

<script>
// â— æ‰‹æ©Ÿæª¢æŸ¥
if(!/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){
    document.body.innerHTML="<h2 style='color:white'>è«‹ç”¨æ‰‹æ©Ÿé–‹å•Ÿ</h2>";
    throw new Error("Mobile only");
}

const statusBox=document.getElementById("status");
let lastScan="",scanningEnabled=true,currentTrack=null;

// ğŸ“³ éœ‡å‹•
function vibrateOK(){ navigator.vibrate && navigator.vibrate([70,40,120]); }
function vibrateReset(){ navigator.vibrate && navigator.vibrate(180); }

// ğŸ“‹ è¤‡è£½
async function copy(text){
    await navigator.clipboard.writeText(text);
}

// ğŸ”¦ æ‰‹é›»ç­’
async function torchOn(track){
    const cap=track.getCapabilities();
    if(cap.torch){
        await track.applyConstraints({advanced:[{torch:true}]});
    }
}

// ğŸ¯ æˆåŠŸæƒæ
function onScanSuccess(txt){
    if(!scanningEnabled || txt===lastScan) return;
    lastScan=txt;
    scanningEnabled=false;
    copy(txt);
    vibrateOK();
    statusBox.innerHTML="âœ… å·²è¤‡è£½: <span class='success'>"+txt+"</span>";
}

// ğŸš€ å•Ÿå‹•
async function start(){
    const html5QrCode=new Html5Qrcode("reader");
    const cams=await Html5Qrcode.getCameras();
    const back=cams.find(c=>c.label.toLowerCase().includes("back"))||cams[0];

    await html5QrCode.start(
        {deviceId:{exact:back.id}},
        {fps:20,qrbox:{width:280,height:280},
        experimentalFeatures:{useBarCodeDetectorIfSupported:true}},
        onScanSuccess,
        ()=>{}
    );

    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    currentTrack=stream.getVideoTracks()[0];
    setTimeout(()=>torchOn(currentTrack),1200);

    statusBox.innerText="å°æº– QR æƒæ";
}
start();


// ğŸ“± æ™ƒå‹•é‡ç½®
let lastX=0,lastY=0,lastZ=0,lastTime=0;
window.addEventListener("devicemotion",e=>{
    const acc=e.accelerationIncludingGravity;
    const now=Date.now();
    if(now-lastTime>120){
        const speed=Math.abs(acc.x+acc.y+acc.z-lastX-lastY-lastZ)/(now-lastTime)*10000;
        if(speed>35){
            scanningEnabled=true;
            lastScan="";
            statusBox.innerText="ğŸ“± å·²é‡ç½®ï¼Œç¹¼çºŒæƒæ";
            vibrateReset();
        }
        lastTime=now; lastX=acc.x; lastY=acc.y; lastZ=acc.z;
    }
});
</script>

</body>
</html>
